<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en">
<head>
<title>Literate org-trello</title>
<!-- 2014-12-01 Mon 23:44 -->
<meta  http-equiv="Content-Type" content="text/html;charset=utf-8" />
<meta  name="generator" content="Org-mode" />
<meta  name="author" content="Antoine R. Dumont" />
<meta  name="description" content="literate org-trello tryout"
 />
<style type="text/css">
 <!--/*--><![CDATA[/*><!--*/
  .title  { text-align: center; }
  .todo   { font-family: monospace; color: red; }
  .done   { color: green; }
  .tag    { background-color: #eee; font-family: monospace;
            padding: 2px; font-size: 80%; font-weight: normal; }
  .timestamp { color: #bebebe; }
  .timestamp-kwd { color: #5f9ea0; }
  .right  { margin-left: auto; margin-right: 0px;  text-align: right; }
  .left   { margin-left: 0px;  margin-right: auto; text-align: left; }
  .center { margin-left: auto; margin-right: auto; text-align: center; }
  .underline { text-decoration: underline; }
  #postamble p, #preamble p { font-size: 90%; margin: .2em; }
  p.verse { margin-left: 3%; }
  pre {
    border: 1px solid #ccc;
    box-shadow: 3px 3px 3px #eee;
    padding: 8pt;
    font-family: monospace;
    overflow: auto;
    margin: 1.2em;
  }
  pre.src {
    position: relative;
    overflow: visible;
    padding-top: 1.2em;
  }
  pre.src:before {
    display: none;
    position: absolute;
    background-color: white;
    top: -10px;
    right: 10px;
    padding: 3px;
    border: 1px solid black;
  }
  pre.src:hover:before { display: inline;}
  pre.src-sh:before    { content: 'sh'; }
  pre.src-bash:before  { content: 'sh'; }
  pre.src-emacs-lisp:before { content: 'Emacs Lisp'; }
  pre.src-R:before     { content: 'R'; }
  pre.src-perl:before  { content: 'Perl'; }
  pre.src-java:before  { content: 'Java'; }
  pre.src-sql:before   { content: 'SQL'; }

  table { border-collapse:collapse; }
  caption.t-above { caption-side: top; }
  caption.t-bottom { caption-side: bottom; }
  td, th { vertical-align:top;  }
  th.right  { text-align: center;  }
  th.left   { text-align: center;   }
  th.center { text-align: center; }
  td.right  { text-align: right;  }
  td.left   { text-align: left;   }
  td.center { text-align: center; }
  dt { font-weight: bold; }
  .footpara:nth-child(2) { display: inline; }
  .footpara { display: block; }
  .footdef  { margin-bottom: 1em; }
  .figure { padding: 1em; }
  .figure p { text-align: center; }
  .inlinetask {
    padding: 10px;
    border: 2px solid gray;
    margin: 10px;
    background: #ffffcc;
  }
  #org-div-home-and-up
   { text-align: right; font-size: 70%; white-space: nowrap; }
  textarea { overflow-x: auto; }
  .linenr { font-size: smaller }
  .code-highlighted { background-color: #ffff00; }
  .org-info-js_info-navigation { border-style: none; }
  #org-info-js_console-label
    { font-size: 10px; font-weight: bold; white-space: nowrap; }
  .org-info-js_search-highlight
    { background-color: #ffff00; color: #000000; font-weight: bold; }
  /*]]>*/-->
</style>
<link rel="stylesheet" href="../other/style.css" type="text/css"/>
<script type="text/javascript">
/*
@licstart  The following is the entire license notice for the
JavaScript code in this tag.

Copyright (C) 2012-2013 Free Software Foundation, Inc.

The JavaScript code in this tag is free software: you can
redistribute it and/or modify it under the terms of the GNU
General Public License (GNU GPL) as published by the Free Software
Foundation, either version 3 of the License, or (at your option)
any later version.  The code is distributed WITHOUT ANY WARRANTY;
without even the implied warranty of MERCHANTABILITY or FITNESS
FOR A PARTICULAR PURPOSE.  See the GNU GPL for more details.

As additional permission under GNU GPL version 3 section 7, you
may distribute non-source (e.g., minimized or compacted) forms of
that code without the copy of the GNU GPL normally required by
section 4, provided you include this license notice and a URL
through which recipients can access the Corresponding Source.


@licend  The above is the entire license notice
for the JavaScript code in this tag.
*/
<!--/*--><![CDATA[/*><!--*/
 function CodeHighlightOn(elem, id)
 {
   var target = document.getElementById(id);
   if(null != target) {
     elem.cacheClassElem = elem.className;
     elem.cacheClassTarget = target.className;
     target.className = "code-highlighted";
     elem.className   = "code-highlighted";
   }
 }
 function CodeHighlightOff(elem, id)
 {
   var target = document.getElementById(id);
   if(elem.cacheClassElem)
     elem.className = elem.cacheClassElem;
   if(elem.cacheClassTarget)
     target.className = elem.cacheClassTarget;
 }
/*]]>*///-->
</script>
</head>
<body>
<div id="content">
<h1 class="title">Literate org-trello</h1>
<div id="table-of-contents">
<h2>Table of Contents</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="#sec-1">Howto</a></li>
<li><a href="#sec-2">Description</a></li>
<li><a href="#sec-3">License</a></li>
<li><a href="#sec-4">Manual</a></li>
<li><a href="#sec-5">Code</a>
<ul>
<li><a href="#sec-5-1">Setup</a>
<ul>
<li><a href="#sec-5-1-1">Library dependencies</a></li>
<li><a href="#sec-5-1-2">Personal setup</a></li>
</ul>
</li>
<li><a href="#sec-5-2">Namespace</a></li>
<li><a href="#sec-5-3">org-trello</a>
<ul>
<li><a href="#sec-5-3-1">Minor mode</a></li>
<li><a href="#sec-5-3-2">Help</a></li>
<li><a href="#sec-5-3-3">Install the consumer-key and the read/write access token</a></li>
<li><a href="#sec-5-3-4">Decorator/Controller</a></li>
<li><a href="#sec-5-3-5">Setup trello</a></li>
<li><a href="#sec-5-3-6">Check the installation</a></li>
<li><a href="#sec-5-3-7">Sync a simple entity</a></li>
<li><a href="#sec-5-3-8">Sync a complex entity</a></li>
<li><a href="#sec-5-3-9">Synchronize the org-mode buffer to trello</a></li>
<li><a href="#sec-5-3-10">Synchronize the org-mode buffer from trello</a></li>
<li><a href="#sec-5-3-11">Kill/Remove/Delete an entity</a></li>
<li><a href="#sec-5-3-12">Providing</a></li>
</ul>
</li>
<li><a href="#sec-5-4">orgtrello</a>
<ul>
<li><a href="#sec-5-4-1">Namespace setup</a></li>
<li><a href="#sec-5-4-2">Control/setup routines</a></li>
<li><a href="#sec-5-4-3">Abstraction access routines</a></li>
<li><a href="#sec-5-4-4">Create simple entity</a></li>
<li><a href="#sec-5-4-5">Create complex entity</a></li>
<li><a href="#sec-5-4-6">Synchronize full org buffer to trello</a></li>
<li><a href="#sec-5-4-7">Synchronize full org buffer from trello</a></li>
<li><a href="#sec-5-4-8">Delete entity</a></li>
<li><a href="#sec-5-4-9">Install key and token configuration</a></li>
<li><a href="#sec-5-4-10">Install board and lists configuration</a></li>
<li><a href="#sec-5-4-11">Create board</a></li>
<li><a href="#sec-5-4-12">Utility function</a></li>
</ul>
</li>
<li><a href="#sec-5-5">orgtrello-query</a>
<ul>
<li><a href="#sec-5-5-1">Namespace Setup</a></li>
<li><a href="#sec-5-5-2">orgtrello-query/&#x2013;make-dispatch-http-query</a></li>
<li><a href="#sec-5-5-3">orgtrello-query/http</a></li>
<li><a href="#sec-5-5-4">orgtrello-query/&#x2013;map-dispatch-http-verb</a></li>
<li><a href="#sec-5-5-5">orgtrello-query/&#x2013;compute-method</a></li>
<li><a href="#sec-5-5-6">orgtrello-query/&#x2013;compute-url</a></li>
<li><a href="#sec-5-5-7">Input request abstraction extract functions</a></li>
<li><a href="#sec-5-5-8">Output request abstraction extract function</a></li>
<li><a href="#sec-5-5-9">HTTP request functions</a></li>
<li><a href="#sec-5-5-10">HTTP callbacks</a></li>
</ul>
</li>
<li><a href="#sec-5-6">orgtrello-api</a>
<ul>
<li><a href="#sec-5-6-1">orgtrello-api/add-board</a></li>
<li><a href="#sec-5-6-2">orgtrello-api/get-boards</a></li>
<li><a href="#sec-5-6-3">orgtrello-api/get-board</a></li>
<li><a href="#sec-5-6-4">orgtrello-api/get-cards</a></li>
<li><a href="#sec-5-6-5">orgtrello-api/get-card</a></li>
<li><a href="#sec-5-6-6">orgtrello-api/delete-card</a></li>
<li><a href="#sec-5-6-7">orgtrello-api/get-lists</a></li>
<li><a href="#sec-5-6-8">orgtrello-api/close-list</a></li>
<li><a href="#sec-5-6-9">orgtrello-api/get-list</a></li>
<li><a href="#sec-5-6-10">orgtrello-api/add-list</a></li>
<li><a href="#sec-5-6-11">orgtrello-api/add-card</a></li>
<li><a href="#sec-5-6-12">orgtrello-api/get-cards-from-list</a></li>
<li><a href="#sec-5-6-13">orgtrello-api/move-card</a></li>
<li><a href="#sec-5-6-14">orgtrello-api/add-checklist</a></li>
<li><a href="#sec-5-6-15">orgtrello-api/update-checklist</a></li>
<li><a href="#sec-5-6-16">orgtrello-api/get-checklists</a></li>
<li><a href="#sec-5-6-17">orgtrello-api/get-checklist</a></li>
<li><a href="#sec-5-6-18">orgtrello-api/delete-checklist</a></li>
<li><a href="#sec-5-6-19">orgtrello-api/add-tasks</a></li>
<li><a href="#sec-5-6-20">orgtrello-api/update-task</a></li>
<li><a href="#sec-5-6-21">orgtrello-api/get-tasks</a></li>
<li><a href="#sec-5-6-22">orgtrello-api/delete-task</a></li>
</ul>
</li>
<li><a href="#sec-5-7">orgtrello-data</a>
<ul>
<li><a href="#sec-5-7-1">orgtrello-data/&#x2013;convert-orgmode-date-to-trello-date</a></li>
<li><a href="#sec-5-7-2">orgtrello-data/metadata</a></li>
<li><a href="#sec-5-7-3">orgtrello-data/&#x2013;parent-metadata</a></li>
<li><a href="#sec-5-7-4">orgtrello-data/&#x2013;grandparent-metadata</a></li>
<li><a href="#sec-5-7-5">orgtrello-data/entry-get-full-metadata</a></li>
<li><a href="#sec-5-7-6">orgtrello-data/&#x2013;get-metadata</a></li>
</ul>
</li>
<li><a href="#sec-5-8">orgtrello-hash</a>
<ul>
<li><a href="#sec-5-8-1">orgtrello-hash/make-hash-org</a></li>
<li><a href="#sec-5-8-2">orgtrello-hash/make-hash</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#sec-6">Resulting</a></li>
<li><a href="#sec-7">Source</a></li>
</ul>
</div>
</div>
<p>
To help improving the maintenance of <a href="http://ardumont.github.io/org-trello/">org-trello</a>, we will describe it using <a href="https://en.wikipedia.org/wiki/Literate_programming">literate programming</a>.
For this, we will use <a href="http://orgmode.org/">org-mode</a> and <a href="http://orgmode.org/worg/org-contrib/babel/intro.html">babel</a>.
</p>

<p>
We'll begin by:
</p>
<ul class="org-ul">
<li>a simple how to
</li>
<li>a little description
</li>
<li>the license
</li>
<li>a manual
</li>
<li>a full description step-by-step of the code (may need to find another organisation that the code order)
</li>
</ul>

<div id="outline-container-sec-1" class="outline-2">
<h2 id="sec-1">Howto</h2>
<div class="outline-text-2" id="text-1">
<ul class="org-ul">
<li>Open this file
</li>
<li>Tangle (extract) the code
</li>
</ul>

<p>
<i>M-x org-babel-tangle</i> or <i>C-c C-v t</i>
</p>

<p>
Or
</p>

<p>
``` sh
make tangle
```
</p>
</div>
</div>

<div id="outline-container-sec-2" class="outline-2">
<h2 id="sec-2">Description</h2>
<div class="outline-text-2" id="text-2">
<p>
org-trello is an emacs's org minor mode to permit the 2-way synchonization between org buffer and a trello board.
The headers needs to start with ;;; as a prerequisite for packaging.
This is an important step where we describe the different information about the project:
</p>
<ul class="org-ul">
<li>principal author
</li>
<li>maintainer
</li>
<li>current version
</li>
<li>dependencies
</li>
</ul>

<div class="org-src-container">

<pre class="src src-lisp" id="headers-description">;;; org-trello.el --- Org minor mode to synchronize with trello

;; Copyright (C) 2013 Antoine R. Dumont &lt;eniotna.t AT gmail.com&gt;

;; Author: Antoine R. Dumont &lt;eniotna.t AT gmail.com&gt;
;; Maintainer: Antoine R. Dumont &lt;eniotna.t AT gmail.com&gt;
;; Version: 0.1.1
;; Package-Requires: ((org "8.0.7") (dash "1.5.0") (request "0.2.0") (cl-lib "0.3.0") (json "1.2"))
;; Keywords: org-mode trello sync org-trello
;; URL: https://github.com/org-trello/org-trello
</pre>
</div>
</div>
</div>

<div id="outline-container-sec-3" class="outline-2">
<h2 id="sec-3">License</h2>
<div class="outline-text-2" id="text-3">
<p>
First, org-trello is a free software under the GPL v3.
</p>

<div class="org-src-container">

<pre class="src src-lisp" id="headers-license">;; This file is NOT part of GNU Emacs.

;; This program is free software; you can redistribute it and/or modify
;; it under the terms of the GNU General Public License as published by
;; the Free Software Foundation; either version 3, or (at your option)
;; any later version.
;;
;; This program is distributed in the hope that it will be useful,
;; but WITHOUT ANY WARRANTY; without even the implied warranty of
;; MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the
;; GNU General Public License for more details.
;;
;; You should have received a copy of the GNU General Public License
;; along with GNU Emacs; see the file COPYING. If not, write to the
;; Free Software Foundation, Inc., 51 Franklin Street, Fifth Floor,
;; Boston, MA 02110-1301, USA.
</pre>
</div>
</div>
</div>

<div id="outline-container-sec-4" class="outline-2">
<h2 id="sec-4">Manual</h2>
<div class="outline-text-2" id="text-4">
<p>
A fast setup that we, end-users, can see from the package installation procedure.
</p>

<div class="org-src-container">

<pre class="src src-lisp" id="headers-manual">;;; Commentary:

;; Minor mode for org-mode to sync org-mode and trello
;;
;; 1) Add the following to your emacs init file
;; (require 'org-trello)
;;
;; Automatically
;; 2) Once - Install the consumer-key and the read-write token for org-trello to be able to work in your name with your trello boards (C-c o i)
;; M-x org-trello/install-key-and-token
;;
;; 3) Once per org-mode file/board you want to connect to (C-c o I)
;; M-x org-trello/install-board-and-lists-ids
;;
;; *Beware* you must setup your trello board with the name you use as keywords (TODO, DONE e.g) on your org-mode file.
;;
;; 4) You can also create a board directly from a org-mode buffer (C-c o b)
;; M-x org-trello/create-board
;;
</pre>
</div>
</div>
</div>
<div id="outline-container-sec-5" class="outline-2">
<h2 id="sec-5">Code</h2>
<div class="outline-text-2" id="text-5">
</div><div id="outline-container-sec-5-1" class="outline-3">
<h3 id="sec-5-1">Setup</h3>
<div class="outline-text-3" id="text-5-1">
<p>
First, we will begin simply by showing the dependencies.
Then the personal setup that the user can override.
</p>
</div>

<div id="outline-container-sec-5-1-1" class="outline-4">
<h4 id="sec-5-1-1">Library dependencies</h4>
<div class="outline-text-4" id="text-5-1-1">
<p>
We depend on:
</p>

<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="left" />

<col  class="left" />
</colgroup>
<thead>
<tr>
<th scope="col" class="left">lib</th>
<th scope="col" class="left">description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="left">org</td>
<td class="left">As org-trello is a org minor mode</td>
</tr>

<tr>
<td class="left">json</td>
<td class="left">The transit of data to trello's api is in json</td>
</tr>

<tr>
<td class="left">dash</td>
<td class="left">To provide some specific lisp constructs</td>
</tr>

<tr>
<td class="left">request</td>
<td class="left">Awesome http client</td>
</tr>

<tr>
<td class="left">cl-lib</td>
<td class="left">To provide some common-lisp functions</td>
</tr>

<tr>
<td class="left">parse-time</td>
<td class="left">Some date time manipulation</td>
</tr>
</tbody>
</table>

<div class="org-src-container">

<pre class="src src-lisp" id="org-trello-lib-deps">;;; Code:

(require 'org)
(require 'json)
(require 'dash)
(require 'request)
(eval-when-compile (require 'cl-lib))
(require 'parse-time)
</pre>
</div>
</div>
</div>

<div id="outline-container-sec-5-1-2" class="outline-4">
<h4 id="sec-5-1-2">Personal setup</h4>
<div class="outline-text-4" id="text-5-1-2">
<p>
At the moment, we have only one possible setup.
This is relative to the checklist behaviour.
By default, the status of the checklist overrides the item's status.
</p>

<div class="org-src-container">

<pre class="src src-lisp" id="setup-org-trello">

;; #################### overriding setup

(defvar *ORGTRELLO-CHECKLIST-UPDATE-ITEMS* t
  "A variable to permit the checklist's status to be pass along to its items. t, if checklist's status is DONE, the items are updated to DONE (org-mode buffer and trello board), nil only the items's status is used.
  To deactivate such behavior, update in your init.el:
  (require 'org-trello)
  (setq *ORGTRELLO-CHECKLIST-UPDATE-ITEMS* nil)")
</pre>
</div>

<p>
If the user does not want this, he/she can modify his/her setup in his/her emacs startup file:
</p>

<div class="org-src-container">

<pre class="src src-lisp">(setq *ORGTRELLO-CHECKLIST-UPDATE-ITEMS* nil)
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-sec-5-2" class="outline-3">
<h3 id="sec-5-2">Namespace</h3>
<div class="outline-text-3" id="text-5-2">
<p>
As each emacs developer knows, there is no real namespace in emacs-lisp.
But, we like to separate function depending on perimeters, so we tried to keep the code as much separated as we can.
</p>

<p>
At the moment, we sliced the code into 6 namespaces:
</p>

<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="left" />

<col  class="left" />
</colgroup>
<thead>
<tr>
<th scope="col" class="left">name</th>
<th scope="col" class="left">description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="left">org-trello</td>
<td class="left">Main namespace which describe the minor mode, in charge of controls before executing anything</td>
</tr>

<tr>
<td class="left">orgtrello</td>
<td class="left">Primitive routines that executes the code without checks</td>
</tr>

<tr>
<td class="left">orgtrello-query</td>
<td class="left">Interface to the http request</td>
</tr>

<tr>
<td class="left">orgtrello-api</td>
<td class="left">Interface to the trello api</td>
</tr>

<tr>
<td class="left">orgtrello-data</td>
<td class="left">Interface to the org data</td>
</tr>

<tr>
<td class="left">orgtrello-hash</td>
<td class="left">Utility interface to simplify the construction of data</td>
</tr>
</tbody>
</table>
</div>
</div>

<div id="outline-container-sec-5-3" class="outline-3">
<h3 id="sec-5-3">org-trello</h3>
<div class="outline-text-3" id="text-5-3">
<p>
This is the main entry namespace of org-trello.
Starting with the minor mode definition, we will show each higher interactive command after this.
</p>
</div>

<div id="outline-container-sec-5-3-1" class="outline-4">
<h4 id="sec-5-3-1">Minor mode</h4>
<div class="outline-text-4" id="text-5-3-1">
<p>
As we said in the <i>description</i> step, <a href="http://ardumont.github.io/org-trello/">org-trello</a> is a <a href="https://www.gnu.org/software/emacs/manual/html_node/emacs/Minor-Modes.html">minor mode</a>.
</p>
</div>

<ul class="org-ul"><li><a id="sec-5-3-1-1" name="sec-5-3-1-1"></a>Description<br  /><div class="outline-text-5" id="text-5-3-1-1">
<p>
Simply put, we offer a simple interface to the user through a map.
We declare the minor mode to have 'ot' as the emacs modeline name.
And we propose default bindings for the user to access the org-trello routine.
</p>

<div class="org-src-container">

<pre class="src src-lisp" id="org-trello-minor-mode">;;;###autoload
(define-minor-mode org-trello-mode "Sync your org-mode and your trello together."
  :lighter " ot" ;; the name on the modeline
  :keymap  (let ((map (make-sparse-keymap)))
	     ;; binding will change
	     (define-key map (kbd "C-c o i") 'org-trello/install-key-and-token)
	     (define-key map (kbd "C-c o I") 'org-trello/install-board-and-lists-ids)
	     (define-key map (kbd "C-c o b") 'org-trello/create-board)
	     (define-key map (kbd "C-c o c") 'org-trello/create-simple-entity)
	     (define-key map (kbd "C-c o C") 'org-trello/create-complex-entity)
	     (define-key map (kbd "C-c o s") 'org-trello/sync-to-trello)
	     (define-key map (kbd "C-c o S") 'org-trello/sync-from-trello)
	     (define-key map (kbd "C-c o k") 'org-trello/kill-entity)
	     (define-key map (kbd "C-c o h") 'org-trello/help-describing-bindings)
	     (define-key map (kbd "C-c o d") 'org-trello/check-setup)
	     ;; define other bindings...
	     map)
  :after-hook (message "ot is on! To begin with, hit C-c o h or M-x 'org-trello/help-describing-bindings"))

(add-hook 'org-mode-hook 'org-trello-mode)

(message "org-trello loaded!")
</pre>
</div>
</div>
</li>

<li><a id="sec-5-3-1-2" name="sec-5-3-1-2"></a>Override<br  /><div class="outline-text-5" id="text-5-3-1-2">
<p>
If the user is not satisfied with the default bindings, he/she can always override in his/her own setup files.
I kept the default one but the idea is to replace those bindings by the one you want.
</p>

<div class="org-src-container">

<pre class="src src-lisp">(define-key org-trello-mode-map (kbd "C-c o i") 'org-trello/install-key-and-token)
(define-key org-trello-mode-map (kbd "C-c o I") 'org-trello/install-board-and-lists-ids)
(define-key org-trello-mode-map (kbd "C-c o b") 'org-trello/create-board)
(define-key org-trello-mode-map (kbd "C-c o c") 'org-trello/create-simple-entity)
(define-key org-trello-mode-map (kbd "C-c o C") 'org-trello/create-complex-entity)
(define-key org-trello-mode-map (kbd "C-c o s") 'org-trello/sync-to-trello)
(define-key org-trello-mode-map (kbd "C-c o S") 'org-trello/sync-from-trello)
(define-key org-trello-mode-map (kbd "C-c o k") 'org-trello/kill-entity)
(define-key org-trello-mode-map (kbd "C-c o h") 'org-trello/help-describing-bindings)
(define-key org-trello-mode-map (kbd "C-c o d") 'org-trello/check-setup)
</pre>
</div>
</div>
</li></ul>
</div>
<div id="outline-container-sec-5-3-2" class="outline-4">
<h4 id="sec-5-3-2">Help</h4>
<div class="outline-text-4" id="text-5-3-2">
<p>
Let's begin simple, we offer an interactive command to display the current possible bindings.
Hitting <i>C-c o h</i>, this will display a simple message on the minibuffer.
</p>

<div class="org-src-container">

<pre class="src src-lisp" id="help-describe">(defun org-trello/help-describing-bindings ()
  "A simple message to describe the standard bindings used."
  (interactive)
  (message
"C-c o i - M-x org-trello/install-key-and-token       - Install the keys and the access-token.
C-c o I - M-x org-trello/install-board-and-lists-ids - Select the board and attach the todo, doing and done list.
C-c o b - M-x org-trello/create-board                - Create interactively a board and attach the org-mode file to this trello board.
C-c o c - M-x org-trello/create-simple-entity        - Create/Update an entity (card/checklist/item) depending on its level and status. Do not deal with level superior to 4.
C-c o C - M-x org-trello/create-complex-entity       - Create/Update a complete entity card/checklist/item and its subtree (depending on its level).
C-c o s - M-x org-trello/sync-to-trello              - Synchronize the org-mode file to the trello board (org-mode -&gt; trello).
C-c o S - M-x org-trello/sync-from-trello            - Synchronize the org-mode file from the trello board (trello -&gt; org-mode).
C-c o k - M-x org-trello/kill-entity                 - Kill the entity (and its arborescence tree).
C-c o d - M-x org-trello/check-setup                 - Simple routine to check that the setup is ok. If everything is ok, will simply display 'Setup ok!'
C-c o h - M-x org-trello/help-describing-bindings    - This help message."))
</pre>
</div>
</div>
</div>

<div id="outline-container-sec-5-3-3" class="outline-4">
<h4 id="sec-5-3-3">Install the consumer-key and the read/write access token</h4>
<div class="outline-text-4" id="text-5-3-3">
<p>
One of the first interaction we must have with org-trello is the setup.
For this, we declare an interactive command.
We delegate the code to the function <code>org-trello/--msg-deco-control-and-do</code>.
This will:
</p>
<ul class="org-ul">
<li>log the actions "Setup key and token" in the mini-buffer.
</li>
<li>execute no control as none is needed (thus the nil as second parameter)
</li>
<li>as there are no control, directly execute the 'org-trello/do-install-key-and-token.
</li>
<li>as there is writing involve, we ask to save the buffer at the end (t)
</li>
</ul>

<div class="org-src-container">

<pre class="src src-lisp" id="install-key-and-token">(defun org-trello/install-key-and-token ()
  "No control, trigger the setup installation of the key and the read/write token."
  (interactive)
  (org-trello/--msg-deco-control-and-do "Setup key and token" nil 'orgtrello/do-install-key-and-token t))
</pre>
</div>
</div>
</div>

<div id="outline-container-sec-5-3-4" class="outline-4">
<h4 id="sec-5-3-4">Decorator/Controller</h4>
<div class="outline-text-4" id="text-5-3-4">
<p>
As we've seen before, we have a higher-order function <code>org-trello/--msg-deco-control-and-do</code> which is in charge of:
</p>
<ul class="org-ul">
<li>displaying the message <code>msg</code> in the mini-buffer
</li>
<li>ask for the <code>org-trello/--control-and-do</code> function to execute
</li>
<li>displaying the result string from the call of the previous function if there is some
</li>
<li>optionally, we can ask for saving the buffer through the flag <code>save-buffer-p</code>
</li>
</ul>

<div class="org-src-container">

<pre class="src src-lisp" id="msg-decorator-and-control">

;; #################### org-trello

(defun org-trello/--msg-deco-control-and-do (msg control-fns fn-to-control-and-execute &amp;optional save-buffer-p)
  "A simple decorator function to display message in mini-buffer before and after the execution of the control"
  (message (concat msg "..."))
  (let ((org-trello/--result-action (org-trello/--control-and-do control-fns fn-to-control-and-execute)))
    ;; do we have to save the buffer
    (if save-buffer-p
	(progn
	  (save-buffer)
	  (org-mode-restart)))
    (if (string-or-null-p org-trello/--result-action)
      (message org-trello/--result-action)
      (message (concat msg " - done!")))))
</pre>
</div>

<p>
This is the main function which is in charge:
</p>
<ul class="org-ul">
<li>executing a list of controls <code>control-fns</code>
</li>
<li>if there is no control or the controls are ok, execute the function <code>fn-to-control-and-execute</code>
</li>
<li>returns the resulting string from the execution of the function
</li>
</ul>

<div class="org-src-container">

<pre class="src src-lisp" id="control-and-execute">(defun org-trello/--control-and-do (control-fns fn-to-control-and-execute)
  "Execute the function fn if control-fns is nil or if the result of apply every function to fn is ok."
  (if control-fns
      (let* ((org-trello/--error-messages (--filter (not (equal :ok (funcall it))) control-fns)))
	(if org-trello/--error-messages
	    ;; there are some trouble, we display all the error messages to help the user understand the problem
	    (message "List of errors:\n %s" (--mapcat (concat "- " it "\n") org-trello/--error-messages))
	  ;; ok execute the function as the controls are ok
	  (funcall fn-to-control-and-execute)))
    ;; no control, we simply execute the function
    (funcall fn-to-control-and-execute)))
</pre>
</div>
</div>
</div>

<div id="outline-container-sec-5-3-5" class="outline-4">
<h4 id="sec-5-3-5">Setup trello</h4>
<div class="outline-text-4" id="text-5-3-5">
<p>
To use trello, we need to either install a trello board or create one.
In either case, this will do some action and update the org-mode buffer with some needed metadata:
</p>
<ul class="org-ul">
<li>board-id
</li>
<li>board-name (for the user to see which board he/she uses)
</li>
<li>every keyword (org) / list id (trello)
</li>
</ul>
</div>

<ul class="org-ul"><li><a id="sec-5-3-5-1" name="sec-5-3-5-1"></a>Install the board<br  /><div class="outline-text-5" id="text-5-3-5-1">
<p>
To install a trello board, we need:
</p>
<ul class="org-ul">
<li>to display a message on the minibuffer "Install boards and lists"
</li>
<li>execute the loading of the setup via <code>setup-properties</code> function (no control but a setup)
</li>
<li>execute the control of the key and access-token are ok
</li>
<li>if everything is ok, do install the board and lists on the trello buffer
</li>
<li>as some update of the org-mode buffer is done, we ask for the buffer to be saved
</li>
</ul>

<div class="org-src-container">

<pre class="src src-lisp" id="install-board">(defun org-trello/install-board-and-lists-ids ()
  "Control first, then if ok, trigger the setup installation of the trello board to sync with."
  (interactive)
  (org-trello/--msg-deco-control-and-do
     "Install boards and lists"
     '(orgtrello/--setup-properties orgtrello/--control-keys)
     'orgtrello/do-install-board-and-lists
     t))
</pre>
</div>
</div>
</li>

<li><a id="sec-5-3-5-2" name="sec-5-3-5-2"></a>Create a board<br  /><div class="outline-text-5" id="text-5-3-5-2">
<p>
To create a trello board from scratch, we need:
</p>
<ul class="org-ul">
<li>to display a message on the minibuffer "Create boards and lists"
</li>
<li>execute the loading of the setup via <code>setup-properties</code> function (no control but a setup)
</li>
<li>execute the control of the key and access-token are ok
</li>
<li>if everything is ok, do create the board and lists on the trello buffer
</li>
<li>as some update of the org-mode buffer is done, we ask for the buffer to be saved
</li>
</ul>

<div class="org-src-container">

<pre class="src src-lisp" id="create-board">(defun org-trello/create-board ()
  "Control first, then if ok, trigger the board creation."
  (interactive)
  (org-trello/--msg-deco-control-and-do
     "Create board and lists"
     '(orgtrello/--setup-properties orgtrello/--control-keys)
     'orgtrello/do-create-board-and-lists
     t))
</pre>
</div>
</div>
</li></ul>
</div>

<div id="outline-container-sec-5-3-6" class="outline-4">
<h4 id="sec-5-3-6">Check the installation</h4>
<div class="outline-text-4" id="text-5-3-6">
<p>
Now that we setuped the org buffer to work with a trello board, we can ensure that the setup is ok.
For this, we simply call the <code>org-trello/--control-and-do</code> routine with:
</p>
<ul class="org-ul">
<li><code>orgtrello/--setup-properties</code> which will load the metadata from the file
</li>
<li><code>orgtrello/--control-keys</code> to ensure the key and access token are loaded
</li>
<li><code>orgtrello/--control-properties</code> to ensure the properties are properly setuped
</li>
</ul>
<p>
If any of those are badly setuped, a message will explicit the problem.
Otherwise, a simple message "Setup ok!" will be displayed on the minibuffer.
</p>

<div class="org-src-container">

<pre class="src src-lisp" id="check-installation">(defun org-trello/check-setup ()
  "Check the current setup."
  (interactive)
  (org-trello/--control-and-do
     '(orgtrello/--setup-properties orgtrello/--control-keys orgtrello/--control-properties orgtrello/--control-encoding)
     (lambda () (message "Setup ok!"))))
</pre>
</div>
</div>
</div>

<div id="outline-container-sec-5-3-7" class="outline-4">
<h4 id="sec-5-3-7">Sync a simple entity</h4>
<div class="outline-text-4" id="text-5-3-7">
<p>
To create/synchronize a simple entity (without its arborescence), we need to ensure some standard controls are ok.
Then we can call the primitive routine <code>orgtrello/do-create-simple-entity</code> to do the actual creation.
At last, saving the buffer as the creation involves some buffer updates (with the trello id).
</p>

<div class="org-src-container">

<pre class="src src-lisp" id="create-simple-entity">(defun org-trello/create-simple-entity ()
  "Control first, then if ok, create a simple entity."
  (interactive)
  (org-trello/--msg-deco-control-and-do
     "Synchronizing entity"
     '(orgtrello/--setup-properties orgtrello/--control-keys orgtrello/--control-properties orgtrello/--control-encoding)
     (lambda () (orgtrello/do-create-simple-entity t))
     t))
</pre>
</div>
</div>
</div>

<div id="outline-container-sec-5-3-8" class="outline-4">
<h4 id="sec-5-3-8">Sync a complex entity</h4>
<div class="outline-text-4" id="text-5-3-8">
<p>
To create/synchronize a complex entity (with its arborescence), we need to ensure some standard controls are ok.
Then we can call the primitive routine <code>orgtrello/do-create-complex-entity</code> to do the actual creation.
At last, saving the buffer as the creation involves some buffer updates.
</p>

<div class="org-src-container">

<pre class="src src-lisp" id="create-complex-entity">(defun org-trello/create-complex-entity ()
  "Control first, then if ok, create an entity and all its arborescence if need be."
  (interactive)
  (org-trello/--msg-deco-control-and-do
     "Synchronizing complex entity"
     '(orgtrello/--setup-properties orgtrello/--control-keys orgtrello/--control-properties orgtrello/--control-encoding)
     'orgtrello/do-create-complex-entity
     t))
</pre>
</div>
</div>
</div>

<div id="outline-container-sec-5-3-9" class="outline-4">
<h4 id="sec-5-3-9">Synchronize the org-mode buffer to trello</h4>
<div class="outline-text-4" id="text-5-3-9">
<p>
Now that we have the basic brick (synchronize simple/complex entity), we can use this to synchronize the all buffer to trello.
But first, we need to ensure some standard controls are ok.
Then calling the primitive routine <code>orgtrello/do-sync-full-file</code> which does the actual syncing.
At last, we save the buffer as the buffer has been updated.
</p>

<div class="org-src-container">

<pre class="src src-lisp" id="sync-org-to-trello">(defun org-trello/sync-to-trello ()
  "Control first, then if ok, sync the org-mode file completely to trello."
  (interactive)
  (org-trello/--msg-deco-control-and-do
     "Synchronizing org-mode file to trello"
     '(orgtrello/--setup-properties orgtrello/--control-keys orgtrello/--control-properties orgtrello/--control-encoding)
     'orgtrello/do-sync-full-file
     t))
</pre>
</div>
</div>
</div>

<div id="outline-container-sec-5-3-10" class="outline-4">
<h4 id="sec-5-3-10">Synchronize the org-mode buffer from trello</h4>
<div class="outline-text-4" id="text-5-3-10">
<p>
The other way around is also possible.
You know the drill by now, we must ensure we have the standard control that pass.
Then calling the routine <code>orgtrello/do-sync-full-from-trello</code> which really does the action.
Then saving the buffer as the action involved some buffer updates.
</p>

<div class="org-src-container">

<pre class="src src-lisp" id="sync-org-from-trello">(defun org-trello/sync-from-trello ()
  "Control first, then if ok, sync the org-mode file from the trello board."
  (interactive)
  (org-trello/--msg-deco-control-and-do
     "Synchronizing trello board to org-mode file"
     '(orgtrello/--setup-properties orgtrello/--control-keys orgtrello/--control-properties orgtrello/--control-encoding)
     'orgtrello/do-sync-full-from-trello
     t))
</pre>
</div>
</div>
</div>

<div id="outline-container-sec-5-3-11" class="outline-4">
<h4 id="sec-5-3-11">Kill/Remove/Delete an entity</h4>
<div class="outline-text-4" id="text-5-3-11">
<p>
As we can create entity on trello, we can also remove them (from trello and the current org buffer).
As usual, we ensure standard controls are ok.
Then calling the subroutine <code>orgtrello/do-delete-simple</code> which does the action.
Then saving the buffer as the action involved some buffer updates.
</p>

<div class="org-src-container">

<pre class="src src-lisp" id="kill-entity">(defun org-trello/kill-entity ()
  "Control first, then if ok, delete the entity and all its arborescence."
  (interactive)
  (org-trello/--msg-deco-control-and-do
     "Delete entity"
     '(orgtrello/--setup-properties orgtrello/--control-keys orgtrello/--control-properties orgtrello/--control-encoding)
     (lambda () (orgtrello/do-delete-simple t))
     t))
</pre>
</div>
</div>
</div>

<div id="outline-container-sec-5-3-12" class="outline-4">
<h4 id="sec-5-3-12">Providing</h4>
<div class="outline-text-4" id="text-5-3-12">
<p>
Now that we defined all of our code, we need to provide the library we created.
Simplify using emacs's primitive <i>provide</i>.
</p>

<div class="org-src-container">

<pre class="src src-lisp" id="org-trello-provide">(provide 'org-trello)

;;; org-trello.el ends here
</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-sec-5-4" class="outline-3">
<h3 id="sec-5-4">orgtrello</h3>
<div class="outline-text-3" id="text-5-4">
<p>
This is the namespace in charge of the primitive functions that actually trigger the action. Those functions reflect the same action as we define earlier but without any controls first.
They are not to be called directly from the user.
</p>
</div>

<div id="outline-container-sec-5-4-1" class="outline-4">
<h4 id="sec-5-4-1">Namespace setup</h4>
<div class="outline-text-4" id="text-5-4-1">
<p>
First, we'll begin by some setup variables that are actually used throughout the namespace:
</p>
<ul class="org-ul">
<li><b>TODO</b> representation of org's "TODO" keyword
</li>
<li><b>DONE</b> representation of org's "DONE" keyword
</li>
<li><b>BOARD-ID</b> will be the trello board's identifier for org-trello to know which board to use
</li>
<li><b>BOARD-NAME</b> will be the trello board's name for the user to know to which board he/she works with
</li>
<li><b>LIST-NAMES</b> is the keyword the user use with org in reverse order
</li>
<li><b>HMAP-ID-NAME</b> is a map of those same keyword with a sequence identifier
</li>
<li><b>CONFIG-DIR</b> is the org-trello's home folder
</li>
<li><b>CONFIG-FILE</b> is the org-trello's setup file (for consumer-key and access-token)
</li>
<li><b>consumer-key</b> is the user's consumer-key for trello
</li>
<li><b>access-token</b> is the user's read/write access-token for trello
</li>
<li><b>ORGTRELLO-MARKER</b> is a marker used by org-trello to know which entity it has synced. This is dependent on the <b>consumer-key</b>
</li>
</ul>

<p>
The user does not have to touch anything on this.
</p>

<div class="org-src-container">

<pre class="src src-lisp" id="orgtrello-setup-variable">

;; #################### orgtrello

;; Specific state - FIXME check if they do not already exist on org-mode to avoid potential collisions
(defvar *TODO* "TODO" "org-mode todo state")
(defvar *DONE* "DONE" "org-mode done state")

;; Properties key for the orgtrello headers #+PROPERTY board-id, etc...
(defvar *BOARD-ID* "board-id" "orgtrello property board-id entry")
(defvar *BOARD-NAME* "board-name" "orgtrello property board-name entry")

(defvar *LIST-NAMES*   nil "orgtrello property names of the different lists. This use the standard 'org-todo-keywords property from org-mode.")
(defvar *HMAP-ID-NAME* nil "orgtrello hash map containing for each id, the associated name (or org keyword).")

(defvar *CONFIG-DIR*  (concat (getenv "HOME") "/" ".trello"))
(defvar *CONFIG-FILE* (concat *CONFIG-DIR* "/config.el"))

(defvar *consumer-key*     nil "Id representing the user")
(defvar *access-token*     nil "Read/write Access token to use trello in the user's name ")
(defvar *ORGTRELLO-MARKER* nil "Marker used for syncing the data in trello")
</pre>
</div>
</div>
</div>

<div id="outline-container-sec-5-4-2" class="outline-4">
<h4 id="sec-5-4-2">Control/setup routines</h4>
<div class="outline-text-4" id="text-5-4-2">
<p>
Some control/setup important routines because they will permit or not to launch the main actions.
</p>
</div>

<ul class="org-ul"><li><a id="sec-5-4-2-1" name="sec-5-4-2-1"></a>orgtrello/&#x2013;setup-properties<br  /><div class="outline-text-5" id="text-5-4-2-1">
<p>
This is an important routine in charge of loading the keywords the user want to use.
Note that this routine reverse the list of org keywords.
This is a trick to help create the list in trello in the right order (assuming the user defines in the right order his/her keywords, e.g <i>TODO DOING | DONE FAIL</i>)
</p>

<div class="org-src-container">

<pre class="src src-lisp" id="orgtrello/-setup-properties">(defun orgtrello/--setup-properties ()
  "Setup the properties according to the org-mode setup. Return :ok."
  (let* ((orgtrello/--list-keywords (nreverse (orgtrello/filtered-kwds)))
	 (orgtrello/--hmap-id-name (cl-reduce
				    (lambda (hmap name)
				      (progn
					(puthash (assoc-default name org-file-properties) name hmap)
					hmap))
				    orgtrello/--list-keywords
				    :initial-value (make-hash-table :test 'equal))))
    (setq *LIST-NAMES*   orgtrello/--list-keywords)
    (setq *HMAP-ID-NAME* orgtrello/--hmap-id-name)
    :ok))
</pre>
</div>
</div>
</li>

<li><a id="sec-5-4-2-2" name="sec-5-4-2-2"></a>orgtrello/filtered-kwds<br  /><div class="outline-text-5" id="text-5-4-2-2">
<p>
This is a function in charge of retrieving the specific keywords the user wants to use with trello.
This will map later as the list in trello and as keyword in emacs's org-mode buffer.
</p>

<div class="org-src-container">

<pre class="src src-lisp" id="orgtrello/filtered-kwds">(defun orgtrello/filtered-kwds ()
  "org keywords used (based on org-todo-keywords-1)."
  org-todo-keywords-1)
</pre>
</div>
</div>
</li>


<li><a id="sec-5-4-2-3" name="sec-5-4-2-3"></a>orgtrello/&#x2013;control-encoding<br  /><div class="outline-text-5" id="text-5-4-2-3">
<p>
A simple message to make the user aware he needs to use utf-8 encoding.
</p>

<div class="org-src-container">

<pre class="src src-lisp" id="orgtrello/-control-encoding">(defun orgtrello/--control-encoding ()
  "Use utf-8, otherwise, there will be trouble."
  (progn
    (message "Ensure you use utf-8 encoding for your org buffer.")
    :ok))
</pre>
</div>
</div>
</li>

<li><a id="sec-5-4-2-4" name="sec-5-4-2-4"></a>orgtrello/&#x2013;control-properties<br  /><div class="outline-text-5" id="text-5-4-2-4">
<p>
An important higher routine to ensure that the setup regarding the trello board is rightly setuped on the org buffer.
We simply ensure that we have the right amount of properties regarding the org keywords.
If all is ok, we return the :ok value, otherwise, we return an error message indicating the user what he must do.
</p>

<div class="org-src-container">

<pre class="src src-lisp" id="orgtrello/-control-properties">(defun orgtrello/--control-properties ()
  "org-trello needs the properties board-id and all list id from the trello board to be setuped on header property file. Returns :ok if everything is ok, or the error message if problems."
  (let ((orgtrello/--hmap-count   (hash-table-count *HMAP-ID-NAME*)))
    (if (and (assoc-default *BOARD-ID* org-file-properties)
	     (= (length *LIST-NAMES*) orgtrello/--hmap-count))
	:ok
      "Setup problem.\nEither you did not connect your org-mode buffer with a trello board, to correct this:\n  * attach to a board through C-c o I or M-x org-trello/install-board-and-lists-ids\n  * or create a board from scratch with C-c o b or M-x org-trello/create-board).\nEither your org-mode's todo keyword list and your trello board lists are not named the same way (which they must).\nFor this, connect to trello and rename your board's list according to your org-mode's todo list.\nAlso, you can specify on your org-mode buffer the todo list you want to work with, for example: #+TODO: TODO DOING | DONE FAIL (hit C-c C-c to refresh the setup)")))
</pre>
</div>
</div>
</li>

<li><a id="sec-5-4-2-5" name="sec-5-4-2-5"></a>orgtrello/&#x2013;control-keys<br  /><div class="outline-text-5" id="text-5-4-2-5">
<p>
Another important check routine to ensure that the user has rightfully setuped his/her consumer-key and read/write access-token.
If everything is ok, we return :ok.
Otherwise, we return an error message indicating what the user must do.
</p>

<div class="org-src-container">

<pre class="src src-lisp" id="orgtrello/-control-keys">(defun orgtrello/--control-keys ()
  "org-trello needs the *consumer-key* and the *access-token* to access the trello resources. Returns :ok if everything is ok, or the error message if problems."
  (if (or (and *consumer-key* *access-token*)
	  ;; the data are not set,
	  (and (file-exists-p *CONFIG-FILE*)
	       ;; trying to load them
	       (load *CONFIG-FILE*)
	       ;; still not loaded, something is not right!
	       (and *consumer-key* *access-token*)
	       ;; setting the marker once
	       (setq *ORGTRELLO-MARKER* (format "orgtrello-marker-%s" *consumer-key*))))
      :ok
    "Setup problem - You need to install the consumer-key and the read/write access-token - C-c o i or M-x org-trello/install-board-and-lists-ids"))
</pre>
</div>
</div>
</li></ul>
</div>

<div id="outline-container-sec-5-4-3" class="outline-4">
<h4 id="sec-5-4-3">Abstraction access routines</h4>
<div class="outline-text-4" id="text-5-4-3">
<p>
Those are simple routines to abstract away the representation of the org data we manipulate.
</p>
</div>

<ul class="org-ul"><li><a id="sec-5-4-3-1" name="sec-5-4-3-1"></a>orgtrello/&#x2013;keyword<br  /><div class="outline-text-5" id="text-5-4-3-1">
<p>
Extract the status/keyword from the current entity (e.g TODO, DONE, etc&#x2026;).
</p>

<div class="org-src-container">

<pre class="src src-lisp" id="orgtrello/-keyword">(defun orgtrello/--keyword (entity-meta &amp;optional default-value)
  "Retrieve the keyword from the entity. If default-value is specified, this is the default value if no keyword is present"
  (gethash :keyword entity-meta default-value))
</pre>
</div>
</div>
</li>

<li><a id="sec-5-4-3-2" name="sec-5-4-3-2"></a>orgtrello/&#x2013;label<br  /><div class="outline-text-5" id="text-5-4-3-2">
<p>
To extract the label from the entity.
This is what's map to the name of the entity on trello.
</p>

<div class="org-src-container">

<pre class="src src-lisp" id="orgtrello/-label">(defun orgtrello/--label (entity-meta)
  "Retrieve the label from the entity."
  (gethash :title entity-meta))
</pre>
</div>
</div>
</li>

<li><a id="sec-5-4-3-3" name="sec-5-4-3-3"></a>orgtrello/&#x2013;id<br  /><div class="outline-text-5" id="text-5-4-3-3">
<p>
The identifier of the entity once it has been synchronized on trello.
</p>

<div class="org-src-container">

<pre class="src src-lisp" id="orgtrello/-id">(defun orgtrello/--id (entity-meta)
  "Retrieve the id from the entity."
  (gethash :id entity-meta))
</pre>
</div>
</div>
</li>

<li><a id="sec-5-4-3-4" name="sec-5-4-3-4"></a>orgtrello/&#x2013;level<br  /><div class="outline-text-5" id="text-5-4-3-4">
<p>
The current level (mapped to the number of stars).
</p>

<div class="org-src-container">

<pre class="src src-lisp" id="orgtrello/-level">(defun orgtrello/--level (entity-meta)
  "Retrieve the level from the entity."
  (gethash :level entity-meta))
</pre>
</div>
</div>
</li>

<li><a id="sec-5-4-3-5" name="sec-5-4-3-5"></a>orgtrello/&#x2013;due<br  /><div class="outline-text-5" id="text-5-4-3-5">
<p>
The deadline (org notion) mapped to due date (on trello).
</p>

<div class="org-src-container">

<pre class="src src-lisp" id="orgtrello/-due">(defun orgtrello/--due (entity-meta)
  "Retrieve the due date from the entity."
  (gethash :due entity-meta))
</pre>
</div>
</div>
</li></ul>
</div>

<div id="outline-container-sec-5-4-4" class="outline-4">
<h4 id="sec-5-4-4">Create simple entity</h4>
<div class="outline-text-4" id="text-5-4-4">
</div><ul class="org-ul"><li><a id="sec-5-4-4-1" name="sec-5-4-4-1"></a>orgtrello/do-create-simple-entity<br  /><div class="outline-text-5" id="text-5-4-4-1">
<p>
The orchestration to trigger the simple synchronization of an entity (without any arborescence):
</p>
<ul class="org-ul">
<li>compute the metadata (current, parent, grandparent) from the current org entry (this may be need if too deep level)
</li>
<li>if there is some metadata
<ul class="org-ul">
<li>if this is an error message, transit the message
</li>
<li>otherwise
<ul class="org-ul">
<li>set the marker on org buffer for the current entry
</li>
<li>compute and execute the http query
</li>
<li>return a success message
</li>
</ul>
</li>
</ul>
</li>
</ul>

<div class="org-src-container">

<pre class="src src-lisp" id="orgtrello/do-create-simple-entity">(defun orgtrello/do-create-simple-entity (&amp;optional sync)
  "Do the actual simple creation of a card, checklist or task. Optionally, we can render the creation synchronous."
  (let ((entry-metadata (orgtrello-data/entry-get-full-metadata)))
    (if entry-metadata
	(let ((query-http-or-error-msg (orgtrello/--dispatch-create (gethash :current entry-metadata) (gethash :parent entry-metadata) (gethash :grandparent entry-metadata))))
	  (if (hash-table-p query-http-or-error-msg)
	      ;; if it's a hash-table we can do the sync
	      (progn
		;; set the consumer-key to make a pointer to get back to when the request is finished
		(orgtrello/--set-marker)
		;; request
		(orgtrello-query/http query-http-or-error-msg sync 'orgtrello-query/--post-put-success-callback-update-id)
		"Synchronizing simple entity done!")
	    ;; else it's a string to display
	    query-http-or-error-msg)))))
</pre>
</div>
</div>
</li>

<li><a id="sec-5-4-4-2" name="sec-5-4-4-2"></a>creation/update routine<br  /><div class="outline-text-5" id="text-5-4-4-2">
<p>
Those functions does not actually do any request, they compute the map representing the request.
</p>
</div>
<ul class="org-ul"><li><a id="sec-5-4-4-2-1" name="sec-5-4-4-2-1"></a>card<br  /><ul class="org-ul"><li><a id="sec-5-4-4-2-1-1" name="sec-5-4-4-2-1-1"></a>orgtrello/&#x2013;card<br  /><div class="outline-text-7" id="text-5-4-4-2-1-1">
<p>
This is the main entry to create/update a card.
There is a series of check done by the <code>orgtrello/--checks-before-sync-card</code> function.
If ok, then we can continue with the main intent of the function.
We extract from the metadata the:
</p>
<ul class="org-ul">
<li>keyword status of the card (TODO, DONE, etc&#x2026;)
</li>
<li>trello list identifier to which the card belongs to (depending on the keyword status)
</li>
<li>card's identifier
</li>
<li>card's name
</li>
<li>card's due
</li>
</ul>

<p>
Then we create or update the card depending on the presence or not of the card identifier.
if card id present update else create.
</p>

<div class="org-src-container">

<pre class="src src-lisp" id="orgtrello/-card">(defun orgtrello/--card (card-meta &amp;optional parent-meta grandparent-meta)
  "Deal with create/update card query build. If the checks are ko, the error message is returned."
  (let ((checks-ok-or-error-message (orgtrello/--checks-before-sync-card card-meta)))
    ;; title is mandatory
    (if (equal :ok checks-ok-or-error-message)
	;; parent and grandparent are useless here
	(let* ((orgtrello/--card-kwd  (orgtrello/--retrieve-state-of-card card-meta))
	       (orgtrello/--list-id   (assoc-default orgtrello/--card-kwd org-file-properties))
	       (orgtrello/--card-id   (orgtrello/--id    card-meta))
	       (orgtrello/--card-name (orgtrello/--label card-meta))
	       (orgtrello/--card-due  (orgtrello/--due   card-meta)))
	  (if orgtrello/--card-id
	      ;; update
	      (orgtrello-api/move-card orgtrello/--card-id orgtrello/--list-id orgtrello/--card-name orgtrello/--card-due)
	    ;; create
	    (orgtrello-api/add-card orgtrello/--card-name orgtrello/--list-id orgtrello/--card-due)))
      checks-ok-or-error-message)))
</pre>
</div>
</div>
</li>
<li><a id="sec-5-4-4-2-1-2" name="sec-5-4-4-2-1-2"></a>orgtrello/&#x2013;retrieve-state-of-card<br  /><div class="outline-text-7" id="text-5-4-4-2-1-2">
<p>
This function helps computes the status of the card.
If no status is present, TODO is assumed.
</p>

<div class="org-src-container">

<pre class="src src-lisp" id="orgtrello/-retrieve-state-of-card">(defun orgtrello/--retrieve-state-of-card (card-meta)
  "Given a card, retrieve its state depending on its :keyword metadata. If empty or no keyword then, its equivalence is *TODO*, otherwise, return its current state."
  (let* ((orgtrello/--card-kwd (orgtrello/--keyword card-meta *TODO*)))
    (if orgtrello/--card-kwd orgtrello/--card-kwd *TODO*)))
</pre>
</div>
</div>
</li>

<li><a id="sec-5-4-4-2-1-3" name="sec-5-4-4-2-1-3"></a>orgtrello/&#x2013;checks-before-sync-card<br  /><div class="outline-text-7" id="text-5-4-4-2-1-3">
<p>
Does some basic checks. Typically, here only the name/title/label is mandatory.
</p>

<div class="org-src-container">

<pre class="src src-lisp" id="orgtrello/-checks-before-sync-card">(defun orgtrello/--checks-before-sync-card (card-meta)
  "Checks done before synchronizing the cards."
  (let ((orgtrello/--card-name (orgtrello/--label card-meta)))
    (if orgtrello/--card-name
	:ok
      "Cannot synchronize the card - missing mandatory label. Skip it...")))
</pre>
</div>
</div>
</li></ul>
</li>

<li><a id="sec-5-4-4-2-2" name="sec-5-4-4-2-2"></a>checklist<br  /><ul class="org-ul"><li><a id="sec-5-4-4-2-2-1" name="sec-5-4-4-2-2-1"></a>orgtrello/&#x2013;checklist<br  /><div class="outline-text-7" id="text-5-4-4-2-2-1">
<p>
The idea is similar than the card function.
First, checks using <i>orgtrello</i>&#x2013;checks-before-sync-checklist/ function.
If ok, continue otherwise return the error message.
Then extract the needed metadata:
</p>
<ul class="org-ul">
<li>checklist identifier (optional)
</li>
<li>card identifier (mandatory, a checklist belongs to a card)
</li>
<li>checklist name (mandatory)
</li>
</ul>
<p>
Again, if checklist identifier present, we update otherwise we create.
</p>

<div class="org-src-container">

<pre class="src src-lisp" id="orgtrello/-checklist">(defun orgtrello/--checklist (checklist-meta &amp;optional card-meta grandparent-meta)
  "Deal with create/update checklist query build. If the checks are ko, the error message is returned."
  (let ((checks-ok-or-error-message (orgtrello/--checks-before-sync-checklist checklist-meta card-meta)))
    ;; title is mandatory
    (if (equal :ok checks-ok-or-error-message)
	;; grandparent is useless here
	(let* ((orgtrello/--checklist-id   (orgtrello/--id checklist-meta))
	       (orgtrello/--card-id        (orgtrello/--id card-meta))
	       (orgtrello/--checklist-name (orgtrello/--label checklist-meta)))
	  (if orgtrello/--checklist-id
	      ;; update
	      (orgtrello-api/update-checklist orgtrello/--checklist-id orgtrello/--checklist-name)
	    ;; create
	    (orgtrello-api/add-checklist orgtrello/--card-id orgtrello/--checklist-name)))
      checks-ok-or-error-message)))
</pre>
</div>
</div>
</li>
<li><a id="sec-5-4-4-2-2-2" name="sec-5-4-4-2-2-2"></a>orgtrello/&#x2013;checks-before-sync-checklist<br  /><div class="outline-text-7" id="text-5-4-4-2-2-2">
<p>
A little more complex check are done.
We need to ensure:
</p>
<ul class="org-ul">
<li>the card's id is present
</li>
<li>the checklist's name is present too.
</li>
</ul>
<p>
If some are missing, send the error message corresponding.
</p>

<div class="org-src-container">

<pre class="src src-lisp" id="orgtrello/-checks-before-sync-checklist">(defun orgtrello/--checks-before-sync-checklist (checklist-meta card-meta)
  "Checks done before synchronizing the checklist."
  (let ((orgtrello/--checklist-name (orgtrello/--label checklist-meta))
	(orgtrello/--card-id        (orgtrello/--id card-meta)))
    (if orgtrello/--checklist-name
	(if orgtrello/--card-id
	    :ok
	  "Cannot synchronize the checklist - the card must be synchronized first. Skip it...")
      "Cannot synchronize the checklist - missing mandatory label. Skip it...")))
</pre>
</div>
</div>
</li></ul>
</li>

<li><a id="sec-5-4-4-2-3" name="sec-5-4-4-2-3"></a>task/item<br  /><ul class="org-ul"><li><a id="sec-5-4-4-2-3-1" name="sec-5-4-4-2-3-1"></a>orgtrello/&#x2013;task<br  /><div class="outline-text-7" id="text-5-4-4-2-3-1">
<p>
Update the task/item.
First checks.
If ok, continue otherwise return the error message.
Metadata extracted:
</p>
<ul class="org-ul">
<li>task/item's id (optional)
</li>
<li>checklist's id (mandatory)
</li>
<li>card's id (mandatory)
</li>
<li>task/item's name (mandatory)
</li>
<li>checklist's state (trello api distinguish between the state at update time from the check status at creation time)
</li>
<li>checklist's check status
</li>
</ul>

<p>
Depending on the presence of the task/item's identifier, we update or create.
</p>

<div class="org-src-container">

<pre class="src src-lisp" id="orgtrello/-task">(defun orgtrello/--task (task-meta &amp;optional checklist-meta card-meta)
  "Deal with create/update task query build. If the checks are ko, the error message is returned."
  (let ((checks-ok-or-error-message (orgtrello/--checks-before-sync-item task-meta checklist-meta card-meta)))
    ;; title is mandatory
    (if (equal :ok checks-ok-or-error-message)
	;; card-meta is only usefull for the update part
	(let* ((orgtrello/--task-id      (orgtrello/--id task-meta))
	       (orgtrello/--checklist-id (orgtrello/--id checklist-meta))
	       (orgtrello/--card-id      (orgtrello/--id card-meta))
	       (orgtrello/--task-name    (orgtrello/--label task-meta))
	       (orgtrello/--task-state   (orgtrello/--keyword task-meta))
	       (orgtrello/--checklist-state    (orgtrello/--keyword checklist-meta)))

	  (orgtrello/--update-item-according-to-checklist-status *ORGTRELLO-CHECKLIST-UPDATE-ITEMS* checklist-meta)
	  ;; update/create items
	  (if orgtrello/--task-id
	      ;; update - rename, check or uncheck the task
	      (orgtrello-api/update-task orgtrello/--card-id orgtrello/--checklist-id orgtrello/--task-id orgtrello/--task-name (orgtrello/--task-compute-state *ORGTRELLO-CHECKLIST-UPDATE-ITEMS* orgtrello/--task-state orgtrello/--checklist-state))
	    ;; create
	    (orgtrello-api/add-tasks orgtrello/--checklist-id orgtrello/--task-name (orgtrello/--task-compute-check *ORGTRELLO-CHECKLIST-UPDATE-ITEMS* orgtrello/--task-state orgtrello/--checklist-state))))
      checks-ok-or-error-message)))
</pre>
</div>

<p>
Also, there is a sublety.
<b>ORGTRELLO-CHECKLIST-UPDATE-ITEMS</b> is a global setup that permits the override of the task/item's status (checked or not).
if <b>ORGTRELLO-CHECKLIST-UPDATE-ITEMS</b> is set to 't, this will override such setup.
Otherwise, the item's status is computed depending on org's keyword.
This means that if <b>ORGTRELLO-CHECKLIST-UPDATE-ITEMS</b> is 't, we need to update the buffer accordingly to such status since this will be synchronized on trello.
That's the responsibility of the function <i>orgtrello</i>&#x2013;update-item-according-to-checklist-status/.
</p>
</div>
</li>

<li><a id="sec-5-4-4-2-3-2" name="sec-5-4-4-2-3-2"></a>orgtrello/&#x2013;checks-before-sync-item<br  /><div class="outline-text-7" id="text-5-4-4-2-3-2">
<p>
The control function which ensures:
</p>
<ul class="org-ul">
<li>task/item's id
</li>
<li>checklist's id
</li>
<li>card's id
</li>
</ul>
<p>
are presents.
If some are missing, the corresponding error message is sent, :ok otherwise.
</p>

<div class="org-src-container">

<pre class="src src-lisp" id="orgtrello/-checks-before-sync-item">(defun orgtrello/--checks-before-sync-item (task-meta checklist-meta card-meta)
  "Checks done before synchronizing the checklist."
  (let ((orgtrello/--task-name    (orgtrello/--label task-meta))
	(orgtrello/--checklist-id (orgtrello/--id checklist-meta))
	(orgtrello/--card-id      (orgtrello/--id card-meta)))
    (if orgtrello/--task-name
	(if orgtrello/--checklist-id
	    (if orgtrello/--card-id
		:ok
	      "Cannot synchronize the item - the card must be synchronized first. Skip it...")
	  "Cannot synchronize the item - the checklist must be synchronized first. Skip it...")
      "Cannot synchronize the item - missing mandatory label. Skip it...")))
</pre>
</div>
</div>
</li>

<li><a id="sec-5-4-4-2-3-3" name="sec-5-4-4-2-3-3"></a>orgtrello/&#x2013;task-compute-state-or-check<br  /><div class="outline-text-7" id="text-5-4-4-2-3-3">
<p>
An HOF (higher order function) that captures the computation of the state (update) or the check (create) of an item/task.
</p>
<div class="org-src-container">

<pre class="src src-lisp" id="orgtrello/-task-compute-state-or-check">(defun orgtrello/--task-compute-state-or-check (checklist-update-items-p task-state checklist-state possible-states)
  "Compute the task's state/check (for creation/update). The 2 possible states are in the list possible states, first position is the 'checked' one, and second the unchecked one."
  (let* ((orgtrello/--task-checked   (first possible-states))
	 (orgtrello/--task-unchecked (second possible-states)))
    (cond ((and checklist-update-items-p (string= *DONE* checklist-state))                      orgtrello/--task-checked)
	  ((and checklist-update-items-p (or checklist-state (string= *TODO* checklist-state))) orgtrello/--task-unchecked)
	  ((string= *DONE* task-state)                                                          orgtrello/--task-checked)
	  (t                                                                                    orgtrello/--task-unchecked))))
</pre>
</div>
</div>
</li>

<li><a id="sec-5-4-4-2-3-4" name="sec-5-4-4-2-3-4"></a>orgtrello/&#x2013;task-compute-state<br  /><div class="outline-text-7" id="text-5-4-4-2-3-4">
<p>
A function to compute the state (update) of the task/item:
</p>
<ul class="org-ul">
<li>complete
</li>
<li>incomplete
</li>
</ul>

<p>
There is a subtlety here.
<i>checklist-update-items-p</i> represents a global setup to make the checklist's status more important than the current item/task's status.
</p>

<p>
Here is the truth table:
</p>

<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="left" />

<col  class="left" />

<col  class="left" />

<col  class="left" />
</colgroup>
<thead>
<tr>
<th scope="col" class="left">checklist-update-items-p</th>
<th scope="col" class="left">checklist's status</th>
<th scope="col" class="left">task/item's status</th>
<th scope="col" class="left">Result</th>
</tr>
</thead>
<tbody>
<tr>
<td class="left">t</td>
<td class="left">c-st</td>
<td class="left">X</td>
<td class="left">(= c-st <b>DONE</b> "complete" "incomplete")</td>
</tr>

<tr>
<td class="left">nil</td>
<td class="left">X</td>
<td class="left">t-st</td>
<td class="left">(= t-st <b>DONE</b> "complete" "incomplete")</td>
</tr>
</tbody>
</table>
<p>
n
</p>
<div class="org-src-container">

<pre class="src src-lisp" id="orgtrello/-task-compute-state">(defun orgtrello/--task-compute-state (checklist-update-items-p task-state checklist-state)
  "Compute the task's state (for creation)."
  (orgtrello/--task-compute-state-or-check checklist-update-items-p task-state checklist-state '("complete" "incomplete")))
</pre>
</div>
</div>
</li>

<li><a id="sec-5-4-4-2-3-5" name="sec-5-4-4-2-3-5"></a>orgtrello/&#x2013;task-compute-check<br  /><div class="outline-text-7" id="text-5-4-4-2-3-5">
<p>
A function to compute the check status of the task/item:
</p>
<ul class="org-ul">
<li>t
</li>
<li>nil
</li>
</ul>

<p>
There is a subtlety here.
<i>checklist-update-items-p</i> represents a global setup to make the checklist's status more important than the current item/task's status.
</p>

<p>
Here is the truth table:
</p>

<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="left" />

<col  class="left" />

<col  class="left" />

<col  class="left" />
</colgroup>
<thead>
<tr>
<th scope="col" class="left">checklist-update-items-p</th>
<th scope="col" class="left">checklist's status</th>
<th scope="col" class="left">task/item's check status</th>
<th scope="col" class="left">Result</th>
</tr>
</thead>
<tbody>
<tr>
<td class="left">t</td>
<td class="left">c-st</td>
<td class="left">X</td>
<td class="left">(= c-st <b>DONE</b> t nil)</td>
</tr>

<tr>
<td class="left">nil</td>
<td class="left">X</td>
<td class="left">t-st</td>
<td class="left">(= t-st <b>DONE</b> t nil)</td>
</tr>
</tbody>
</table>

<div class="org-src-container">

<pre class="src src-lisp" id="orgtrello/-task-compute-check">(defun orgtrello/--task-compute-check (checklist-update-items-p task-state checklist-state)
  "Compute the task's check status (for update)."
    (orgtrello/--task-compute-state-or-check checklist-update-items-p task-state checklist-state '(t nil)))
</pre>
</div>
</div>
</li>

<li><a id="sec-5-4-4-2-3-6" name="sec-5-4-4-2-3-6"></a>orgtrello/&#x2013;update-item-according-to-checklist-status<br  /><div class="outline-text-7" id="text-5-4-4-2-3-6">
<p>
This is a function, depending on <i>checklist-update-items-p</i>, which is in charge of aligning the status of the keyword in the org buffer according to the checklist's keyword.
if <i>checklist-update-items-p</i> is 't, then update else does nothing.
</p>

<div class="org-src-container">

<pre class="src src-lisp" id="orgtrello/-update-item-according-to-checklist-status">(defun orgtrello/--update-item-according-to-checklist-status (checklist-update-items-p checklist-meta)
  "Update the item of the checklist according to the status of the checklist."
  (if checklist-update-items-p
      (let ((orgtrello/--checklist-status (orgtrello/--compute-state-from-keyword (orgtrello/--keyword checklist-meta))))
	(org-todo orgtrello/--checklist-status))))
</pre>
</div>
</div>
</li>

<li><a id="sec-5-4-4-2-3-7" name="sec-5-4-4-2-3-7"></a>orgtrello/&#x2013;compute-state-from-keyword<br  /><div class="outline-text-7" id="text-5-4-4-2-3-7">
<p>
Given a state, compute its org equivalent:
</p>

<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="left" />

<col  class="left" />
</colgroup>
<thead>
<tr>
<th scope="col" class="left">state</th>
<th scope="col" class="left">org</th>
</tr>
</thead>
<tbody>
<tr>
<td class="left">nil</td>
<td class="left">""</td>
</tr>

<tr>
<td class="left">""</td>
<td class="left">""</td>
</tr>

<tr>
<td class="left"><b>DONE</b></td>
<td class="left"><b>DONE</b></td>
</tr>

<tr>
<td class="left"><b>TODO</b></td>
<td class="left"><b>TODO</b></td>
</tr>

<tr>
<td class="left">Otherwise</td>
<td class="left"><b>TODO</b></td>
</tr>
</tbody>
</table>

<div class="org-src-container">

<pre class="src src-lisp" id="orgtrello/-compute-state-from-keyword">(defun orgtrello/--compute-state-from-keyword (state)
  "Given a state, compute the org equivalent (to use with org-todo function)"
  (cond ((or (not state) (string= "" state)) *TODO*)
	((string= *DONE* state)              'done)
	((string= *TODO* state)              *TODO*)
	(t                                   *TODO*)))
</pre>
</div>
</div>
</li></ul>
</li></ul>
</li>

<li><a id="sec-5-4-4-3" name="sec-5-4-4-3"></a>orgtrello/&#x2013;too-deep-level<br  /><div class="outline-text-5" id="text-5-4-4-3">
<p>
A function which simply displays that the arborescence depth is too deep.
We only deal with 3 levels (1 -&gt; card, 2 -&gt; checklist, 3 -&gt; item/task).
</p>

<div class="org-src-container">

<pre class="src src-lisp" id="orgtrello/-too-deep-level">(defun orgtrello/--too-deep-level (meta &amp;optional parent-meta grandparent-meta)
  "Deal with too deep level."
  "Your arborescence depth is too deep. We only support up to depth 3.\nLevel 1 - card\nLevel 2 - checklist\nLevel 3 - items/tasks")
</pre>
</div>
</div>
</li>

<li><a id="sec-5-4-4-4" name="sec-5-4-4-4"></a>orgtrello/&#x2013;dispatch-map-creation<br  /><div class="outline-text-5" id="text-5-4-4-4">
<p>
An initialization of the dispatch creation/update function depending on the level (1, 2, 3).
We use this function to initialize once the <b>MAP-DISPATCH-CREATE-UPDATE</b> which will be use to dispatch on the level of the entity to sync.
</p>

<div class="org-src-container">

<pre class="src src-lisp" id="orgtrello/-dispatch-map-creation">(defun orgtrello/--dispatch-map-creation ()
  "Dispatch map for the creation of card/checklist/item."
  (let* ((dispatch-map (make-hash-table :test 'equal)))
    (puthash 1 'orgtrello/--card      dispatch-map)
    (puthash 2 'orgtrello/--checklist dispatch-map)
    (puthash 3 'orgtrello/--task      dispatch-map)
    dispatch-map))

(defvar *MAP-DISPATCH-CREATE-UPDATE* (orgtrello/--dispatch-map-creation) "Dispatch map for the creation/update of card/checklist/task")
</pre>
</div>
</div>
</li>

<li><a id="sec-5-4-4-5" name="sec-5-4-4-5"></a>orgtrello/&#x2013;set-marker<br  /><div class="outline-text-5" id="text-5-4-4-5">
<p>
A simple routine to install an orgtrello-marker before launching any synchronization.
</p>

<div class="org-src-container">

<pre class="src src-lisp" id="orgtrello/-set-marker">(defun orgtrello/--set-marker ()
  "Set the consumer-key to make a pointer to get back to when the request is finished"
  (org-set-property *ORGTRELLO-MARKER* *ORGTRELLO-MARKER*))
</pre>
</div>
</div>
</li>

<li><a id="sec-5-4-4-6" name="sec-5-4-4-6"></a>orgtrello/&#x2013;dispatch-create<br  /><div class="outline-text-5" id="text-5-4-4-6">
<p>
The function which will extract the current level of the entity and call the function to generate the create/update request for the current entity.
</p>

<div class="org-src-container">

<pre class="src src-lisp" id="orgtrello/-dispatch-create">(defun orgtrello/--dispatch-create (meta &amp;optional parent-meta grandparent-meta)
  (let* ((level       (orgtrello/--level meta))
	 (dispatch-fn (gethash level *MAP-DISPATCH-CREATE-UPDATE* 'orgtrello/--too-deep-level)))
    ;; then execute the call
    (funcall dispatch-fn meta parent-meta grandparent-meta)))
</pre>
</div>
</div>
</li></ul>
</div>

<div id="outline-container-sec-5-4-5" class="outline-4">
<h4 id="sec-5-4-5">Create complex entity</h4>
<div class="outline-text-4" id="text-5-4-5">
</div><ul class="org-ul"><li><a id="sec-5-4-5-1" name="sec-5-4-5-1"></a>orgtrello/&#x2013;board-name<br  /><div class="outline-text-5" id="text-5-4-5-1">
<p>
Extract the board name from the org buffer's metadata.
</p>

<div class="org-src-container">

<pre class="src src-lisp" id="orgtrello/-board-name">(defun orgtrello/--board-name ()
  "Compute the board's name"
  (assoc-default *BOARD-NAME* org-file-properties))
</pre>
</div>
</div>
</li>

<li><a id="sec-5-4-5-2" name="sec-5-4-5-2"></a>orgtrello/do-create-complex-entity<br  /><div class="outline-text-5" id="text-5-4-5-2">
<p>
The main function in charge of synchronizing the entity (with its arborescence):
</p>
<ul class="org-ul">
<li>Get back to the upper level of the current entry
</li>
<li>Map over the full arborescence (in order) and sync the entity (using the primitive <i>orgtrello/do-create-simple-entity</i>)
</li>
<li>Return a success message
</li>
</ul>

<div class="org-src-container">

<pre class="src src-lisp" id="orgtrello/do-create-complex-entity">(defun orgtrello/do-create-complex-entity ()
  "Do the actual full card creation - from card to task. Beware full side effects..."
  (let ((orgtrello/--board-name-to-sync (orgtrello/--board-name)))
    (message "Synchronizing full entity with its structure on board '%s'..." orgtrello/--board-name-to-sync)
    (save-excursion
      ;; iterate over the map of
      (org-map-tree (lambda () (orgtrello/do-create-simple-entity t))))
    (format "Synchronizing full entity with its structure on board '%s' - done" orgtrello/--board-name-to-sync)))
</pre>
</div>
</div>
</li></ul>
</div>

<div id="outline-container-sec-5-4-6" class="outline-4">
<h4 id="sec-5-4-6">Synchronize full org buffer to trello</h4>
<div class="outline-text-4" id="text-5-4-6">
<p>
Synchronize the full org file to the trello board.
The idea is to send all the cards presents in the buffer to the trello board (no merge, org buffer has all the rights here).
At the end, return a success message.
</p>

<div class="org-src-container">

<pre class="src src-lisp" id="orgtrello/do-sync-full-file">(defun orgtrello/do-sync-full-file ()
  "Full org-mode file synchronisation. Beware, this will block emacs as the request is synchronous."
  (let ((orgtrello/--board-name-to-sync (orgtrello/--board-name)))
    (message "Synchronizing org-mode file to the board '%s'. This may take some time, some coffee may be a good idea..." (orgtrello/--board-name))
    (org-map-entries (lambda () (orgtrello/do-create-simple-entity t)) t 'file)
    (format "Synchronizing org-mode file to the board '%s' - done!" orgtrello/--board-name-to-sync)))
</pre>
</div>
</div>
</div>

<div id="outline-container-sec-5-4-7" class="outline-4">
<h4 id="sec-5-4-7">Synchronize full org buffer from trello</h4>
<div class="outline-text-4" id="text-5-4-7">
<p>
Synchronize the full org file from the trello board.
The idea is to compute all the trello cards from trello.
Map over the current org buffer, synchronize from trello (no merge, trello has all power here) and overwrite the trello data for each entry.
Each data remaining not already present on the buffer are then dumped in the current buffer.
</p>
</div>

<ul class="org-ul"><li><a id="sec-5-4-7-1" name="sec-5-4-7-1"></a>orgtrello/do-sync-full-from-trello<br  /><div class="outline-text-5" id="text-5-4-7-1">
<p>
Main function:
</p>
<ul class="org-ul">
<li>retrieve the board id from the org metadata
</li>
<li>compute the cards from the trello board
</li>
<li>synchronize all the entities present on the buffer with the data from trello (remove them as soon as they are synced)
</li>
<li>synchronize all the remaining entities into the current buffer
</li>
<li>return a successfull message
</li>
</ul>

<div class="org-src-container">

<pre class="src src-lisp" id="orgtrello/do-sync-full-from-trello">(defun orgtrello/do-sync-full-from-trello ()
  "Full org-mode file synchronisation. Beware, this will block emacs as the request is synchronous."
  (let ((orgtrello/--board-name-to-sync (orgtrello/--board-name)))
    (message "Synchronizing the trello board '%s' to the org-mode file. This may take a moment, some coffee may be a good idea..." orgtrello/--board-name-to-sync)
    (let* ((orgtrello/--board-id           (assoc-default *BOARD-ID* org-file-properties))
	   (orgtrello/--cards              (orgtrello-query/http (orgtrello-api/get-cards orgtrello/--board-id) t))
	   (orgtrello/--entities-hash-map  (orgtrello/--compute-full-entities-from-trello orgtrello/--cards))
	   (orgtrello/--remaining-entities (orgtrello/--sync-buffer-with-trello-data orgtrello/--entities-hash-map)))
      (orgtrello/--update-buffer-with-remaining-trello-data orgtrello/--remaining-entities))
    (format "Synchronizing the trello board '%s' to the org-mode file - done!" orgtrello/--board-name-to-sync)))
</pre>
</div>
</div>
</li>

<li><a id="sec-5-4-7-2" name="sec-5-4-7-2"></a>orgtrello/&#x2013;sync-buffer-with-trello-data<br  /><div class="outline-text-5" id="text-5-4-7-2">
<p>
Given a map of entities to sync, update each entry with such data.
After each entry update, the entity is removed.
Return the map of entities with the sync entry removed.
</p>

<div class="org-src-container">

<pre class="src src-lisp" id="orgtrello/-sync-buffer-with-trello-data">(defun orgtrello/--sync-buffer-with-trello-data (entities)
  "Given all the entities, update the current buffer with those."
  (with-current-buffer (current-buffer)
    (org-map-entries
     (lambda ()
       (let ((entry-metadata (orgtrello-data/entry-get-full-metadata)))
	 (if entry-metadata ;; if level &gt; 4, entry-metadata is not considered as this is not represented in trello board
	     ;; will search 'entities' hash table for updates (do not compute diffs, take them as is)
	     (let* ((orgtrello/--entity         (gethash :current entry-metadata))
		    (orgtrello/--entity-id      (orgtrello/--id orgtrello/--entity))
		    (orgtrello/--entity-updated (gethash orgtrello/--entity-id entities)))
	       (if orgtrello/--entity-updated
		   ;; found something, we update by squashing the current contents
		   (let* ((orgtrello/--entry-new-id    (orgtrello-query/--id   orgtrello/--entity-updated))
			  (orgtrello/--entity-due-date (orgtrello-query/--due  orgtrello/--entity-updated))
			  (orgtrello/--entry-new-name  (orgtrello-query/--name orgtrello/--entity-updated)))
		     ;; update the buffer with the new updates (there may be none but naively we will overwrite at the moment)
		     (message "Synchronizing entity '%s' with id '%s'..." orgtrello/--entry-new-name orgtrello/--entry-new-id)
		     (org-show-entry)
		     (kill-whole-line)
		     (if orgtrello/--entity-due-date (kill-whole-line))
		     (insert (orgtrello/--compute-entity-to-org-entry orgtrello/--entity-updated))
		     ;; remove the entry from the hash-table
		     (remhash orgtrello/--entity-id entities)))))))
     t
     'file))
  ;; return the entities which has been dryed
  entities)
</pre>
</div>
</div>
</li>

<li><a id="sec-5-4-7-3" name="sec-5-4-7-3"></a>orgtrello/&#x2013;update-buffer-with-remaining-trello-data<br  /><div class="outline-text-5" id="text-5-4-7-3">
<p>
Given a map of entities:
</p>
<ul class="org-ul">
<li>goes at the end of the file
</li>
<li>add the entities present on such map in the org format
</li>
<li>return at the beginning of the file
</li>
<li>sort all the buffer on the org todo keywords order (only the first level -&gt; card).
</li>
</ul>

<div class="org-src-container">

<pre class="src src-lisp" id="orgtrello/-update-buffer-with-remaining-trello-data">(defun orgtrello/--update-buffer-with-remaining-trello-data (entities)
  "Given a map of entities, dump those entities in the current buffer."
  (if entities ;; could be empty
      (with-current-buffer (current-buffer)
	;; go at the end of the file
	(goto-char (point-max))
	;; dump the remaining entities
	(maphash
	 (lambda (orgtrello/--entry-new-id orgtrello/--entity)
	   (let ((orgtrello/--entry-new-name  (orgtrello-query/--name orgtrello/--entity)))
	     (message "Synchronizing new entity '%s' with id '%s'..." orgtrello/--entry-new-name orgtrello/--entry-new-id)
	     (insert (orgtrello/--compute-entity-to-org-entry orgtrello/--entity))
	     (org-set-property *ORGTRELLO-ID* orgtrello/--entry-new-id)))
	 entities)
	(goto-char (point-min))
	(org-sort-entries t ?o))))
</pre>
</div>
</div>
</li>

<li><a id="sec-5-4-7-4" name="sec-5-4-7-4"></a>orgtrello/&#x2013;compute-card-status<br  /><div class="outline-text-5" id="text-5-4-7-4">
<p>
Given a card list id (which represent an org keyword), compute the keywords (this works with the metadata of the file).
</p>

<div class="org-src-container">

<pre class="src src-lisp" id="orgtrello/-compute-card-status">(defun orgtrello/--compute-card-status (card-id-list)
  "Given a card's id, compute its status."
  (gethash card-id-list *HMAP-ID-NAME*))
</pre>
</div>
</div>
</li>

<li><a id="sec-5-4-7-5" name="sec-5-4-7-5"></a>orgtrello/&#x2013;compute-card-to-org-entry<br  /><div class="outline-text-5" id="text-5-4-7-5">
<p>
Given an entry which represents a card, compute its equivalent org format.
</p>

<div class="org-src-container">

<pre class="src src-lisp" id="orgtrello/-compute-card-to-org-entry">(defun orgtrello/--compute-card-to-org-entry (card)
  "Given a card, compute its org-mode entry equivalence."
  (let* ((orgtrello/--card-name     (orgtrello-query/--name card))
	 (orgtrello/--card-status   (orgtrello/--compute-card-status (orgtrello-query/--list-id card)))
	 (orgtrello/--card-due-date (orgtrello-query/--due card)))
    (format "* %s %s\n%s" orgtrello/--card-status orgtrello/--card-name
	    (if orgtrello/--card-due-date (format "DEADLINE: &lt;%s&gt;\n" orgtrello/--card-due-date) ""))))
</pre>
</div>
</div>
</li>

<li><a id="sec-5-4-7-6" name="sec-5-4-7-6"></a>orgtrello/&#x2013;compute-checklist-to-org-entry<br  /><div class="outline-text-5" id="text-5-4-7-6">
<p>
Given an entry which represents a checklist, compute its equivalent org format.
</p>

<div class="org-src-container">

<pre class="src src-lisp" id="orgtrello/-compute-checklist-to-org-entry">(defun orgtrello/--compute-checklist-to-org-entry (checklist)
  "Given a checklist, compute its org-mode entry equivalence."
  (let ((orgtrello/--checklist-name  (orgtrello-query/--name checklist)))
    (format "** %s\n" orgtrello/--checklist-name)))
</pre>
</div>
</div>
</li>

<li><a id="sec-5-4-7-7" name="sec-5-4-7-7"></a>orgtrello/&#x2013;compute-item-to-org-entry<br  /><div class="outline-text-5" id="text-5-4-7-7">
<p>
Given an entry which represents an item/task, compute its equivalent org format.
</p>

<div class="org-src-container">

<pre class="src src-lisp" id="orgtrello/-compute-item-to-org-entry">(defun orgtrello/--compute-item-to-org-entry (item)
  "Given a checklist item, compute its org-mode entry equivalence."
  (let* ((orgtrello/--item-name  (orgtrello-query/--name  item))
	 (orgtrello/--item-state (orgtrello-query/--state item)))
    (format "*** %s %s\n"
	    (if (string= "complete" orgtrello/--item-state) *DONE* *TODO*)
	    orgtrello/--item-name)))
</pre>
</div>
</div>
</li>

<li><a id="sec-5-4-7-8" name="sec-5-4-7-8"></a>orgtrello/&#x2013;compute-entity-to-org-entry<br  /><div class="outline-text-5" id="text-5-4-7-8">
<p>
Given an entry, determine according to its structure the nature of such entity:
</p>
<ul class="org-ul">
<li>list-id, it's a card
</li>
<li>card-id, it's a checklist
</li>
<li>state, it's an item/task
</li>
</ul>

<div class="org-src-container">

<pre class="src src-lisp" id="orgtrello/-compute-entity-to-org-entry">(defun orgtrello/--compute-entity-to-org-entry (entity)
  "Given an entity, compute its org representation."
  (cond ((orgtrello-query/--list-id entity) (orgtrello/--compute-card-to-org-entry entity))           ;; card      (level 1)
	((orgtrello-query/--card-id entity) (orgtrello/--compute-checklist-to-org-entry entity))      ;; checklist (level 2)
	((orgtrello-query/--state entity)  (orgtrello/--compute-item-to-org-entry entity))))          ;; items     (level 3)
</pre>
</div>
</div>
</li>

<li><a id="sec-5-4-7-9" name="sec-5-4-7-9"></a>orgtrello/&#x2013;do-retrieve-checklists-from-card<br  /><div class="outline-text-5" id="text-5-4-7-9">
<p>
Given a card, retrieve its full checklist and return a list composed of the card cons'ed to such entities.
</p>

<div class="org-src-container">

<pre class="src src-lisp" id="orgtrello/-do-retrieve-checklists-from-card">(defun orgtrello/--do-retrieve-checklists-from-card (card)
  "Given a card, return the list containing the card, the checklists from this card, and the items from the checklists. The order is guaranted."
  (cl-reduce
   (lambda (acc-list checklist-id)
     (let ((orgtrello/--checklist (orgtrello-query/http (orgtrello-api/get-checklist checklist-id) t)))
       (append (cons orgtrello/--checklist (orgtrello/--do-retrieve-checklists-and-items orgtrello/--checklist)) acc-list)))
   (orgtrello-query/--checklist-ids card)
   :initial-value nil))
</pre>
</div>
</div>
</li>

<li><a id="sec-5-4-7-10" name="sec-5-4-7-10"></a>orgtrello/&#x2013;do-retrieve-checklists-and-items<br  /><div class="outline-text-5" id="text-5-4-7-10">
<p>
Given a checklist, retrieve its full items/tasks and return a list composed of the checklist cons'ed to such entities.
</p>

<div class="org-src-container">

<pre class="src src-lisp" id="orgtrello/-do-retrieve-checklists-and-items">(defun orgtrello/--do-retrieve-checklists-and-items (checklist)
  "Given a checklist id, retrieve all the items from the checklist and return a list containing first the checklist, then the items."
  (--map it (orgtrello-query/--check-items checklist)))
</pre>
</div>
</div>
</li>

<li><a id="sec-5-4-7-11" name="sec-5-4-7-11"></a>orgtrello/&#x2013;compute-full-entities-from-trello<br  /><div class="outline-text-5" id="text-5-4-7-11">
<p>
Given a list of cards, retrieve the full arborescence of such cards (computing their checklists and items/tasks) and return a map of entities.
</p>

<div class="org-src-container">

<pre class="src src-lisp" id="orgtrello/-compute-full-entities-from-trello">(defun orgtrello/--compute-full-entities-from-trello (cards)
  "Given a list of cards, compute the full cards data from the trello boards. The order from the trello board is now kept."
  ;; will compute the hash-table of entities (id, entity)
  (cl-reduce
   (lambda (orgtrello/--acc-hash orgtrello/--entity-card)
     (message "Computing card '%s' data..." (orgtrello-query/--name orgtrello/--entity-card))
     ;; adding the entity card
     (puthash (orgtrello-query/--id orgtrello/--entity-card) orgtrello/--entity-card orgtrello/--acc-hash)
     ;; fill in the other remaining entities (checklist/items)
     (mapc
      (lambda (it)
	(puthash (orgtrello-query/--id it) it orgtrello/--acc-hash))
      (orgtrello/--do-retrieve-checklists-from-card orgtrello/--entity-card))
     orgtrello/--acc-hash)
   cards
   :initial-value (make-hash-table :test 'equal)))
</pre>
</div>
</div>
</li></ul>
</div>

<div id="outline-container-sec-5-4-8" class="outline-4">
<h4 id="sec-5-4-8">Delete entity</h4>
<div class="outline-text-4" id="text-5-4-8">
</div><ul class="org-ul"><li><a id="sec-5-4-8-1" name="sec-5-4-8-1"></a>orgtrello/do-delete-simple<br  /><div class="outline-text-5" id="text-5-4-8-1">
<p>
The main function to delete the current entity.
This checks if the id is present.
If not present, return an error message explaining the entity must be synced first.
Otherwise, execute the trello deletion.
Return a message of success.
</p>

<div class="org-src-container">

<pre class="src src-lisp" id="orgtrello/do-delete-simple">(defun orgtrello/do-delete-simple (&amp;optional sync)
  "Do the simple deletion of a card, checklist or task."
  (let* ((entry-metadata   (orgtrello-data/entry-get-full-metadata))
	 (current-metadata (gethash :current entry-metadata))
	 (id               (orgtrello/--id current-metadata)))
    (if (and current-metadata id)
	(let ((query-http-or-error-msg (orgtrello/--dispatch-delete (gethash :current entry-metadata) (gethash :parent entry-metadata))))
	  (if (hash-table-p query-http-or-error-msg)
	      (progn
		(orgtrello-query/http query-http-or-error-msg sync 'orgtrello-query/--delete-success-callback)
		"Delete entity done!")
	    query-http-or-error-msg))
      "Entity not synchronized on trello yet!")))
</pre>
</div>
</div>
</li>
<li><a id="sec-5-4-8-2" name="sec-5-4-8-2"></a>orgtrello/&#x2013;dispatch-map-delete<br  /><div class="outline-text-5" id="text-5-4-8-2">
<p>
The computation of the <b>MAP-DISPATCH-DELETE</b> which will be used to dispatch the deletion of an entity.
</p>

<div class="org-src-container">

<pre class="src src-lisp" id="orgtrello/-dispatch-map-delete">(defun orgtrello/--dispatch-map-delete ()
  "Dispatch map for the deletion of card/checklist/item."
  (let* ((dispatch-map (make-hash-table :test 'equal)))
    (puthash 1 'orgtrello/--card-delete      dispatch-map)
    (puthash 2 'orgtrello/--checklist-delete dispatch-map)
    (puthash 3 'orgtrello/--task-delete      dispatch-map)
    dispatch-map))

(defvar *MAP-DISPATCH-DELETE* (orgtrello/--dispatch-map-delete) "Dispatch map for the deletion query of card/checklist/task.")
</pre>
</div>
</div>
</li>

<li><a id="sec-5-4-8-3" name="sec-5-4-8-3"></a>orgtrello/&#x2013;dispatch-delete<br  /><div class="outline-text-5" id="text-5-4-8-3">
<p>
The actual entity deletion using the <b>MAP-DISPATCH-DELETE</b> as a dispatch function.
</p>

<div class="org-src-container">

<pre class="src src-lisp" id="orgtrello/-dispatch-delete">(defun orgtrello/--dispatch-delete (meta &amp;optional parent-meta)
  (let* ((level       (orgtrello/--level meta))
	 (dispatch-fn (gethash level *MAP-DISPATCH-DELETE* 'orgtrello/--too-deep-level)))
    (funcall dispatch-fn meta parent-meta)))
</pre>
</div>
</div>
</li>

<li><a id="sec-5-4-8-4" name="sec-5-4-8-4"></a>orgtrello/&#x2013;card-delete<br  /><div class="outline-text-5" id="text-5-4-8-4">
<p>
Specific card deletion request computation.
</p>

<div class="org-src-container">

<pre class="src src-lisp" id="orgtrello/-card-delete">(defun orgtrello/--card-delete (card-meta &amp;optional parent-meta)
  "Deal with the deletion query of a card"
  ;; parent is useless here
  (orgtrello-api/delete-card (orgtrello/--id card-meta)))
</pre>
</div>
</div>
</li>

<li><a id="sec-5-4-8-5" name="sec-5-4-8-5"></a>orgtrello/&#x2013;checklist-delete<br  /><div class="outline-text-5" id="text-5-4-8-5">
<p>
Specific checklist deletion request computation.
</p>

<div class="org-src-container">

<pre class="src src-lisp" id="orgtrello/-checklist-delete">(defun orgtrello/--checklist-delete (checklist-meta &amp;optional parent-meta)
  "Deal with the deletion query of a checklist"
  ;; parent is useless here
  (orgtrello-api/delete-checklist (orgtrello/--id checklist-meta)))
</pre>
</div>
</div>
</li>

<li><a id="sec-5-4-8-6" name="sec-5-4-8-6"></a>orgtrello/&#x2013;task-delete<br  /><div class="outline-text-5" id="text-5-4-8-6">
<p>
Specific task/item deletion request computation.
</p>

<div class="org-src-container">

<pre class="src src-lisp" id="orgtrello/-task-delete">(defun orgtrello/--task-delete (task-meta &amp;optional checklist-meta)
  "Deal with create/update task query build"
  (let* ((orgtrello/--task-id      (orgtrello/--id task-meta))
	 (orgtrello/--checklist-id (orgtrello/--id checklist-meta)))
    (orgtrello-api/delete-task orgtrello/--checklist-id orgtrello/--task-id)))
</pre>
</div>
</div>
</li></ul>
</div>

<div id="outline-container-sec-5-4-9" class="outline-4">
<h4 id="sec-5-4-9">Install key and token configuration</h4>
<div class="outline-text-4" id="text-5-4-9">
</div><ul class="org-ul"><li><a id="sec-5-4-9-1" name="sec-5-4-9-1"></a>orgtrello/do-install-key-and-token<br  /><div class="outline-text-5" id="text-5-4-9-1">
<p>
First routine to ask input for the user:
</p>
<ul class="org-ul">
<li>open the consumer key page for the user to retrieve his/her consumer key.
</li>
<li>then open the access token page to ask for the user to permit org-trello to act on her/his behalf.
</li>
<li>at last, generate the config.el file inside his/her home.
</li>
<li>return a successfull message
</li>
</ul>

<div class="org-src-container">

<pre class="src src-lisp" id="orgtrello/do-install-key-and-token">(defun orgtrello/do-install-key-and-token ()
  "Procedure to install the *consumer-key* and the token for the user in the config-file."
  (interactive)
  (browse-url "https://trello.com/1/appKey/generate")
  (let ((orgtrello/--*consumer-key* (read-string "*consumer-key*: ")))
    (browse-url (format "https://trello.com/1/authorize?response_type=token&amp;name=org-trello&amp;scope=read,write&amp;expiration=never&amp;key=%s" orgtrello/--*consumer-key*))
    (let ((orgtrello/--access-token (read-string "Access-token: ")))
      (orgtrello/--do-install-config-file orgtrello/--*consumer-key* orgtrello/--access-token)
      "Install key and read/write access token done!")))
</pre>
</div>
</div>
</li>

<li><a id="sec-5-4-9-2" name="sec-5-4-9-2"></a>orgtrello/&#x2013;do-install-config-file<br  /><div class="outline-text-5" id="text-5-4-9-2">
<p>
Given a consumer-key and an access token, generate a <i>config.el</i> file.
</p>

<div class="org-src-container">

<pre class="src src-lisp" id="orgtrello/-do-install-config-file">(defun orgtrello/--do-install-config-file (*consumer-key* *access-token*)
  "Persist the file config-file with the input of the user."
  (make-directory *CONFIG-DIR* t)
  (with-temp-file *CONFIG-FILE*
    (erase-buffer)
    (goto-char (point-min))
    (insert (format "(setq *consumer-key* \"%s\")\n" *consumer-key*))
    (insert (format "(setq *access-token* \"%s\")" *access-token*))
    (write-file *CONFIG-FILE* 't)))
</pre>
</div>
</div>
</li></ul>
</div>


<div id="outline-container-sec-5-4-10" class="outline-4">
<h4 id="sec-5-4-10">Install board and lists configuration</h4>
<div class="outline-text-4" id="text-5-4-10">
<p>
The install board and lists configuration. There is an alternative to such setup with the create board routine.
</p>
</div>

<ul class="org-ul"><li><a id="sec-5-4-10-1" name="sec-5-4-10-1"></a>orgtrello/do-install-board-and-lists<br  /><div class="outline-text-5" id="text-5-4-10-1">
<p>
Main routine to ask for the user's input to setup his/her board to attach to his/her current org buffer.
This:
</p>
<ul class="org-ul">
<li>generates a list of his/her current board from his/her trello's account.
</li>
<li>ask for the user to input which board he/she wants to use
</li>
<li>then generate the metadata regarding his/her choice to the org buffer's beginning
</li>
<li>return a message of success
</li>
</ul>

<div class="org-src-container">

<pre class="src src-lisp" id="orgtrello/do-install-board-and-lists">(defun orgtrello/do-install-board-and-lists ()
  "Interactive command to install the list boards"
  (interactive)
  (cl-destructuring-bind
      (orgtrello/--chosen-board-id orgtrello/--chosen-board-name) (-&gt; (orgtrello/--list-boards)
								      orgtrello/--id-name
								      orgtrello/--choose-board)
    (let ((orgtrello/--board-lists-hname-id (-&gt; orgtrello/--chosen-board-id
						orgtrello/--list-board-lists
						orgtrello/--name-id)))
      ;; remove any eventual present entry
      (orgtrello/--remove-properties-file orgtrello/--board-lists-hname-id t)
      ;; update with new ones
      (orgtrello/update-orgmode-file-with-properties
       orgtrello/--chosen-board-name
       orgtrello/--chosen-board-id
       orgtrello/--board-lists-hname-id
       t)))
  "Install board and list ids done!")
</pre>
</div>
</div>
</li>

<li><a id="sec-5-4-10-2" name="sec-5-4-10-2"></a>orgtrello/&#x2013;choose-board<br  /><div class="outline-text-5" id="text-5-4-10-2">
<p>
The routine that asks the user:
</p>
<ul class="org-ul">
<li>to select the board he/she wants to work with
</li>
<li>return the list of board id, board name
</li>
</ul>

<div class="org-src-container">

<pre class="src src-lisp" id="orgtrello/-choose-board">(defun orgtrello/--choose-board (boards)
  "Given a map of boards, display the possible boards for the user to choose which one he wants to work with."
  ;; ugliest ever
  (defvar orgtrello/--board-chosen nil)
  (setq orgtrello/--board-chosen nil)
  (let* ((str-key-val  "")
	 (i            0)
	 (i-id (make-hash-table :test 'equal)))
    (maphash (lambda (id name)
	       (setq str-key-val (format "%s%d: %s\n" str-key-val i name))
	       (puthash (format "%d" i) id i-id)
	       (setq i (+ 1 i)))
	     boards)
    (while (not (gethash orgtrello/--board-chosen i-id))
      (setq orgtrello/--board-chosen
	    (read-string (format "%s\nInput the number of the board desired: " str-key-val))))
    (let* ((orgtrello/--chosen-board-id   (gethash orgtrello/--board-chosen i-id))
	   (orgtrello/--chosen-board-name (gethash orgtrello/--chosen-board-id boards)))
      `(,orgtrello/--chosen-board-id ,orgtrello/--chosen-board-name))))
</pre>
</div>
</div>
</li>

<li><a id="sec-5-4-10-3" name="sec-5-4-10-3"></a>orgtrello/&#x2013;remove-properties-file<br  /><div class="outline-text-5" id="text-5-4-10-3">
<p>
Remove some file properties before applying new ones.
</p>

<div class="org-src-container">

<pre class="src src-lisp" id="orgtrello/-remove-properties-file">(defun orgtrello/--delete-buffer-property (property-name)
  "A simple routine to delete a #+property: entry from the org-mode buffer."
  (let ((current-point (search-forward property-name nil t)))
    (if current-point
	(progn
	  (goto-char current-point)
	  (beginning-of-line)
	  (kill-line)
	  (kill-line)))))

(defun orgtrello/--remove-properties-file (board-lists-hash-name-id &amp;optional update-todo-keywords)
  "Remove the current org-trello properties"
  (with-current-buffer (current-buffer)
    (goto-char (point-min))
    (orgtrello/--delete-buffer-property (format "#+property: %s" *BOARD-ID*))
    (orgtrello/--delete-buffer-property (format "#+property: %s" *BOARD-NAME*))
    (maphash
     (lambda (name id)
       (orgtrello/--delete-buffer-property (format "#+property: %s" (orgtrello/convention-property-name name))))
     board-lists-hash-name-id)
    (if update-todo-keywords
	(orgtrello/--delete-buffer-property "#+TODO: "))))
</pre>
</div>
</div>
</li>

<li><a id="sec-5-4-10-4" name="sec-5-4-10-4"></a>orgtrello/update-orgmode-file-with-properties<br  /><div class="outline-text-5" id="text-5-4-10-4">
<p>
Given a board name, board id, list of list ids, map of list names, insert such informations to the beginning of the org buffer.
Then save the buffer and restart org-mode.
</p>

<div class="org-src-container">

<pre class="src src-lisp" id="orgtrello/update-orgmode-file-with-properties">(defun orgtrello/update-orgmode-file-with-properties (board-name board-id board-lists-hash-name-id &amp;optional update-todo-keywords)
  "Update the orgmode file with the needed headers for org-trello to work."
  (with-current-buffer (current-buffer)
    (goto-char (point-min))
    ;; force utf-8
    (set-buffer-file-coding-system 'utf-8-auto)
    ;; install board-name and board-id
    (insert (format "#+property: %s    %s\n" *BOARD-NAME* board-name))
    (insert (format "#+property: %s      %s\n" *BOARD-ID* board-id))
    ;; install the other properties regarding the org keywords
    (maphash
     (lambda (name id)
       (insert (format "#+property: %s %s\n" (orgtrello/convention-property-name name) id)))
     board-lists-hash-name-id)
    (if update-todo-keywords
	(progn
	  ;; install the todo list
	  (insert "#+TODO: ")
	  (maphash (lambda (name _) (insert (concat (orgtrello/convention-property-name name) " "))) board-lists-hash-name-id)
	  (insert "\n")))
    ;; save the buffer
    (save-buffer)
    ;; restart org to make org-trello aware of the new setup
    (org-mode-restart)))
</pre>
</div>
</div>
</li>

<li><a id="sec-5-4-10-5" name="sec-5-4-10-5"></a>orgtrello/&#x2013;id-name<br  /><div class="outline-text-5" id="text-5-4-10-5">
<p>
Given a list of entities, return a map of (id . name)
</p>

<div class="org-src-container">

<pre class="src src-lisp" id="orgtrello/-id-name">(defun orgtrello/--id-name (entities)
  "Given a list of entities, return a map of (id, name)."
  (let* ((id-name (make-hash-table :test 'equal)))
    (mapc (lambda (it) (puthash (orgtrello-query/--id it) (orgtrello-query/--name it) id-name)) entities)
    id-name))
</pre>
</div>
</div>
</li>

<li><a id="sec-5-4-10-6" name="sec-5-4-10-6"></a>orgtrello/&#x2013;name-id<br  /><div class="outline-text-5" id="text-5-4-10-6">
<p>
Given a list of entities, return a map of (name . id)
</p>

<div class="org-src-container">

<pre class="src src-lisp" id="orgtrello/-name-id">(defun orgtrello/--name-id (entities)
  "Given a list of entities, return a map of (id, name)."
  (let* ((name-id (make-hash-table :test 'equal)))
    (mapc (lambda (it) (puthash (orgtrello-query/--name it) (orgtrello-query/--id it) name-id)) entities)
    name-id))
</pre>
</div>
</div>
</li>

<li><a id="sec-5-4-10-7" name="sec-5-4-10-7"></a>orgtrello/&#x2013;list-boards<br  /><div class="outline-text-5" id="text-5-4-10-7">
<p>
Execute the query that return a list of boards from the user's current trello account.
</p>

<div class="org-src-container">

<pre class="src src-lisp" id="orgtrello/-list-boards">(defun orgtrello/--list-boards ()
  "Return the map of the existing boards associated to the current account. (Synchronous request)"
  (cl-remove-if-not
   (lambda (board) (equal :json-false (orgtrello-query/--close-property board)))
   (orgtrello-query/http (orgtrello-api/get-boards) t)))
</pre>
</div>
</div>
</li>

<li><a id="sec-5-4-10-8" name="sec-5-4-10-8"></a>orgtrello/&#x2013;list-board-lists<br  /><div class="outline-text-5" id="text-5-4-10-8">
<p>
Execute the query that return a list of the board lists from the user's current trello account.
</p>

<div class="org-src-container">

<pre class="src src-lisp" id="orgtrello/-list-board-lists">(defun orgtrello/--list-board-lists (board-id)
  "Return the map of the existing list of the board with id board-id. (Synchronous request)"
  (orgtrello-query/http (orgtrello-api/get-lists board-id) t))
</pre>
</div>
</div>
</li>

<li><a id="sec-5-4-10-9" name="sec-5-4-10-9"></a>orgtrello/convention-property-name<br  /><div class="outline-text-5" id="text-5-4-10-9">
<p>
A function to help eventually decorate the name of the keywords.
Replace the space by dash at the moment.
</p>

<div class="org-src-container">

<pre class="src src-lisp" id="orgtrello/convention-property-name">(defun orgtrello/convention-property-name (name)
  "Use the right convention for the property used in the headers of the org-mode file."
  (replace-regexp-in-string " " "-" name))
</pre>
</div>
</div>
</li></ul>
</div>

<div id="outline-container-sec-5-4-11" class="outline-4">
<h4 id="sec-5-4-11">Create board</h4>
<div class="outline-text-4" id="text-5-4-11">
<p>
The main function regarding the creation of the board and the org attachment to such board.
</p>
</div>

<ul class="org-ul"><li><a id="sec-5-4-11-1" name="sec-5-4-11-1"></a>orgtrello/do-create-board-and-lists<br  /><div class="outline-text-5" id="text-5-4-11-1">
<p>
The main entry.
We will ask the user to:
</p>
<ul class="org-ul">
<li>input the name of the board he/she wants.
</li>
<li>input an optional board description
</li>
</ul>
<p>
Then launch the creation of the board.
This will:
</p>
<ul class="org-ul">
<li>create the board
</li>
<li>close the default lists created by trello
</li>
<li>create as much list as the user's keywords with the same name as the corresponding keywords.
</li>
<li>at last, update the beginning of the org buffer with the corresponding metadata:
<ul class="org-ul">
<li>board-name
</li>
<li>board-id
</li>
<li>list-id for all lists created
</li>
</ul>
</li>
</ul>

<div class="org-src-container">

<pre class="src src-lisp" id="orgtrello/do-create-board-and-lists">(defun orgtrello/do-create-board-and-lists ()
  "Interactive command to create a board and the lists"
  (interactive)
  (defvar orgtrello/--board-name nil)        (setq orgtrello/--board-name nil)
  (defvar orgtrello/--board-description nil) (setq orgtrello/--board-description nil)
  (while (not orgtrello/--board-name) (setq orgtrello/--board-name (read-string "Please, input the desired board name: ")))
  (setq orgtrello/--board-description (read-string "Please, input the board description (empty for none): "))
  (cl-destructuring-bind (orgtrello/--board-id orgtrello/--board-name) (orgtrello/--create-board orgtrello/--board-name orgtrello/--board-description)
			 (let* ((orgtrello/--board-list-ids       (--map (orgtrello-query/--id it) (orgtrello/--list-board-lists orgtrello/--board-id)))  ;; first retrieve the existing lists (created by default on trello)
				(orgtrello/--lists-to-close       (orgtrello/--close-lists orgtrello/--board-list-ids))                                ;; close those lists (they may surely not match the name we want)
				(orgtrello/--board-lists-hname-id (orgtrello/--create-lists-according-to-keywords orgtrello/--board-id *LIST-NAMES*))) ;; create the list, this returns the ids list
			   ;; remove eventual already present entry
			   (orgtrello/--remove-properties-file orgtrello/--board-lists-hname-id)
			   ;; update org buffer with new ones
			   (orgtrello/update-orgmode-file-with-properties orgtrello/--board-name orgtrello/--board-id orgtrello/--board-lists-hname-id)))
  "Create board and lists done!")

(message "org-trello - orgtrello loaded!")
</pre>
</div>
</div>
</li>
<li><a id="sec-5-4-11-2" name="sec-5-4-11-2"></a>orgtrello/&#x2013;create-board<br  /><div class="outline-text-5" id="text-5-4-11-2">
<p>
The actual board creation.
This return a list of board id, board name.
</p>

<div class="org-src-container">

<pre class="src src-lisp" id="orgtrello/-create-board">(defun orgtrello/--create-board (board-name &amp;optional board-description)
  "Create a board with name and eventually a description."
  (progn
    (message "Creating board '%s'" board-name)
    (let* ((board-data (orgtrello-query/http (orgtrello-api/add-board board-name board-description) t)))
      (list (orgtrello-query/--id board-data) (orgtrello-query/--name board-data)))))
</pre>
</div>
</div>
</li>

<li><a id="sec-5-4-11-3" name="sec-5-4-11-3"></a>orgtrello/&#x2013;close-lists<br  /><div class="outline-text-5" id="text-5-4-11-3">
<p>
The close list routine.
Given a list of list ids, close each of those list.
</p>

<div class="org-src-container">

<pre class="src src-lisp" id="orgtrello/-close-lists">(defun orgtrello/--close-lists (list-ids)
  "Given a list of ids, close those lists."
  (mapc (lambda (list-id)
	  (progn
	    (message "Closing default list with id %s" list-id)
	    (orgtrello-query/http (orgtrello-api/close-list list-id) nil nil 'simple-error-callback)))
	list-ids))
</pre>
</div>
</div>
</li>

<li><a id="sec-5-4-11-4" name="sec-5-4-11-4"></a>orgtrello/&#x2013;create-lists-according-to-keywords<br  /><div class="outline-text-5" id="text-5-4-11-4">
<p>
Create as much list as the keywords to the board <i>board-id</i>.
</p>

<div class="org-src-container">

<pre class="src src-lisp" id="orgtrello/-create-lists-according-to-keywords">(defun orgtrello/--create-lists-according-to-keywords (board-id list-keywords)
  "Given a list of names, build those lists on the trello boards. Return the hashmap (name, id) of the new lists created."
  (cl-reduce
   (lambda (acc-hash-name-id list-name)
     (progn
       (message "Board id %s - Creating list '%s'" board-id list-name)
       (puthash list-name (orgtrello-query/--id (orgtrello-query/http (orgtrello-api/add-list list-name board-id) t)) acc-hash-name-id)
       acc-hash-name-id))
   list-keywords
   :initial-value (make-hash-table :test 'equal)))
</pre>
</div>
</div>
</li></ul>
</div>

<div id="outline-container-sec-5-4-12" class="outline-4">
<h4 id="sec-5-4-12">Utility function</h4>
<div class="outline-text-4" id="text-5-4-12">
<p>
An utility decorator function to help in debugging without breakpoint.
This is mostly for user when we need them to help us remotely debug.
</p>

<div class="org-src-container">

<pre class="src src-lisp" id="trace">(defun trace (e &amp;optional label)
  "Decorator for some inaccessible code to easily 'message'."
  (progn
    (if label
	(message "TRACE: %s: %S" label e)
	(message "TRACE: %S" e))
    e))
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-sec-5-5" class="outline-3">
<h3 id="sec-5-5">orgtrello-query</h3>
<div class="outline-text-3" id="text-5-5">
<p>
Namespace in charge of the http request to the trello api.
</p>
</div>

<div id="outline-container-sec-5-5-1" class="outline-4">
<h4 id="sec-5-5-1">Namespace Setup</h4>
<div class="outline-text-4" id="text-5-5-1">
<p>
Static setup the user does not need to tinker with.
This resumes to only one variable which is the prefix url for the trello api access.
</p>

<div class="org-src-container">

<pre class="src src-lisp" id="orgtrello-query-setup">

;; #################### orgtrello-query/

(defvar *TRELLO-URL* "https://api.trello.com/1" "The needed prefix url for trello")
</pre>
</div>
</div>
</div>

<div id="outline-container-sec-5-5-2" class="outline-4">
<h4 id="sec-5-5-2">orgtrello-query/&#x2013;make-dispatch-http-query</h4>
<div class="outline-text-4" id="text-5-5-2">
<p>
As we do not have multi-methods (as in clojure), we tried to reproduce a similar behaviour.
This describes a function which will setup a map to dispatch on the method (:get, :post, :put, :delete) on the other function describes in the namespace).
</p>

<p>
This function is used only once to initialize the variable <b>MAP-DISPATCH-HTTP-QUERY</b>, which will be used later to dispatch on the http request built.
</p>

<div class="org-src-container">

<pre class="src src-lisp" id="orgtrello-query/-make-dispatch-http-query">(defun orgtrello-query/--make-dispatch-http-query ()
  "Make a map that will dispatch the function to call depending on the http verb :get, :put, :post, etc..."
  (let* ((map-dispatch (make-hash-table :test 'equal)))
    (puthash :get    'orgtrello-query/--get         map-dispatch)
    (puthash :put    'orgtrello-query/--post-or-put map-dispatch)
    (puthash :post   'orgtrello-query/--post-or-put map-dispatch)
    (puthash :delete 'orgtrello-query/--delete      map-dispatch)
    map-dispatch))

(defvar *MAP-DISPATCH-HTTP-QUERY* (orgtrello-query/--make-dispatch-http-query))
</pre>
</div>
</div>
</div>

<div id="outline-container-sec-5-5-3" class="outline-4">
<h4 id="sec-5-5-3">orgtrello-query/http</h4>
<div class="outline-text-4" id="text-5-5-3">
<p>
This is the main function from the namespace in charge of executing the http request.
We pass the query-map which is been built from the orgtrello-api namespace.
Optionally, we pass a:
</p>
<ul class="org-ul">
<li>success-callback in charge of doing some action when the request finishes successfully.
</li>
<li>error-callback in  charge of doing some action when the request finishes erroneously.
</li>
<li>sync flag to render the request synchronous (default is asynchronous)
</li>
</ul>

<div class="org-src-container">

<pre class="src src-lisp" id="orgtrello-query/http">(defun orgtrello-query/http (query-map &amp;optional sync success-callback error-callback)
  "Query the trello api asynchronously."
  (let* ((method      (gethash :method query-map))
	 (fn-dispatch (gethash method *MAP-DISPATCH-HTTP-QUERY*)))
    (if sync
	(progn ;; synchronous request
	  (puthash :sync t query-map)
	  (let ((request-response (funcall fn-dispatch query-map success-callback error-callback)))
	    (request-response-data request-response)))
      (funcall fn-dispatch query-map success-callback error-callback))))
</pre>
</div>
</div>
</div>

<div id="outline-container-sec-5-5-4" class="outline-4">
<h4 id="sec-5-5-4">orgtrello-query/&#x2013;map-dispatch-http-verb</h4>
<div class="outline-text-4" id="text-5-5-4">
<p>
As described earlier, no multi-method, we use the same techniques to setup a map to dispatch on the method (:get, :post, :put, :delete) to map to the request http client DSL.
This function is again called once.
</p>

<div class="org-src-container">

<pre class="src src-lisp" id="orgtrello-query/-map-dispatch-http-verb">(defun orgtrello-query/--map-dispatch-http-verb ()
  (let* ((map-dispatch (make-hash-table :test 'equal)))
    (puthash :get    "GET"    map-dispatch)
    (puthash :put    "PUT"    map-dispatch)
    (puthash :post   "POST"   map-dispatch)
    (puthash :delete "DELETE" map-dispatch)
    map-dispatch))

(defvar *MAP-DISPATCH-HTTP-VERB* (orgtrello-query/--map-dispatch-http-verb))
</pre>
</div>
</div>
</div>

<div id="outline-container-sec-5-5-5" class="outline-4">
<h4 id="sec-5-5-5">orgtrello-query/&#x2013;compute-method</h4>
<div class="outline-text-4" id="text-5-5-5">
<p>
Exploiting the dispatch map, we compute the http method (GET, POST, PUT, DELETE).
We could also have implemented this using simply cond.
</p>

<div class="org-src-container">

<pre class="src src-lisp" id="orgtrello-query/-compute-method">(defun orgtrello-query/--compute-method (method)
  "Given the keywords :get, :post, :put, :delete, map them into standard uppercase string."
  (gethash method *MAP-DISPATCH-HTTP-VERB*))
</pre>
</div>
</div>
</div>

<div id="outline-container-sec-5-5-6" class="outline-4">
<h4 id="sec-5-5-6">orgtrello-query/&#x2013;compute-url</h4>
<div class="outline-text-4" id="text-5-5-6">
<p>
A function to compute the full trello url given an uri.
</p>

<div class="org-src-container">

<pre class="src src-lisp" id="orgtrello-query/-compute-url">(defun orgtrello-query/--compute-url (uri)
  "Compute the trello url from the given uri."
  (format "%s%s" *TRELLO-URL* uri))
</pre>
</div>
</div>
</div>

<div id="outline-container-sec-5-5-7" class="outline-4">
<h4 id="sec-5-5-7">Input request abstraction extract functions</h4>
<div class="outline-text-4" id="text-5-5-7">
<p>
Some functions around the data stored in the query-map, hiding the implementation details of such query-map.
</p>
</div>

<ul class="org-ul"><li><a id="sec-5-5-7-1" name="sec-5-5-7-1"></a>orgtrello-query/&#x2013;method<br  /><div class="outline-text-5" id="text-5-5-7-1">
<p>
Extract the http method.
</p>

<div class="org-src-container">

<pre class="src src-lisp" id="orgtrello-query/-method">(defun orgtrello-query/--method (query-map)
  "Retrieve the http method"
  (gethash :method query-map))
</pre>
</div>
</div>
</li>

<li><a id="sec-5-5-7-2" name="sec-5-5-7-2"></a>orgtrello-query/&#x2013;uri<br  /><div class="outline-text-5" id="text-5-5-7-2">
<p>
Extract the trello api uri.
</p>

<div class="org-src-container">

<pre class="src src-lisp" id="orgtrello-query/-uri">(defun orgtrello-query/--uri (query-map)
  "Retrieve the http uri"
  (gethash :uri query-map))
</pre>
</div>
</div>
</li>

<li><a id="sec-5-5-7-3" name="sec-5-5-7-3"></a>orgtrello-query/&#x2013;sync<br  /><div class="outline-text-5" id="text-5-5-7-3">
<p>
Retrieve the flag sync or not of the query-map.
</p>

<div class="org-src-container">

<pre class="src src-lisp" id="orgtrello-query/-sync">(defun orgtrello-query/--sync (query-map)
  "Retrieve the http sync flag"
  (gethash :sync query-map))
</pre>
</div>
</div>
</li>

<li><a id="sec-5-5-7-4" name="sec-5-5-7-4"></a>orgtrello-query/&#x2013;params<br  /><div class="outline-text-5" id="text-5-5-7-4">
<p>
Retrieve the params of the query.
</p>

<div class="org-src-container">

<pre class="src src-lisp" id="orgtrello-query/-params">(defun orgtrello-query/--params (query-map)
  "Retrieve the http params"
  (gethash :params query-map))
</pre>
</div>
</div>
</li></ul>
</div>
<div id="outline-container-sec-5-5-8" class="outline-4">
<h4 id="sec-5-5-8">Output request abstraction extract function</h4>
<div class="outline-text-4" id="text-5-5-8">
<p>
Some functions around the data stored in the http query response, hiding the implementation details.
</p>
</div>
<ul class="org-ul"><li><a id="sec-5-5-8-1" name="sec-5-5-8-1"></a>orgtrello-query/&#x2013;id<br  /><div class="outline-text-5" id="text-5-5-8-1">
<p>
Extract the id of the entity from the entity-data.
</p>

<div class="org-src-container">

<pre class="src src-lisp" id="orgtrello-query/-id">(defun orgtrello-query/--id (entity-data)
  "Extract the id of the entity from the entity"
  (assoc-default 'id entity-data))
</pre>
</div>
</div>
</li>

<li><a id="sec-5-5-8-2" name="sec-5-5-8-2"></a>orgtrello-query/&#x2013;name<br  /><div class="outline-text-5" id="text-5-5-8-2">
<p>
Extract the name of the entity from the entity-data.
</p>

<div class="org-src-container">

<pre class="src src-lisp" id="orgtrello-query/-name">(defun orgtrello-query/--name (entity-data)
  "Extract the name of the entity from the entity"
  (assoc-default 'name entity-data))
</pre>
</div>
</div>
</li>

<li><a id="sec-5-5-8-3" name="sec-5-5-8-3"></a>orgtrello-query/&#x2013;list-id<br  /><div class="outline-text-5" id="text-5-5-8-3">
<p>
Extract the list identifier from the entity-data.
</p>

<div class="org-src-container">

<pre class="src src-lisp" id="orgtrello-query/-list-id">(defun orgtrello-query/--list-id (entity-data)
  "Extract the list identitier of the entity from the entity"
  (assoc-default 'idList entity-data))
</pre>
</div>
</div>
</li>

<li><a id="sec-5-5-8-4" name="sec-5-5-8-4"></a>orgtrello-query/&#x2013;checklist-ids<br  /><div class="outline-text-5" id="text-5-5-8-4">
<p>
Extract the list of checklist ids from the entity-data.
</p>

<div class="org-src-container">

<pre class="src src-lisp" id="orgtrello-query/-checklist-ids">(defun orgtrello-query/--checklist-ids (entity-data)
  "Extract the checklist identifier of the entity from the entity"
  (assoc-default 'idChecklists entity-data))
</pre>
</div>
</div>
</li>

<li><a id="sec-5-5-8-5" name="sec-5-5-8-5"></a>orgtrello-query/&#x2013;check-items<br  /><div class="outline-text-5" id="text-5-5-8-5">
<p>
Extract the list of items/tasks from the entity-data.
</p>

<div class="org-src-container">

<pre class="src src-lisp" id="orgtrello-query/-check-items">(defun orgtrello-query/--check-items (entity-data)
  "Extract the checklist identifier of the entity from the entity"
  (assoc-default 'checkItems entity-data))
</pre>
</div>
</div>
</li>

<li><a id="sec-5-5-8-6" name="sec-5-5-8-6"></a>orgtrello-query/&#x2013;card-id<br  /><div class="outline-text-5" id="text-5-5-8-6">
<p>
Extract the card id from the entity-data.
</p>

<div class="org-src-container">

<pre class="src src-lisp" id="orgtrello-query/-card-id">(defun orgtrello-query/--card-id (entity-data)
  "Extract the card identifier of the entity from the entity"
  (assoc-default 'idCard entity-data))
</pre>
</div>
</div>
</li>

<li><a id="sec-5-5-8-7" name="sec-5-5-8-7"></a>orgtrello-query/&#x2013;due<br  /><div class="outline-text-5" id="text-5-5-8-7">
<p>
Extract the card id from the entity-data.
</p>

<div class="org-src-container">

<pre class="src src-lisp" id="orgtrello-query/-due">(defun orgtrello-query/--due (entity-data)
  "Extract the due date of the entity from the query response"
  (assoc-default 'due entity-data))
</pre>
</div>
</div>
</li>

<li><a id="sec-5-5-8-8" name="sec-5-5-8-8"></a>orgtrello-query/&#x2013;state<br  /><div class="outline-text-5" id="text-5-5-8-8">
<p>
Extract the state from the entity-data.
</p>

<div class="org-src-container">

<pre class="src src-lisp" id="orgtrello-query/-state">(defun orgtrello-query/--state (entity-data)
  "Extract the state of the entity"
  (assoc-default 'state entity-data))
</pre>
</div>
</div>
</li>

<li><a id="sec-5-5-8-9" name="sec-5-5-8-9"></a>orgtrello-query/&#x2013;close-property<br  /><div class="outline-text-5" id="text-5-5-8-9">
<p>
Extract the close flag from the entity-data.
</p>

<div class="org-src-container">

<pre class="src src-lisp" id="orgtrello-query/-close-property">(defun orgtrello-query/--close-property (entity-data)
  "Extract the closed property of the entity"
  (assoc-default 'closed entity-data))
</pre>
</div>
</div>
</li></ul>
</div>

<div id="outline-container-sec-5-5-9" class="outline-4">
<h4 id="sec-5-5-9">HTTP request functions</h4>
<div class="outline-text-4" id="text-5-5-9">
<p>
Those represent the actual http actions.
They are closures on the trello identifier (consumer-key and access-token).
</p>
</div>

<ul class="org-ul"><li><a id="sec-5-5-9-1" name="sec-5-5-9-1"></a>orgtrello-query/&#x2013;get<br  /><div class="outline-text-5" id="text-5-5-9-1">
<p>
The function around the GET http request.
This will extract the method, uri and sync flag and build the http request.
This is a closure around the consumer-key and access-token.
The request's response is some json which will be parsed by the function 'json-read.
In case of optional success or error callback are passed, they will be used.
Otherwise, the 'standard-success-callback or the 'standard-error-callback will be used.
</p>

<div class="org-src-container">

<pre class="src src-lisp" id="orgtrello-query/-get">(defun orgtrello-query/--get (query-map &amp;optional success-callback error-callback)
  "GET"
  (let* ((method (orgtrello-query/--method query-map))
	 (uri    (orgtrello-query/--uri    query-map))
	 (sync   (orgtrello-query/--sync   query-map)))
    (request (orgtrello-query/--compute-url uri)
	     :sync    sync
	     :type    (orgtrello-query/--compute-method method)
	     :params  `((key . ,*consumer-key*)
			(token . ,*access-token*))
	     :parser  'json-read
	     :success (if success-callback success-callback 'standard-success-callback)
	     :error   (if error-callback error-callback 'standard-error-callback))))
</pre>
</div>
</div>
</li>

<li><a id="sec-5-5-9-2" name="sec-5-5-9-2"></a>orgtrello-query/&#x2013;post-or-put<br  /><div class="outline-text-5" id="text-5-5-9-2">
<p>
The function around the POST/PUT verbs.
This is similar to the get function but does some extract actions:
</p>
<ul class="org-ul">
<li>It extracts the params (which represents the needed information for the trello entity we will sync).
</li>
<li>It encodes the payload in json with the json-encode function
</li>
</ul>

<div class="org-src-container">

<pre class="src src-lisp" id="orgtrello-query/-post-or-put">(defun orgtrello-query/--post-or-put (query-map &amp;optional success-callback error-callback)
  "POST or PUT"
  (let* ((method  (orgtrello-query/--method query-map))
	 (uri     (orgtrello-query/--uri    query-map))
	 (payload (orgtrello-query/--params query-map))
	 (sync    (orgtrello-query/--sync   query-map)))
    (request (orgtrello-query/--compute-url uri)
	     :sync    sync
	     :type    (orgtrello-query/--compute-method method)
	     :params  `((key . ,*consumer-key*)
			(token . ,*access-token*))
	     :headers '(("Content-type" . "application/json"))
	     :data    (json-encode payload)
	     :parser  'json-read
	     :success (if success-callback success-callback 'standard-success-callback)
	     :error   (if error-callback error-callback 'standard-error-callback))))
</pre>
</div>
</div>
</li>

<li><a id="sec-5-5-9-3" name="sec-5-5-9-3"></a>orgtrello-query/&#x2013;delete<br  /><div class="outline-text-5" id="text-5-5-9-3">
<p>
The last verb we deal with, the DELETE action.
Again similar as GET but does a DELETE.
</p>

<div class="org-src-container">

<pre class="src src-lisp" id="orgtrello-query/-delete">(defun orgtrello-query/--delete (query-map &amp;optional success-callback error-callback)
  "DELETE"
  (let* ((method (orgtrello-query/--method query-map))
	 (uri    (orgtrello-query/--uri    query-map))
	 (sync   (orgtrello-query/--sync   query-map)))
    (request (orgtrello-query/--compute-url uri)
	     :sync    sync
	     :type    (orgtrello-query/--compute-method method)
	     :params  `((key . ,*consumer-key*)
			(token . ,*access-token*))
	     :success (if success-callback success-callback 'standard-success-callback)
	     :error   (if error-callback error-callback 'standard-error-callback))))

(message "org-trello - orgtrello-query/ loaded!")
</pre>
</div>
</div>
</li></ul>
</div>

<div id="outline-container-sec-5-5-10" class="outline-4">
<h4 id="sec-5-5-10">HTTP callbacks</h4>
<div class="outline-text-4" id="text-5-5-10">
<p>
Those are actions done at the end of the http request.
</p>
</div>

<ul class="org-ul"><li><a id="sec-5-5-10-1" name="sec-5-5-10-1"></a>standard-error-callback<br  /><div class="outline-text-5" id="text-5-5-10-1">
<p>
The standard error-callback in charge of removing the orgtrello-marker written before synchronization.
This display an error message on the minibuffer too.
</p>

<div class="org-src-container">

<pre class="src src-lisp" id="standard-error-callback">(cl-defun standard-error-callback (&amp;key error-thrown &amp;allow-other-keys)
  "Standard error callback"
  (save-excursion
      ;; find the current entry through the pointer
      (org-goto-local-search-headings *ORGTRELLO-MARKER* nil t)
      ;; remove the marker now that we're done
      (org-delete-property *ORGTRELLO-MARKER*))
  (message "There was some problem during the request to trello: %s" error-thrown))
</pre>
</div>
</div>
</li>

<li><a id="sec-5-5-10-2" name="sec-5-5-10-2"></a>standard-success-callback<br  /><div class="outline-text-5" id="text-5-5-10-2">
<p>
A standard success callback that displays a simple message "Success." in the minibuffer.
</p>

<div class="org-src-container">

<pre class="src src-lisp" id="standard-success-callback">(cl-defun standard-success-callback ()
  "Standard success callback"
  (message "Success."))
</pre>
</div>
</div>
</li>

<li><a id="sec-5-5-10-3" name="sec-5-5-10-3"></a>simple-error-callback<br  /><div class="outline-text-5" id="text-5-5-10-3">
<p>
A simpler error message callback which simply displays an error message on the minibuffer, indicating the error thrown by the execution of the request.
</p>

<div class="org-src-container">

<pre class="src src-lisp" id="simple-error-callback">(cl-defun simple-error-callback (&amp;key error-thrown &amp;allow-other-keys)
  "Standard error callback"
  (message "There was some problem during the request to trello: %s" error-thrown))
</pre>
</div>
</div>
</li>

<li><a id="sec-5-5-10-4" name="sec-5-5-10-4"></a>orgtrello-query/&#x2013;delete-success-callback<br  /><div class="outline-text-5" id="text-5-5-10-4">
<p>
This one is the default delete success callback.
It needs to synchronize back the buffer to remove the entry we just destroyed on trello.
</p>
<ul class="org-ul">
<li>Return to the heading we want to delete
</li>
<li>Delete the property which represents the trello identifier
</li>
<li>Remove the full entity (for this we hide the subtree)
</li>
<li>Go at the beginning of the line
</li>
<li>Kill the next 2 lines
</li>
<li>At last display a simple message to notify the end of the removal.
</li>
</ul>

<div class="org-src-container">

<pre class="src src-lisp" id="orgtrello-query/-delete-success-callback">(cl-defun orgtrello-query/--delete-success-callback (&amp;key data response &amp;allow-other-keys)
  "Callback function called at the end of a successful delete request."
  (progn
    (org-back-to-heading t)
    (org-delete-property *ORGTRELLO-ID*)
    (hide-subtree)
    (beginning-of-line)
    (kill-line)
    (kill-line)
    (message "Entity deleted!")))
</pre>
</div>
</div>
</li>

<li><a id="sec-5-5-10-5" name="sec-5-5-10-5"></a>orgtrello-query/&#x2013;post-put-success-callback-update-id<br  /><div class="outline-text-5" id="text-5-5-10-5">
<p>
This one is the default post/put success callback.
It's in charge of updating the org buffer with the trello id for the entity that has been synchronized.
What it does:
</p>
<ul class="org-ul">
<li>Get back to the current max header
</li>
<li>Then place itself to the org-trello marker put at the beginning of the synchronization.
</li>
<li>Remove such marker
</li>
<li>Get the current header information
</li>
<li>If an identifier is already present, simply display a message. Otherwise, add the property orgtrello-id with the identifier returned by the query.
</li>
</ul>

<div class="org-src-container">

<pre class="src src-lisp" id="orgtrello-query/-post-put-success-callback-update-id">(cl-defun orgtrello-query/--post-put-success-callback-update-id (&amp;key data &amp;allow-other-keys)
  "Called back function at the end of the post/put request to update the trello id in the org-mode file."
  (let* ((orgtrello-query/--entry-new-id (orgtrello-query/--id data))
	 (orgtrello-query/--entry-name   (orgtrello-query/--name data)))
    ;; will update via tag the trello id of the new persisted data (if needed)
    (save-excursion
      ;;(while (org-up-heading-safe))
      ;; find the current entry through the pointer
      (org-goto-local-search-headings *ORGTRELLO-MARKER* nil t)
      ;; remove the marker now that we're done
      (org-delete-property *ORGTRELLO-MARKER*)
      ;; now we extract the data
      (let* ((orgtrello-query/--entry-metadata (orgtrello-data/metadata))
	     (orgtrello-query/--entry-id       (orgtrello/--id orgtrello-query/--entry-metadata)))
	(if orgtrello-query/--entry-id ;; id already present in the org-mode file
	    ;; no need to add another
	    (message "Entity '%s' synced with id '%s'" orgtrello-query/--entry-name orgtrello-query/--entry-id)
	  (progn
	    ;; not present, this was just created, we add a simple property
	    (org-set-property *ORGTRELLO-ID* orgtrello-query/--entry-new-id)
	    (message "Newly entity '%s' synced with id '%s'" orgtrello-query/--entry-name orgtrello-query/--entry-new-id)))))))
</pre>
</div>
</div>
</li></ul>
</div>
</div>

<div id="outline-container-sec-5-6" class="outline-3">
<h3 id="sec-5-6">orgtrello-api</h3>
<div class="outline-text-3" id="text-5-6">
<p>
This is the namespace responsible for the interface with trello's public api.
We have decoupled the http request from the http request data structure.
This way, we can test the api's request.
</p>
</div>

<div id="outline-container-sec-5-6-1" class="outline-4">
<h4 id="sec-5-6-1">orgtrello-api/add-board</h4>
<div class="outline-text-4" id="text-5-6-1">
<p>
A simple function to create a board.
We need a name and an optional description.
</p>

<div class="org-src-container">

<pre class="src src-lisp" id="orgtrello-api/add-board">

;; #################### orgtrello-api

(defun orgtrello-api/add-board (name &amp;optional description)
  "Create a board"
  (let* ((payload (if description
		      `(("name" . ,name)
			("desc" . ,description))
		    `(("name" . ,name)))))
    (orgtrello-hash/make-hash :post "/boards" payload)))
</pre>
</div>
</div>
</div>

<div id="outline-container-sec-5-6-2" class="outline-4">
<h4 id="sec-5-6-2">orgtrello-api/get-boards</h4>
<div class="outline-text-4" id="text-5-6-2">
<p>
A function to retrieve the list of boards of the user.
</p>

<div class="org-src-container">

<pre class="src src-lisp" id="orgtrello-api/get-boards">(defun orgtrello-api/get-boards ()
  "Retrieve the boards of the current user."
  (orgtrello-hash/make-hash :get "/members/me/boards"))
</pre>
</div>
</div>
</div>

<div id="outline-container-sec-5-6-3" class="outline-4">
<h4 id="sec-5-6-3">orgtrello-api/get-board</h4>
<div class="outline-text-4" id="text-5-6-3">
<p>
A function to retrieve all the information about the board with id.
</p>

<div class="org-src-container">

<pre class="src src-lisp" id="orgtrello-api/get-board">(defun orgtrello-api/get-board (id)
  "Retrieve the boards of the current user."
  (orgtrello-hash/make-hash :get (format "/boards/%s" id)))
</pre>
</div>
</div>
</div>

<div id="outline-container-sec-5-6-4" class="outline-4">
<h4 id="sec-5-6-4">orgtrello-api/get-cards</h4>
<div class="outline-text-4" id="text-5-6-4">
<p>
Retrieve all the cards from the board with id board-id.
</p>

<div class="org-src-container">

<pre class="src src-lisp" id="orgtrello-api/get-cards">(defun orgtrello-api/get-cards (board-id)
  "cards of a board"
  (orgtrello-hash/make-hash :get (format "/boards/%s/cards" board-id)))
</pre>
</div>
</div>
</div>

<div id="outline-container-sec-5-6-5" class="outline-4">
<h4 id="sec-5-6-5">orgtrello-api/get-card</h4>
<div class="outline-text-4" id="text-5-6-5">
<p>
Retrieve the information of the specific card with id card-id.
</p>

<div class="org-src-container">

<pre class="src src-lisp" id="orgtrello-api/get-card">(defun orgtrello-api/get-card (card-id)
  "Detail of a card with id card-id."
  (orgtrello-hash/make-hash :get (format "/cards/%s" card-id)))
</pre>
</div>
</div>
</div>

<div id="outline-container-sec-5-6-6" class="outline-4">
<h4 id="sec-5-6-6">orgtrello-api/delete-card</h4>
<div class="outline-text-4" id="text-5-6-6">
<p>
Delete the card with id card-id.
</p>

<div class="org-src-container">

<pre class="src src-lisp" id="orgtrello-api/delete-card">(defun orgtrello-api/delete-card (card-id)
  "Delete a card with id card-id."
  (orgtrello-hash/make-hash :delete (format "/cards/%s" card-id)))
</pre>
</div>
</div>
</div>

<div id="outline-container-sec-5-6-7" class="outline-4">
<h4 id="sec-5-6-7">orgtrello-api/get-lists</h4>
<div class="outline-text-4" id="text-5-6-7">
<p>
Retrieve the lists of the board with id board-id.
</p>

<div class="org-src-container">

<pre class="src src-lisp" id="orgtrello-api/get-lists">(defun orgtrello-api/get-lists (board-id)
  "Display the lists of the board"
  (orgtrello-hash/make-hash :get (format "/boards/%s/lists" board-id)))
</pre>
</div>
</div>
</div>

<div id="outline-container-sec-5-6-8" class="outline-4">
<h4 id="sec-5-6-8">orgtrello-api/close-list</h4>
<div class="outline-text-4" id="text-5-6-8">
<p>
We need a routine to be able to close a list (typically when we create a board, we do not want the default list created by trello).
So a function to close a specific list with id list-id.
</p>

<div class="org-src-container">

<pre class="src src-lisp" id="orgtrello-api/close-list">(defun orgtrello-api/close-list (list-id)
  "'Close' the list with id list-id."
  (orgtrello-hash/make-hash :put (format "/lists/%s/closed" list-id) '((value . t))))
</pre>
</div>
</div>
</div>

<div id="outline-container-sec-5-6-9" class="outline-4">
<h4 id="sec-5-6-9">orgtrello-api/get-list</h4>
<div class="outline-text-4" id="text-5-6-9">
<p>
Retrieve the information about the list with id list-id.
</p>
<div class="org-src-container">

<pre class="src src-lisp" id="orgtrello-api/get-list">(defun orgtrello-api/get-list (list-id)
  "Get a list by id"
  (orgtrello-hash/make-hash :get (format "/lists/%s" list-id)))
</pre>
</div>
</div>
</div>

<div id="outline-container-sec-5-6-10" class="outline-4">
<h4 id="sec-5-6-10">orgtrello-api/add-list</h4>
<div class="outline-text-4" id="text-5-6-10">
<p>
Adding a list named <i>name</i> to a board with id <i>idBoard</i>.
</p>

<div class="org-src-container">

<pre class="src src-lisp" id="orgtrello-api/add-list">(defun orgtrello-api/add-list (name idBoard)
  "Add a list - the name and the board id are mandatory (so i say!)."
  (orgtrello-hash/make-hash :post "/lists/" `(("name" . ,name) ("idBoard" . ,idBoard))))
</pre>
</div>
</div>
</div>

<div id="outline-container-sec-5-6-11" class="outline-4">
<h4 id="sec-5-6-11">orgtrello-api/add-card</h4>
<div class="outline-text-4" id="text-5-6-11">
<p>
Adding a card with name <i>name</i> to the list idList.
Optionally, we can use a due date.
</p>

<div class="org-src-container">

<pre class="src src-lisp" id="orgtrello-api/add-card">(defun orgtrello-api/add-card (name idList &amp;optional due)
  "Add a card to a board"
  (let* ((orgtrello-api/add-card--default-params `(("name" . ,name) ("idList" . ,idList)))
	 (orgtrello-api/add-card--params (if due (cons `("due" . ,due) orgtrello-api/add-card--default-params) orgtrello-api/add-card--default-params)))
    (orgtrello-hash/make-hash :post "/cards/" orgtrello-api/add-card--params)))
</pre>
</div>
</div>
</div>

<div id="outline-container-sec-5-6-12" class="outline-4">
<h4 id="sec-5-6-12">orgtrello-api/get-cards-from-list</h4>
<div class="outline-text-4" id="text-5-6-12">
<p>
A function to retrieve the full list of cards a list with id <i>list-id</i> owns.
</p>

<div class="org-src-container">

<pre class="src src-lisp" id="orgtrello-api/get-cards-from-list">(defun orgtrello-api/get-cards-from-list (list-id)
  "List all the cards"
  (orgtrello-hash/make-hash :get (format "/lists/%s/cards" list-id)))
</pre>
</div>
</div>
</div>

<div id="outline-container-sec-5-6-13" class="outline-4">
<h4 id="sec-5-6-13">orgtrello-api/move-card</h4>
<div class="outline-text-4" id="text-5-6-13">
<p>
An update function for the card card-id which belongs to the idList.
This can simply move the card from its current list to another.
Optionally, we can rename the card to <i>name</i> and update its <i>due</i> date.
</p>

<div class="org-src-container">

<pre class="src src-lisp" id="orgtrello-api/move-card">(defun orgtrello-api/move-card (card-id idList &amp;optional name due)
  "Move a card to another list"
  (let* ((orgtrello-api/move-card--default-params `(("idList" . ,idList)))
	 (orgtrello-api/move-card--params-name (if name (cons `("name" . ,name) orgtrello-api/move-card--default-params) orgtrello-api/move-card--default-params))
	 (orgtrello-api/move-card--params-due  (if due (cons `("due" . ,due) orgtrello-api/move-card--params-name) orgtrello-api/move-card--params-name)))
    (orgtrello-hash/make-hash :put (format "/cards/%s" card-id) orgtrello-api/move-card--params-due)))
</pre>
</div>
</div>
</div>

<div id="outline-container-sec-5-6-14" class="outline-4">
<h4 id="sec-5-6-14">orgtrello-api/add-checklist</h4>
<div class="outline-text-4" id="text-5-6-14">
<p>
We can add a checklist entitled <i>name</i> to the card with id <i>card-id</i>.
</p>

<div class="org-src-container">

<pre class="src src-lisp" id="orgtrello-api/add-checklist">(defun orgtrello-api/add-checklist (card-id name)
  "Add a checklist to a card"
  (orgtrello-hash/make-hash :post
	     (format "/cards/%s/checklists" card-id)
	     `(("name" . ,name))))
</pre>
</div>
</div>
</div>

<div id="outline-container-sec-5-6-15" class="outline-4">
<h4 id="sec-5-6-15">orgtrello-api/update-checklist</h4>
<div class="outline-text-4" id="text-5-6-15">
<p>
Also, we can update the checklist with id <i>checklist-id</i> to a new name <i>name</i>.
</p>

<div class="org-src-container">

<pre class="src src-lisp" id="orgtrello-api/update-checklist">(defun orgtrello-api/update-checklist (checklist-id name)
  "Update the checklist's name"
  (orgtrello-hash/make-hash :put
	     (format "/checklists/%s" checklist-id)
	     `(("name" . ,name))))
</pre>
</div>
</div>
</div>

<div id="outline-container-sec-5-6-16" class="outline-4">
<h4 id="sec-5-6-16">orgtrello-api/get-checklists</h4>
<div class="outline-text-4" id="text-5-6-16">
<p>
Retrieve the list of checklist from the card with id <i>card-id</i>.
</p>

<div class="org-src-container">

<pre class="src src-lisp" id="orgtrello-api/get-checklists">(defun orgtrello-api/get-checklists (card-id)
  "List the checklists of a card"
  (orgtrello-hash/make-hash :get (format "/cards/%s/checklists" card-id)))
</pre>
</div>
</div>
</div>

<div id="outline-container-sec-5-6-17" class="outline-4">
<h4 id="sec-5-6-17">orgtrello-api/get-checklist</h4>
<div class="outline-text-4" id="text-5-6-17">
<p>
Or simply retrieve the detail about the checklist with id <i>checklist-id</i>.
</p>

<div class="org-src-container">

<pre class="src src-lisp" id="orgtrello-api/get-checklist">(defun orgtrello-api/get-checklist (checklist-id)
  "Retrieve all the information from a checklist"
  (orgtrello-hash/make-hash :get (format "/checklists/%s" checklist-id)))
</pre>
</div>
</div>
</div>

<div id="outline-container-sec-5-6-18" class="outline-4">
<h4 id="sec-5-6-18">orgtrello-api/delete-checklist</h4>
<div class="outline-text-4" id="text-5-6-18">
<p>
We need to be able to remove checklist <i>checklist-id</i>.
</p>

<div class="org-src-container">

<pre class="src src-lisp" id="orgtrello-api/delete-checklist">(defun orgtrello-api/delete-checklist (checklist-id)
  "Delete a checklist with checklist-id"
  (orgtrello-hash/make-hash :delete (format "/checklists/%s" checklist-id)))
</pre>
</div>
</div>
</div>

<div id="outline-container-sec-5-6-19" class="outline-4">
<h4 id="sec-5-6-19">orgtrello-api/add-tasks</h4>
<div class="outline-text-4" id="text-5-6-19">
<p>
Adding a task/item entitled <i>name</i> to the checklist <i>checklist-id</i> with an optional <i>checked</i> state.
</p>

<div class="org-src-container">

<pre class="src src-lisp" id="orgtrello-api/add-tasks">(defun orgtrello-api/add-tasks (checklist-id name &amp;optional checked)
  "Add todo tasks (trello items) to a checklist with id 'id'"
  (let* ((payload (if checked
		      `(("name"  . ,name) ("checked" . ,checked))
		    `(("name" . ,name)))))
    (orgtrello-hash/make-hash :post (format "/checklists/%s/checkItems" checklist-id) payload)))
</pre>
</div>
</div>
</div>

<div id="outline-container-sec-5-6-20" class="outline-4">
<h4 id="sec-5-6-20">orgtrello-api/update-task</h4>
<div class="outline-text-4" id="text-5-6-20">
<p>
A function to deal with the update of the task/item with id <i>task-id</i> and name <i>name</i> from the checklist <i>checklist-id</i> (trello api forces the <i>card</i>-id too).
Optionally, we can change its checked <i>state</i>.
</p>

<div class="org-src-container">

<pre class="src src-lisp" id="orgtrello-api/update-task">(defun orgtrello-api/update-task (card-id checklist-id task-id name &amp;optional state)
  "Update a task"
  (let* ((payload (if state
		      `(("name"  . ,name) ("state" . ,state))
		    `(("name" . ,name)))))
    (orgtrello-hash/make-hash
     :put
     (format "/cards/%s/checklist/%s/checkItem/%s" card-id checklist-id task-id)
     payload)))
</pre>
</div>
</div>
</div>

<div id="outline-container-sec-5-6-21" class="outline-4">
<h4 id="sec-5-6-21">orgtrello-api/get-tasks</h4>
<div class="outline-text-4" id="text-5-6-21">
<p>
Retrieve the list of tasks from the checklist <i>checklist-id</i>.
</p>

<div class="org-src-container">

<pre class="src src-lisp" id="orgtrello-api/get-tasks">(defun orgtrello-api/get-tasks (checklist-id)
  "List the checklist items."
    (orgtrello-hash/make-hash :get (format "/checklists/%s/checkItems/" checklist-id)))
</pre>
</div>
</div>
</div>

<div id="outline-container-sec-5-6-22" class="outline-4">
<h4 id="sec-5-6-22">orgtrello-api/delete-task</h4>
<div class="outline-text-4" id="text-5-6-22">
<p>
To keep the symmetry with the other entities, we need to be able to destroy the task/item <i>task-id</i> from the checklist <i>checklist-id</i>.
</p>

<div class="org-src-container">

<pre class="src src-lisp" id="orgtrello-api/delete-task">(defun orgtrello-api/delete-task (checklist-id task-id)
  "Delete a task with id task-id"
  (orgtrello-hash/make-hash :delete (format "/checklists/%s/checkItems/%s" checklist-id task-id)))

(message "org-trello - orgtrello-api loaded!")
</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-sec-5-7" class="outline-3">
<h3 id="sec-5-7">orgtrello-data</h3>
<div class="outline-text-3" id="text-5-7">
<p>
Namespace in charge of manipulating/extracting the org buffer's data.
</p>
</div>

<div id="outline-container-sec-5-7-1" class="outline-4">
<h4 id="sec-5-7-1">orgtrello-data/&#x2013;convert-orgmode-date-to-trello-date</h4>
<div class="outline-text-4" id="text-5-7-1">
<p>
A simple function to help in transforming the org format used in deadline into trello format.
This is really basic.
We must improve this.
</p>

<div class="org-src-container">

<pre class="src src-lisp" id="orgtrello-data/-convert-orgmode-date-to-trello-date">

;; #################### orgtrello-data

(defvar *ORGTRELLO-ID* "orgtrello-id" "Marker used for the trello identifier")

(defun orgtrello-data/--convert-orgmode-date-to-trello-date (orgmode-date)
  "Convert the org-mode deadline into a time adapted for trello."
  (if (and orgmode-date (not (string-match-p "T*Z" orgmode-date)))
      (cl-destructuring-bind (sec min hour day mon year dow dst tz)
			     (--map (if it
					(if (&lt; it 10)
					    (concat "0" (int-to-string it))
					  (int-to-string it)))
				    (parse-time-string orgmode-date))
			     (let* ((year-mon-day (concat year "-" mon "-" day "T"))
				    (hour-min-sec (if hour (concat hour ":" min ":" sec) "00:00:00")))
			       (concat year-mon-day hour-min-sec ".000Z")))
    orgmode-date))
</pre>
</div>
</div>
</div>

<div id="outline-container-sec-5-7-2" class="outline-4">
<h4 id="sec-5-7-2">orgtrello-data/metadata</h4>
<div class="outline-text-4" id="text-5-7-2">
<p>
This is an important routine which will extract all the informations from the org buffer for a given entity (typically the entity under the caret's current position):
</p>
<ul class="org-ul">
<li>level
</li>
<li>label
</li>
<li>id
</li>
<li>due
</li>
</ul>
<p>
This uses org's api and add some extra information specific to org-trello.
</p>

<div class="org-src-container">

<pre class="src src-lisp" id="orgtrello-data/metadata">(defun orgtrello-data/metadata ()
  "Compute the metadata from the org-heading-components entry, add the identifier and extract the metadata needed."
  (let* ((orgtrello-data/metadata--id       (org-entry-get (point) *ORGTRELLO-ID*))
	 (orgtrello-data/metadata--due      (orgtrello-data/--convert-orgmode-date-to-trello-date (org-entry-get (point) "DEADLINE")))
	 (orgtrello-data/metadata--metadata (org-heading-components)))
    (-&gt;&gt; orgtrello-data/metadata--metadata
	 (cons orgtrello-data/metadata--due)
	 (cons orgtrello-data/metadata--id)
	 orgtrello-data/--get-metadata)))
</pre>
</div>
</div>
</div>

<div id="outline-container-sec-5-7-3" class="outline-4">
<h4 id="sec-5-7-3">orgtrello-data/&#x2013;parent-metadata</h4>
<div class="outline-text-4" id="text-5-7-3">
<p>
This function permits to retrieve the metadata of the current entry.
Note that if we are to the upper level already, this will return the exact same data as the current entry.
</p>

<div class="org-src-container">

<pre class="src src-lisp" id="orgtrello-data/-parent-metadata">(defun orgtrello-data/--parent-metadata ()
  "Extract the metadata from the current heading's parent."
  (save-excursion
    (org-up-heading-safe)
    (orgtrello-data/metadata)))
</pre>
</div>
</div>
</div>

<div id="outline-container-sec-5-7-4" class="outline-4">
<h4 id="sec-5-7-4">orgtrello-data/&#x2013;grandparent-metadata</h4>
<div class="outline-text-4" id="text-5-7-4">
<p>
Again, from a current entry, return the metadata of the grand-parent entry.
Note again that if we are to the upper level, the same data as the current entry will be returned.
</p>

<div class="org-src-container">

<pre class="src src-lisp" id="orgtrello-data/-grandparent-metadata">(defun orgtrello-data/--grandparent-metadata ()
  "Extract the metadata from the current heading's grandparent."
  (save-excursion
    (org-up-heading-safe)
    (org-up-heading-safe)
    (orgtrello-data/metadata)))
</pre>
</div>
</div>
</div>

<div id="outline-container-sec-5-7-5" class="outline-4">
<h4 id="sec-5-7-5">orgtrello-data/entry-get-full-metadata</h4>
<div class="outline-text-4" id="text-5-7-5">
<p>
This is an orchestration from the previous functions.
This will return a map with as key:
</p>
<ul class="org-ul">
<li>:current     the current entity under the caret's position
</li>
<li>:parent      the current entity's parent
</li>
<li>:grandparent the current entity's grandparent
</li>
</ul>

<p>
If the level of the current entity exceeds level 4, the entry is dismissed (only 3 levels can be compatible in trello) so the function will return nil.
</p>

<div class="org-src-container">

<pre class="src src-lisp" id="orgtrello-data/entry-get-full-metadata">(defun orgtrello-data/entry-get-full-metadata ()
  "Compute the metadata needed for one entry into a map with keys :current, :parent, :grandparent.
   Returns nil if the level is superior to 4."
  (let* ((heading (orgtrello-data/metadata))
	 (level   (gethash :level heading)))
    (if (&lt; level 4)
	(let* ((parent-heading      (orgtrello-data/--parent-metadata))
	       (grandparent-heading (orgtrello-data/--grandparent-metadata))
	       (mapdata (make-hash-table :test 'equal)))
	  ;; build the metadata with every important pieces
	  (puthash :current     heading             mapdata)
	  (puthash :parent      parent-heading      mapdata)
	  (puthash :grandparent grandparent-heading mapdata)
	  mapdata))))
</pre>
</div>
</div>
</div>

<div id="outline-container-sec-5-7-6" class="outline-4">
<h4 id="sec-5-7-6">orgtrello-data/&#x2013;get-metadata</h4>
<div class="outline-text-4" id="text-5-7-6">
<p>
An adapter function to transform any org data into org-trello data.
</p>

<div class="org-src-container">

<pre class="src src-lisp" id="orgtrello-data/-get-metadata">(defun orgtrello-data/--get-metadata (heading-metadata)
  "Given the heading-metadata returned by the function 'org-heading-components, make it a hashmap with key :level, :keyword, :title. and their respective value"
  (cl-destructuring-bind (id due level _ keyword _ title &amp;rest) heading-metadata
			 (orgtrello-hash/make-hash-org level keyword title id due)))

(message "org-trello - orgtrello-data loaded!")
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-sec-5-8" class="outline-3">
<h3 id="sec-5-8">orgtrello-hash</h3>
<div class="outline-text-3" id="text-5-8">
<p>
Utility namespace in charge of simplifying the construction of org-trello data.
</p>
</div>

<div id="outline-container-sec-5-8-1" class="outline-4">
<h4 id="sec-5-8-1">orgtrello-hash/make-hash-org</h4>
<div class="outline-text-4" id="text-5-8-1">
<p>
A simple factory function to create a map from the needed org entity data.
</p>
<div class="org-src-container">

<pre class="src src-lisp" id="orgtrello-hash/make-hash-org">

;; #################### orgtrello-hash

(defun orgtrello-hash/make-hash-org (level keyword title id due)
  "Utility function to ease the creation of the orgtrello-metadata"
  (let ((h (make-hash-table :test 'equal)))
    (puthash :level   level   h)
    (puthash :keyword keyword h)
    (puthash :title   title   h)
    (puthash :id      id      h)
    (puthash :due     due     h)
    h))
</pre>
</div>
</div>
</div>

<div id="outline-container-sec-5-8-2" class="outline-4">
<h4 id="sec-5-8-2">orgtrello-hash/make-hash</h4>
<div class="outline-text-4" id="text-5-8-2">
<p>
A simple utility function to help in creating the http request map to feed to the orgtrello-query namespace.
</p>

<div class="org-src-container">

<pre class="src src-lisp" id="orgtrello-hash/make-hash">(defun orgtrello-hash/make-hash (method uri &amp;optional params)
  "Utility function to ease the creation of the map - wait, where are my clojure data again!?"
  (let ((h (make-hash-table :test 'equal)))
    (puthash :method method h)
    (puthash :uri    uri    h)
    (if params (puthash :params params h))
    h))

(message "org-trello - orgtrello-hash loaded!")
</pre>
</div>
</div>
</div>
</div>
</div>

<div id="outline-container-sec-6" class="outline-2">
<h2 id="sec-6">Resulting</h2>
<div class="outline-text-2" id="text-6">
<p>
Now let's generate the full code.
</p>
</div>
</div>

<div id="outline-container-sec-7" class="outline-2">
<h2 id="sec-7">Source</h2>
<div class="outline-text-2" id="text-7">
<p>
Project: <a href="http://ardumont.github.io/org-trello/">http://ardumont.github.io/org-trello/</a>
source: <a href="https://github.com/org-trello/org-trello/blob/master/org-trello.org">org-trello.org</a>
</p>
</div>
</div>
</div>
<div id="postamble" class="status">
<p class="date">Date: <span class="timestamp-wrapper"><span class="timestamp">[2013-08-11 dim. 14:28]</span></span></p>
<p class="author">Author: Antoine R. Dumont</p>
<p class="date">Created: 2014-12-01 Mon 23:44</p>
<p class="creator"><a href="http://www.gnu.org/software/emacs/">Emacs</a> 24.4.1 (<a href="http://orgmode.org">Org</a> mode 8.2.10)</p>
<p class="validation"><a href="http://validator.w3.org/check?uri=referer">Validate</a></p>
</div>
</body>
</html>
