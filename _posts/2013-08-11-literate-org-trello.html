---
date: 2013-08-11 14:28
author: Antoine R. Dumont
title: Literate org-trello
layout: post
categories: 
- literate-programming
- org-mode
- org-trello
- emacs
- emacs-lisp
tags: 
- literate-programming
- org-mode
- org-trello
- emacs
- emacs-lisp
excerpt: literate org-trello tryout
toc_sticky: true
---
<div id="table-of-contents">
<h2>Table of Contents</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="#org5d5076a">1. Howto</a></li>
<li><a href="#orgbf1d3d0">2. Description</a></li>
<li><a href="#org9674f80">3. License</a></li>
<li><a href="#orgfe814d7">4. Manual</a></li>
<li><a href="#orgb645de4">5. Code</a>
<ul>
<li><a href="#orgaa0fad5">5.1. Setup</a></li>
<li><a href="#orgc8b8568">5.2. Namespace</a></li>
<li><a href="#orgcf3bdf9">5.3. org-trello</a></li>
<li><a href="#orge5f20a7">5.4. orgtrello</a></li>
<li><a href="#org8946f24">5.5. orgtrello-query</a></li>
<li><a href="#org052c7e8">5.6. orgtrello-api</a></li>
<li><a href="#org13d2115">5.7. orgtrello-data</a></li>
<li><a href="#org0ee72f9">5.8. orgtrello-hash</a></li>
</ul>
</li>
<li><a href="#orge2a8add">6. Resulting</a></li>
<li><a href="#org1436e0e">7. Source</a></li>
</ul>
</div>
</div>
<p>
To help improving the maintenance of <a href="http://ardumont.github.io/org-trello/">org-trello</a>, we will describe it using
<a href="https://en.wikipedia.org/wiki/Literate_programming">literate programming</a>. For this, we will use <a href="http://orgmode.org/">org-mode</a> and <a href="http://orgmode.org/worg/org-contrib/babel/intro.html">babel</a>.
</p>

<p>
We'll begin by:
</p>
<ul class="org-ul">
<li>a simple how to</li>
<li>a little description</li>
<li>the license</li>
<li>a manual</li>
<li>a full description step-by-step of the code (may need to find another
organisation that the code order)</li>
</ul>

<div id="outline-container-org5d5076a" class="outline-2">
<h2 id="org5d5076a"><span class="section-number-2">1</span> Howto</h2>
<div class="outline-text-2" id="text-1">
<ul class="org-ul">
<li>Open this file</li>
<li>Tangle (extract) the code</li>
</ul>

<p>
<i>M-x org-babel-tangle</i> or <i>C-c C-v t</i>
</p>

<p>
Or
</p>

<p>
``` sh
make tangle
```
</p>
</div>
</div>


<div id="outline-container-orgbf1d3d0" class="outline-2">
<h2 id="orgbf1d3d0"><span class="section-number-2">2</span> Description</h2>
<div class="outline-text-2" id="text-2">
<p>
org-trello is an emacs's org minor mode to permit the 2-way synchonization
between org buffer and a trello board. The headers needs to start with ;;; as a
prerequisite for packaging. This is an important step where we describe the
different information about the project:
</p>
<ul class="org-ul">
<li>principal author</li>
<li>maintainer</li>
<li>current version</li>
<li>dependencies</li>
</ul>

<div class="org-src-container">
<pre class="src src-lisp" id="orgb78d524"><span style="color: #2aa1ae; background-color: #ecf3ec;">;;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">org-trello.el --- Org minor mode to synchronize with trello</span>

<span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">Copyright (C) 2013 Antoine R. Dumont &lt;eniotna.t AT gmail.com&gt;</span>

<span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">Author: Antoine R. Dumont &lt;eniotna.t AT gmail.com&gt;</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">Maintainer: Antoine R. Dumont &lt;eniotna.t AT gmail.com&gt;</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">Version: 0.1.1</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">Package-Requires: ((org "8.0.7") (dash "1.5.0") (request "0.2.0") (cl-lib "0.3.0") (json "1.2"))</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">Keywords: org-mode trello sync org-trello</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">URL: https://github.com/org-trello/org-trello</span>

</pre>
</div>
</div>
</div>

<div id="outline-container-org9674f80" class="outline-2">
<h2 id="org9674f80"><span class="section-number-2">3</span> License</h2>
<div class="outline-text-2" id="text-3">
<p>
First, org-trello is a free software under the GPL v3.
</p>

<div class="org-src-container">
<pre class="src src-lisp" id="org1126dd4"><span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">This file is NOT part of GNU Emacs.</span>

<span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">This program is free software; you can redistribute it and/or modify</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">it under the terms of the GNU General Public License as published by</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">the Free Software Foundation; either version 3, or (at your option)</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">any later version.</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">;;</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">This program is distributed in the hope that it will be useful,</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">GNU General Public License for more details.</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">;;</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">You should have received a copy of the GNU General Public License</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">along with GNU Emacs; see the file COPYING. If not, write to the</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">Free Software Foundation, Inc., 51 Franklin Street, Fifth Floor,</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">Boston, MA 02110-1301, USA.</span>

</pre>
</div>
</div>
</div>

<div id="outline-container-orgfe814d7" class="outline-2">
<h2 id="orgfe814d7"><span class="section-number-2">4</span> Manual</h2>
<div class="outline-text-2" id="text-4">
<p>
A fast setup that we, end-users, can see from the package installation procedure.
</p>

<div class="org-src-container">
<pre class="src src-lisp" id="org92fbe4b"><span style="color: #2aa1ae; background-color: #ecf3ec;">;;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">Commentary:</span>

<span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">Minor mode for org-mode to sync org-mode and trello</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">;;</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">1) Add the following to your emacs init file</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">(require 'org-trello)</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">;;</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">Automatically</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">2) Once - Install the consumer-key and the read-write token for org-trello to be able to work in your name with your trello boards (C-c o i)</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">M-x org-trello/install-key-and-token</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">;;</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">3) Once per org-mode file/board you want to connect to (C-c o I)</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">M-x org-trello/install-board-and-lists-ids</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">;;</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">*Beware* you must setup your trello board with the name you use as keywords (TODO, DONE e.g) on your org-mode file.</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">;;</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">4) You can also create a board directly from a org-mode buffer (C-c o b)</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">M-x org-trello/create-board</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">;;</span>

</pre>
</div>
</div>
</div>
<div id="outline-container-orgb645de4" class="outline-2">
<h2 id="orgb645de4"><span class="section-number-2">5</span> Code</h2>
<div class="outline-text-2" id="text-5">
</div>
<div id="outline-container-orgaa0fad5" class="outline-3">
<h3 id="orgaa0fad5"><span class="section-number-3">5.1</span> Setup</h3>
<div class="outline-text-3" id="text-5-1">
<p>
First, we will begin simply by showing the dependencies.
Then the personal setup that the user can override.
</p>
</div>

<ol class="org-ol">
<li><a id="orgdd4c899"></a>Library dependencies<br />
<div class="outline-text-4" id="text-5-1-1">
<p>
We depend on:
</p>

<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="org-left" />

<col  class="org-left" />
</colgroup>
<thead>
<tr>
<th scope="col" class="org-left">lib</th>
<th scope="col" class="org-left">description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left">org</td>
<td class="org-left">As org-trello is a org minor mode</td>
</tr>

<tr>
<td class="org-left">json</td>
<td class="org-left">The transit of data to trello's api is in json</td>
</tr>

<tr>
<td class="org-left">dash</td>
<td class="org-left">To provide some specific lisp constructs</td>
</tr>

<tr>
<td class="org-left">request</td>
<td class="org-left">Awesome http client</td>
</tr>

<tr>
<td class="org-left">cl-lib</td>
<td class="org-left">To provide some common-lisp functions</td>
</tr>

<tr>
<td class="org-left">parse-time</td>
<td class="org-left">Some date time manipulation</td>
</tr>
</tbody>
</table>

<div class="org-src-container">
<pre class="src src-lisp" id="org3f6e4c5"><span style="color: #2aa1ae; background-color: #ecf3ec;">;;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">Code:</span>

(<span style="color: #3a81c3; font-weight: bold;">require</span> '<span style="color: #4e3163;">org</span>)
(<span style="color: #3a81c3; font-weight: bold;">require</span> '<span style="color: #4e3163;">json</span>)
(<span style="color: #3a81c3; font-weight: bold;">require</span> '<span style="color: #4e3163;">dash</span>)
(<span style="color: #3a81c3; font-weight: bold;">require</span> '<span style="color: #4e3163;">request</span>)
(eval-when-compile (<span style="color: #3a81c3; font-weight: bold;">require</span> '<span style="color: #4e3163;">cl-lib</span>))
(<span style="color: #3a81c3; font-weight: bold;">require</span> '<span style="color: #4e3163;">parse-time</span>)

</pre>
</div>
</div>
</li>

<li><a id="org0aff39d"></a>Personal setup<br />
<div class="outline-text-4" id="text-5-1-2">
<p>
At the moment, we have only one possible setup.
This is relative to the checklist behaviour.
By default, the status of the checklist overrides the item's status.
</p>

<div class="org-src-container">
<pre class="src src-lisp" id="orge96319e">&#12;

<span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">#################### overriding setup</span>

(<span style="color: #3a81c3; font-weight: bold;">defvar</span> <span style="color: #715ab1;">*ORGTRELLO-CHECKLIST-UPDATE-ITEMS*</span> t
  <span style="color: #da8b55;">"A variable to permit the checklist's status to be pass along to its items. t, if checklist's status is DONE, the items are updated to DONE (org-mode buffer and trello board), nil only the items's status is used.</span>
<span style="color: #da8b55;">  To deactivate such behavior, update in your init.el:</span>
<span style="color: #da8b55;">  (require 'org-trello)</span>
<span style="color: #da8b55;">  (setq *ORGTRELLO-CHECKLIST-UPDATE-ITEMS* nil)"</span>)
</pre>
</div>

<p>
If the user does not want this, he/she can modify his/her setup in his/her emacs startup file:
</p>

<div class="org-src-container">
<pre class="src src-lisp">(setq *ORGTRELLO-CHECKLIST-UPDATE-ITEMS* nil)
</pre>
</div>
</div>
</li>
</ol>
</div>

<div id="outline-container-orgc8b8568" class="outline-3">
<h3 id="orgc8b8568"><span class="section-number-3">5.2</span> Namespace</h3>
<div class="outline-text-3" id="text-5-2">
<p>
As each emacs developer knows, there is no real namespace in emacs-lisp.
But, we like to separate function depending on perimeters, so we tried to keep the code as much separated as we can.
</p>

<p>
At the moment, we sliced the code into 6 namespaces:
</p>

<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="org-left" />

<col  class="org-left" />
</colgroup>
<thead>
<tr>
<th scope="col" class="org-left">name</th>
<th scope="col" class="org-left">description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left">org-trello</td>
<td class="org-left">Main namespace which describe the minor mode, in charge of controls before executing anything</td>
</tr>

<tr>
<td class="org-left">orgtrello</td>
<td class="org-left">Primitive routines that executes the code without checks</td>
</tr>

<tr>
<td class="org-left">orgtrello-query</td>
<td class="org-left">Interface to the http request</td>
</tr>

<tr>
<td class="org-left">orgtrello-api</td>
<td class="org-left">Interface to the trello api</td>
</tr>

<tr>
<td class="org-left">orgtrello-data</td>
<td class="org-left">Interface to the org data</td>
</tr>

<tr>
<td class="org-left">orgtrello-hash</td>
<td class="org-left">Utility interface to simplify the construction of data</td>
</tr>
</tbody>
</table>
</div>
</div>

<div id="outline-container-orgcf3bdf9" class="outline-3">
<h3 id="orgcf3bdf9"><span class="section-number-3">5.3</span> org-trello</h3>
<div class="outline-text-3" id="text-5-3">
<p>
This is the main entry namespace of org-trello.
Starting with the minor mode definition, we will show each higher interactive command after this.
</p>
</div>

<ol class="org-ol">
<li><a id="org0bb305f"></a>Minor mode<br />
<div class="outline-text-4" id="text-5-3-1">
<p>
As we said in the description step, <a href="http://ardumont.github.io/org-trello/">org-trello</a> is a <a href="https://www.gnu.org/software/emacs/manual/html_node/emacs/Minor-Modes.html">minor mode</a>.
</p>
</div>

<ol class="org-ol">
<li><a id="orgceb62e4"></a>Description<br />
<div class="outline-text-5" id="text-5-3-1-1">
<p>
Simply put, we offer a simple interface to the user through a map.
We declare the minor mode to have 'ot' as the emacs modeline name.
And we propose default bindings for the user to access the org-trello routine.
</p>

<div class="org-src-container">
<pre class="src src-lisp" id="org00183f5"><span style="color: #2aa1ae; background-color: #ecf3ec;">;;;</span><span style="color: #2aa1ae; background-color: #ecf3ec;">###autoload</span>
(define-minor-mode org-trello-mode <span style="color: #da8b55;">"Sync your org-mode and your trello together."</span>
  <span style="color: #3a81c3;">:lighter</span> <span style="color: #2d9574;">" ot"</span> <span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">the name on the modeline</span>
  <span style="color: #3a81c3;">:keymap</span>  (<span style="color: #3a81c3; font-weight: bold;">let</span> ((map (make-sparse-keymap)))
             <span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">binding will change</span>
             (define-key map (kbd <span style="color: #2d9574;">"C-c o i"</span>) 'org-trello/install-key-and-token)
             (define-key map (kbd <span style="color: #2d9574;">"C-c o I"</span>) 'org-trello/install-board-and-lists-ids)
             (define-key map (kbd <span style="color: #2d9574;">"C-c o b"</span>) 'org-trello/create-board)
             (define-key map (kbd <span style="color: #2d9574;">"C-c o c"</span>) 'org-trello/create-simple-entity)
             (define-key map (kbd <span style="color: #2d9574;">"C-c o C"</span>) 'org-trello/create-complex-entity)
             (define-key map (kbd <span style="color: #2d9574;">"C-c o s"</span>) 'org-trello/sync-to-trello)
             (define-key map (kbd <span style="color: #2d9574;">"C-c o S"</span>) 'org-trello/sync-from-trello)
             (define-key map (kbd <span style="color: #2d9574;">"C-c o k"</span>) 'org-trello/kill-entity)
             (define-key map (kbd <span style="color: #2d9574;">"C-c o h"</span>) 'org-trello/help-describing-bindings)
             (define-key map (kbd <span style="color: #2d9574;">"C-c o d"</span>) 'org-trello/check-setup)
             <span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">define other bindings...</span>
             map)
  <span style="color: #3a81c3;">:after-hook</span> (message <span style="color: #2d9574;">"ot is on! To begin with, hit C-c o h or M-x 'org-trello/help-describing-bindings"</span>))

(add-hook 'org-mode-hook 'org-trello-mode)

(message <span style="color: #2d9574;">"org-trello loaded!"</span>)

</pre>
</div>
</div>
</li>

<li><a id="org55e6f1b"></a>Override<br />
<div class="outline-text-5" id="text-5-3-1-2">
<p>
If the user is not satisfied with the default bindings, he/she can always override in his/her own setup files.
I kept the default one but the idea is to replace those bindings by the one you want.
</p>

<div class="org-src-container">
<pre class="src src-lisp">(define-key org-trello-mode-map (kbd <span style="color: #2d9574;">"C-c o i"</span>) 'org-trello/install-key-and-token)
(define-key org-trello-mode-map (kbd <span style="color: #2d9574;">"C-c o I"</span>) 'org-trello/install-board-and-lists-ids)
(define-key org-trello-mode-map (kbd <span style="color: #2d9574;">"C-c o b"</span>) 'org-trello/create-board)
(define-key org-trello-mode-map (kbd <span style="color: #2d9574;">"C-c o c"</span>) 'org-trello/create-simple-entity)
(define-key org-trello-mode-map (kbd <span style="color: #2d9574;">"C-c o C"</span>) 'org-trello/create-complex-entity)
(define-key org-trello-mode-map (kbd <span style="color: #2d9574;">"C-c o s"</span>) 'org-trello/sync-to-trello)
(define-key org-trello-mode-map (kbd <span style="color: #2d9574;">"C-c o S"</span>) 'org-trello/sync-from-trello)
(define-key org-trello-mode-map (kbd <span style="color: #2d9574;">"C-c o k"</span>) 'org-trello/kill-entity)
(define-key org-trello-mode-map (kbd <span style="color: #2d9574;">"C-c o h"</span>) 'org-trello/help-describing-bindings)
(define-key org-trello-mode-map (kbd <span style="color: #2d9574;">"C-c o d"</span>) 'org-trello/check-setup)
</pre>
</div>
</div>
</li>
</ol>
</li>
<li><a id="orgee7d158"></a>Help<br />
<div class="outline-text-4" id="text-5-3-2">
<p>
Let's begin simple, we offer an interactive command to display the current possible bindings.
Hitting <i>C-c o h</i>, this will display a simple message on the minibuffer.
</p>

<div class="org-src-container">
<pre class="src src-lisp" id="org715aa6b">(<span style="color: #3a81c3; font-weight: bold;">defun</span> <span style="color: #6c3163; font-weight: bold;">org-trello/help-describing-bindings</span> ()
  <span style="color: #da8b55;">"A simple message to describe the standard bindings used."</span>
  (interactive)
  (message
<span style="color: #2d9574;">"C-c o i - M-x org-trello/install-key-and-token       - Install the keys and the access-token.</span>
<span style="color: #2d9574;">C-c o I - M-x org-trello/install-board-and-lists-ids - Select the board and attach the todo, doing and done list.</span>
<span style="color: #2d9574;">C-c o b - M-x org-trello/create-board                - Create interactively a board and attach the org-mode file to this trello board.</span>
<span style="color: #2d9574;">C-c o c - M-x org-trello/create-simple-entity        - Create/Update an entity (card/checklist/item) depending on its level and status. Do not deal with level superior to 4.</span>
<span style="color: #2d9574;">C-c o C - M-x org-trello/create-complex-entity       - Create/Update a complete entity card/checklist/item and its subtree (depending on its level).</span>
<span style="color: #2d9574;">C-c o s - M-x org-trello/sync-to-trello              - Synchronize the org-mode file to the trello board (org-mode -&gt; trello).</span>
<span style="color: #2d9574;">C-c o S - M-x org-trello/sync-from-trello            - Synchronize the org-mode file from the trello board (trello -&gt; org-mode).</span>
<span style="color: #2d9574;">C-c o k - M-x org-trello/kill-entity                 - Kill the entity (and its arborescence tree).</span>
<span style="color: #2d9574;">C-c o d - M-x org-trello/check-setup                 - Simple routine to check that the setup is ok. If everything is ok, will simply display 'Setup ok!'</span>
<span style="color: #2d9574;">C-c o h - M-x org-trello/help-describing-bindings    - This help message."</span>))

</pre>
</div>
</div>
</li>

<li><a id="orgbdc139f"></a>Install the consumer-key and the read/write access token<br />
<div class="outline-text-4" id="text-5-3-3">
<p>
One of the first interaction we must have with org-trello is the setup.
For this, we declare an interactive command.
We delegate the code to the function <code>org-trello/--msg-deco-control-and-do</code>.
This will:
</p>
<ul class="org-ul">
<li>log the actions "Setup key and token" in the mini-buffer.</li>
<li>execute no control as none is needed (thus the nil as second parameter)</li>
<li>as there are no control, directly execute the 'org-trello/do-install-key-and-token.</li>
<li>as there is writing involve, we ask to save the buffer at the end (t)</li>
</ul>

<div class="org-src-container">
<pre class="src src-lisp" id="orgdc87f15">(<span style="color: #3a81c3; font-weight: bold;">defun</span> <span style="color: #6c3163; font-weight: bold;">org-trello/install-key-and-token</span> ()
  <span style="color: #da8b55;">"No control, trigger the setup installation of the key and the read/write token."</span>
  (interactive)
  (org-trello/--msg-deco-control-and-do <span style="color: #2d9574;">"Setup key and token"</span> nil 'orgtrello/do-install-key-and-token t))

</pre>
</div>
</div>
</li>

<li><a id="orgb147346"></a>Decorator/Controller<br />
<div class="outline-text-4" id="text-5-3-4">
<p>
As we've seen before, we have a higher-order function <code>org-trello/--msg-deco-control-and-do</code> which is in charge of:
</p>
<ul class="org-ul">
<li>displaying the message <code>msg</code> in the mini-buffer</li>
<li>ask for the <code>org-trello/--control-and-do</code> function to execute</li>
<li>displaying the result string from the call of the previous function if there is some</li>
<li>optionally, we can ask for saving the buffer through the flag <code>save-buffer-p</code></li>
</ul>

<div class="org-src-container">
<pre class="src src-lisp" id="orgb9652a0">&#12;

<span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">#################### org-trello</span>

(<span style="color: #3a81c3; font-weight: bold;">defun</span> <span style="color: #6c3163; font-weight: bold;">org-trello/--msg-deco-control-and-do</span> (msg control-fns fn-to-control-and-execute <span style="color: #ba2f59; font-weight: bold;">&amp;optional</span> save-buffer-p)
  <span style="color: #da8b55;">"A simple decorator function to display message in mini-buffer before and after the execution of the control"</span>
  (message (concat msg <span style="color: #2d9574;">"..."</span>))
  (<span style="color: #3a81c3; font-weight: bold;">let</span> ((org-trello/--result-action (org-trello/--control-and-do control-fns fn-to-control-and-execute)))
    <span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">do we have to save the buffer</span>
    (<span style="color: #3a81c3; font-weight: bold;">if</span> save-buffer-p
        (<span style="color: #3a81c3; font-weight: bold;">progn</span>
          (save-buffer)
          (org-mode-restart)))
    (<span style="color: #3a81c3; font-weight: bold;">if</span> (string-or-null-p org-trello/--result-action)
      (message org-trello/--result-action)
      (message (concat msg <span style="color: #2d9574;">" - done!"</span>)))))

</pre>
</div>

<p>
This is the main function which is in charge:
</p>
<ul class="org-ul">
<li>executing a list of controls <code>control-fns</code></li>
<li>if there is no control or the controls are ok, execute the function <code>fn-to-control-and-execute</code></li>
<li>returns the resulting string from the execution of the function</li>
</ul>

<div class="org-src-container">
<pre class="src src-lisp" id="org42427cd">(<span style="color: #3a81c3; font-weight: bold;">defun</span> <span style="color: #6c3163; font-weight: bold;">org-trello/--control-and-do</span> (control-fns fn-to-control-and-execute)
  <span style="color: #da8b55;">"Execute the function fn if control-fns is nil or if the result of apply every function to fn is ok."</span>
  (<span style="color: #3a81c3; font-weight: bold;">if</span> control-fns
      (<span style="color: #3a81c3; font-weight: bold;">let*</span> ((org-trello/--error-messages (--filter (not (equal <span style="color: #3a81c3;">:ok</span> (funcall it))) control-fns)))
        (<span style="color: #3a81c3; font-weight: bold;">if</span> org-trello/--error-messages
            <span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">there are some trouble, we display all the error messages to help the user understand the problem</span>
            (message <span style="color: #2d9574;">"List of errors:\n %s"</span> (--mapcat (concat <span style="color: #2d9574;">"- "</span> it <span style="color: #2d9574;">"\n"</span>) org-trello/--error-messages))
          <span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">ok execute the function as the controls are ok</span>
          (funcall fn-to-control-and-execute)))
    <span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">no control, we simply execute the function</span>
    (funcall fn-to-control-and-execute)))

</pre>
</div>
</div>
</li>

<li><a id="org8962e7f"></a>Setup trello<br />
<div class="outline-text-4" id="text-5-3-5">
<p>
To use trello, we need to either install a trello board or create one.
In either case, this will do some action and update the org-mode buffer with some needed metadata:
</p>
<ul class="org-ul">
<li>board-id</li>
<li>board-name (for the user to see which board he/she uses)</li>
<li>every keyword (org) / list id (trello)</li>
</ul>
</div>

<ol class="org-ol">
<li><a id="orge16193d"></a>Install the board<br />
<div class="outline-text-5" id="text-5-3-5-1">
<p>
To install a trello board, we need:
</p>
<ul class="org-ul">
<li>to display a message on the minibuffer "Install boards and lists"</li>
<li>execute the loading of the setup via <code>setup-properties</code> function (no control but a setup)</li>
<li>execute the control of the key and access-token are ok</li>
<li>if everything is ok, do install the board and lists on the trello buffer</li>
<li>as some update of the org-mode buffer is done, we ask for the buffer to be saved</li>
</ul>

<div class="org-src-container">
<pre class="src src-lisp" id="orgdebbd09">(<span style="color: #3a81c3; font-weight: bold;">defun</span> <span style="color: #6c3163; font-weight: bold;">org-trello/install-board-and-lists-ids</span> ()
  <span style="color: #da8b55;">"Control first, then if ok, trigger the setup installation of the trello board to sync with."</span>
  (interactive)
  (org-trello/--msg-deco-control-and-do
     <span style="color: #2d9574;">"Install boards and lists"</span>
     '(orgtrello/--setup-properties orgtrello/--control-keys)
     'orgtrello/do-install-board-and-lists
     t))

</pre>
</div>
</div>
</li>

<li><a id="org8280d32"></a>Create a board<br />
<div class="outline-text-5" id="text-5-3-5-2">
<p>
To create a trello board from scratch, we need:
</p>
<ul class="org-ul">
<li>to display a message on the minibuffer "Create boards and lists"</li>
<li>execute the loading of the setup via <code>setup-properties</code> function (no control but a setup)</li>
<li>execute the control of the key and access-token are ok</li>
<li>if everything is ok, do create the board and lists on the trello buffer</li>
<li>as some update of the org-mode buffer is done, we ask for the buffer to be saved</li>
</ul>

<div class="org-src-container">
<pre class="src src-lisp" id="org1af41b6">(<span style="color: #3a81c3; font-weight: bold;">defun</span> <span style="color: #6c3163; font-weight: bold;">org-trello/create-board</span> ()
  <span style="color: #da8b55;">"Control first, then if ok, trigger the board creation."</span>
  (interactive)
  (org-trello/--msg-deco-control-and-do
     <span style="color: #2d9574;">"Create board and lists"</span>
     '(orgtrello/--setup-properties orgtrello/--control-keys)
     'orgtrello/do-create-board-and-lists
     t))

</pre>
</div>
</div>
</li>
</ol>
</li>

<li><a id="org515104c"></a>Check the installation<br />
<div class="outline-text-4" id="text-5-3-6">
<p>
Now that we setuped the org buffer to work with a trello board, we can ensure that the setup is ok.
For this, we simply call the <code>org-trello/--control-and-do</code> routine with:
</p>
<ul class="org-ul">
<li><code>orgtrello/--setup-properties</code> which will load the metadata from the file</li>
<li><code>orgtrello/--control-keys</code> to ensure the key and access token are loaded</li>
<li><code>orgtrello/--control-properties</code> to ensure the properties are properly setuped</li>
</ul>
<p>
If any of those are badly setuped, a message will explicit the problem.
Otherwise, a simple message "Setup ok!" will be displayed on the minibuffer.
</p>

<div class="org-src-container">
<pre class="src src-lisp" id="org93de017">(<span style="color: #3a81c3; font-weight: bold;">defun</span> <span style="color: #6c3163; font-weight: bold;">org-trello/check-setup</span> ()
  <span style="color: #da8b55;">"Check the current setup."</span>
  (interactive)
  (org-trello/--control-and-do
     '(orgtrello/--setup-properties orgtrello/--control-keys orgtrello/--control-properties orgtrello/--control-encoding)
     (<span style="color: #3a81c3; font-weight: bold;">lambda</span> () (message <span style="color: #2d9574;">"Setup ok!"</span>))))

</pre>
</div>
</div>
</li>

<li><a id="org2f57677"></a>Sync a simple entity<br />
<div class="outline-text-4" id="text-5-3-7">
<p>
To create/synchronize a simple entity (without its arborescence), we need to ensure some standard controls are ok.
Then we can call the primitive routine <code>orgtrello/do-create-simple-entity</code> to do the actual creation.
At last, saving the buffer as the creation involves some buffer updates (with the trello id).
</p>

<div class="org-src-container">
<pre class="src src-lisp" id="orgd2cc454">(<span style="color: #3a81c3; font-weight: bold;">defun</span> <span style="color: #6c3163; font-weight: bold;">org-trello/create-simple-entity</span> ()
  <span style="color: #da8b55;">"Control first, then if ok, create a simple entity."</span>
  (interactive)
  (org-trello/--msg-deco-control-and-do
     <span style="color: #2d9574;">"Synchronizing entity"</span>
     '(orgtrello/--setup-properties orgtrello/--control-keys orgtrello/--control-properties orgtrello/--control-encoding)
     (<span style="color: #3a81c3; font-weight: bold;">lambda</span> () (orgtrello/do-create-simple-entity t))
     t))

</pre>
</div>
</div>
</li>

<li><a id="orgb3bf35b"></a>Sync a complex entity<br />
<div class="outline-text-4" id="text-5-3-8">
<p>
To create/synchronize a complex entity (with its arborescence), we need to ensure some standard controls are ok.
Then we can call the primitive routine <code>orgtrello/do-create-complex-entity</code> to do the actual creation.
At last, saving the buffer as the creation involves some buffer updates.
</p>

<div class="org-src-container">
<pre class="src src-lisp" id="org2032b56">(<span style="color: #3a81c3; font-weight: bold;">defun</span> <span style="color: #6c3163; font-weight: bold;">org-trello/create-complex-entity</span> ()
  <span style="color: #da8b55;">"Control first, then if ok, create an entity and all its arborescence if need be."</span>
  (interactive)
  (org-trello/--msg-deco-control-and-do
     <span style="color: #2d9574;">"Synchronizing complex entity"</span>
     '(orgtrello/--setup-properties orgtrello/--control-keys orgtrello/--control-properties orgtrello/--control-encoding)
     'orgtrello/do-create-complex-entity
     t))

</pre>
</div>
</div>
</li>

<li><a id="orgfecc178"></a>Synchronize the org-mode buffer to trello<br />
<div class="outline-text-4" id="text-5-3-9">
<p>
Now that we have the basic brick (synchronize simple/complex entity), we can use this to synchronize the all buffer to trello.
But first, we need to ensure some standard controls are ok.
Then calling the primitive routine <code>orgtrello/do-sync-full-file</code> which does the actual syncing.
At last, we save the buffer as the buffer has been updated.
</p>

<div class="org-src-container">
<pre class="src src-lisp" id="org336c3aa">(<span style="color: #3a81c3; font-weight: bold;">defun</span> <span style="color: #6c3163; font-weight: bold;">org-trello/sync-to-trello</span> ()
  <span style="color: #da8b55;">"Control first, then if ok, sync the org-mode file completely to trello."</span>
  (interactive)
  (org-trello/--msg-deco-control-and-do
     <span style="color: #2d9574;">"Synchronizing org-mode file to trello"</span>
     '(orgtrello/--setup-properties orgtrello/--control-keys orgtrello/--control-properties orgtrello/--control-encoding)
     'orgtrello/do-sync-full-file
     t))

</pre>
</div>
</div>
</li>

<li><a id="org04ce285"></a>Synchronize the org-mode buffer from trello<br />
<div class="outline-text-4" id="text-5-3-10">
<p>
The other way around is also possible.
You know the drill by now, we must ensure we have the standard control that pass.
Then calling the routine <code>orgtrello/do-sync-full-from-trello</code> which really does the action.
Then saving the buffer as the action involved some buffer updates.
</p>

<div class="org-src-container">
<pre class="src src-lisp" id="orgb43c175">(<span style="color: #3a81c3; font-weight: bold;">defun</span> <span style="color: #6c3163; font-weight: bold;">org-trello/sync-from-trello</span> ()
  <span style="color: #da8b55;">"Control first, then if ok, sync the org-mode file from the trello board."</span>
  (interactive)
  (org-trello/--msg-deco-control-and-do
     <span style="color: #2d9574;">"Synchronizing trello board to org-mode file"</span>
     '(orgtrello/--setup-properties orgtrello/--control-keys orgtrello/--control-properties orgtrello/--control-encoding)
     'orgtrello/do-sync-full-from-trello
     t))

</pre>
</div>
</div>
</li>

<li><a id="orge647c63"></a>Kill/Remove/Delete an entity<br />
<div class="outline-text-4" id="text-5-3-11">
<p>
As we can create entity on trello, we can also remove them (from trello and the current org buffer).
As usual, we ensure standard controls are ok.
Then calling the subroutine <code>orgtrello/do-delete-simple</code> which does the action.
Then saving the buffer as the action involved some buffer updates.
</p>

<div class="org-src-container">
<pre class="src src-lisp" id="orgd49b995">(<span style="color: #3a81c3; font-weight: bold;">defun</span> <span style="color: #6c3163; font-weight: bold;">org-trello/kill-entity</span> ()
  <span style="color: #da8b55;">"Control first, then if ok, delete the entity and all its arborescence."</span>
  (interactive)
  (org-trello/--msg-deco-control-and-do
     <span style="color: #2d9574;">"Delete entity"</span>
     '(orgtrello/--setup-properties orgtrello/--control-keys orgtrello/--control-properties orgtrello/--control-encoding)
     (<span style="color: #3a81c3; font-weight: bold;">lambda</span> () (orgtrello/do-delete-simple t))
     t))

</pre>
</div>
</div>
</li>

<li><a id="org9b276ef"></a>Providing<br />
<div class="outline-text-4" id="text-5-3-12">
<p>
Now that we defined all of our code, we need to provide the library we created.
Simplify using emacs's primitive <i>provide</i>.
</p>

<div class="org-src-container">
<pre class="src src-lisp" id="org45b9ad3">(<span style="color: #3a81c3; font-weight: bold;">provide</span> '<span style="color: #4e3163;">org-trello</span>)

<span style="color: #2aa1ae; background-color: #ecf3ec;">;;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">org-trello.el ends here</span>
</pre>
</div>
</div>
</li>
</ol>
</div>
<div id="outline-container-orge5f20a7" class="outline-3">
<h3 id="orge5f20a7"><span class="section-number-3">5.4</span> orgtrello</h3>
<div class="outline-text-3" id="text-5-4">
<p>
This is the namespace in charge of the primitive functions that actually trigger the action. Those functions reflect the same action as we define earlier but without any controls first.
They are not to be called directly from the user.
</p>
</div>

<ol class="org-ol">
<li><a id="orge9b2f6b"></a>Namespace setup<br />
<div class="outline-text-4" id="text-5-4-1">
<p>
First, we'll begin by some setup variables that are actually used throughout the namespace:
</p>
<ul class="org-ul">
<li><b>TODO</b> representation of org's "TODO" keyword</li>
<li><b>DONE</b> representation of org's "DONE" keyword</li>
<li><b>BOARD-ID</b> will be the trello board's identifier for org-trello to know which board to use</li>
<li><b>BOARD-NAME</b> will be the trello board's name for the user to know to which board he/she works with</li>
<li><b>LIST-NAMES</b> is the keyword the user use with org in reverse order</li>
<li><b>HMAP-ID-NAME</b> is a map of those same keyword with a sequence identifier</li>
<li><b>CONFIG-DIR</b> is the org-trello's home folder</li>
<li><b>CONFIG-FILE</b> is the org-trello's setup file (for consumer-key and access-token)</li>
<li><b>consumer-key</b> is the user's consumer-key for trello</li>
<li><b>access-token</b> is the user's read/write access-token for trello</li>
<li><b>ORGTRELLO-MARKER</b> is a marker used by org-trello to know which entity it has synced. This is dependent on the <b>consumer-key</b></li>
</ul>

<p>
The user does not have to touch anything on this.
</p>

<div class="org-src-container">
<pre class="src src-lisp" id="orge08ba02">&#12;

<span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">#################### orgtrello</span>

<span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">Specific state - FIXME check if they do not already exist on org-mode to avoid potential collisions</span>
(<span style="color: #3a81c3; font-weight: bold;">defvar</span> <span style="color: #715ab1;">*TODO*</span> <span style="color: #2d9574;">"TODO"</span> <span style="color: #da8b55;">"org-mode todo state"</span>)
(<span style="color: #3a81c3; font-weight: bold;">defvar</span> <span style="color: #715ab1;">*DONE*</span> <span style="color: #2d9574;">"DONE"</span> <span style="color: #da8b55;">"org-mode done state"</span>)

<span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">Properties key for the orgtrello headers #+PROPERTY board-id, etc...</span>
(<span style="color: #3a81c3; font-weight: bold;">defvar</span> <span style="color: #715ab1;">*BOARD-ID*</span> <span style="color: #2d9574;">"board-id"</span> <span style="color: #da8b55;">"orgtrello property board-id entry"</span>)
(<span style="color: #3a81c3; font-weight: bold;">defvar</span> <span style="color: #715ab1;">*BOARD-NAME*</span> <span style="color: #2d9574;">"board-name"</span> <span style="color: #da8b55;">"orgtrello property board-name entry"</span>)

(<span style="color: #3a81c3; font-weight: bold;">defvar</span> <span style="color: #715ab1;">*LIST-NAMES*</span>   nil <span style="color: #da8b55;">"orgtrello property names of the different lists. This use the standard 'org-todo-keywords property from org-mode."</span>)
(<span style="color: #3a81c3; font-weight: bold;">defvar</span> <span style="color: #715ab1;">*HMAP-ID-NAME*</span> nil <span style="color: #da8b55;">"orgtrello hash map containing for each id, the associated name (or org keyword)."</span>)

(<span style="color: #3a81c3; font-weight: bold;">defvar</span> <span style="color: #715ab1;">*CONFIG-DIR*</span>  (concat (getenv <span style="color: #2d9574;">"HOME"</span>) <span style="color: #2d9574;">"/"</span> <span style="color: #2d9574;">".trello"</span>))
(<span style="color: #3a81c3; font-weight: bold;">defvar</span> <span style="color: #715ab1;">*CONFIG-FILE*</span> (concat *CONFIG-DIR* <span style="color: #2d9574;">"/config.el"</span>))

(<span style="color: #3a81c3; font-weight: bold;">defvar</span> <span style="color: #715ab1;">*consumer-key*</span>     nil <span style="color: #da8b55;">"Id representing the user"</span>)
(<span style="color: #3a81c3; font-weight: bold;">defvar</span> <span style="color: #715ab1;">*access-token*</span>     nil <span style="color: #da8b55;">"Read/write Access token to use trello in the user's name "</span>)
(<span style="color: #3a81c3; font-weight: bold;">defvar</span> <span style="color: #715ab1;">*ORGTRELLO-MARKER*</span> nil <span style="color: #da8b55;">"Marker used for syncing the data in trello"</span>)

</pre>
</div>
</div>
</li>

<li><a id="orgba44a66"></a>Control/setup routines<br />
<div class="outline-text-4" id="text-5-4-2">
<p>
Some control/setup important routines because they will permit or not to launch the main actions.
</p>
</div>

<ol class="org-ol">
<li><a id="org267b74e"></a>orgtrello/&#x2013;setup-properties<br />
<div class="outline-text-5" id="text-5-4-2-1">
<p>
This is an important routine in charge of loading the keywords the user want to use.
Note that this routine reverse the list of org keywords.
This is a trick to help create the list in trello in the right order (assuming the user defines in the right order his/her keywords, e.g <i>TODO DOING | DONE FAIL</i>)
</p>

<div class="org-src-container">
<pre class="src src-lisp" id="org85873ec">(<span style="color: #3a81c3; font-weight: bold;">defun</span> <span style="color: #6c3163; font-weight: bold;">orgtrello/--setup-properties</span> ()
  <span style="color: #da8b55;">"Setup the properties according to the org-mode setup. Return :ok."</span>
  (<span style="color: #3a81c3; font-weight: bold;">let*</span> ((orgtrello/--list-keywords (nreverse (orgtrello/filtered-kwds)))
         (orgtrello/--hmap-id-name (cl-reduce
                                    (<span style="color: #3a81c3; font-weight: bold;">lambda</span> (hmap name)
                                      (<span style="color: #3a81c3; font-weight: bold;">progn</span>
                                        (puthash (assoc-default name org-file-properties) name hmap)
                                        hmap))
                                    orgtrello/--list-keywords
                                    <span style="color: #3a81c3;">:initial-value</span> (make-hash-table <span style="color: #3a81c3;">:test</span> 'equal))))
    (setq *LIST-NAMES*   orgtrello/--list-keywords)
    (setq *HMAP-ID-NAME* orgtrello/--hmap-id-name)
    <span style="color: #3a81c3;">:ok</span>))

</pre>
</div>
</div>
</li>

<li><a id="orgfc601b6"></a>orgtrello/filtered-kwds<br />
<div class="outline-text-5" id="text-5-4-2-2">
<p>
This is a function in charge of retrieving the specific keywords the user wants to use with trello.
This will map later as the list in trello and as keyword in emacs's org-mode buffer.
</p>

<div class="org-src-container">
<pre class="src src-lisp" id="orgc70d4f6">(<span style="color: #3a81c3; font-weight: bold;">defun</span> <span style="color: #6c3163; font-weight: bold;">orgtrello/filtered-kwds</span> ()
  <span style="color: #da8b55;">"org keywords used (based on org-todo-keywords-1)."</span>
  org-todo-keywords-1)

</pre>
</div>
</div>
</li>


<li><a id="org7045606"></a>orgtrello/&#x2013;control-encoding<br />
<div class="outline-text-5" id="text-5-4-2-3">
<p>
A simple message to make the user aware he needs to use utf-8 encoding.
</p>

<div class="org-src-container">
<pre class="src src-lisp" id="orgc3a932f">(<span style="color: #3a81c3; font-weight: bold;">defun</span> <span style="color: #6c3163; font-weight: bold;">orgtrello/--control-encoding</span> ()
  <span style="color: #da8b55;">"Use utf-8, otherwise, there will be trouble."</span>
  (<span style="color: #3a81c3; font-weight: bold;">progn</span>
    (message <span style="color: #2d9574;">"Ensure you use utf-8 encoding for your org buffer."</span>)
    <span style="color: #3a81c3;">:ok</span>))

</pre>
</div>
</div>
</li>

<li><a id="org3970bd3"></a>orgtrello/&#x2013;control-properties<br />
<div class="outline-text-5" id="text-5-4-2-4">
<p>
An important higher routine to ensure that the setup regarding the trello board is rightly setuped on the org buffer.
We simply ensure that we have the right amount of properties regarding the org keywords.
If all is ok, we return the :ok value, otherwise, we return an error message indicating the user what he must do.
</p>

<div class="org-src-container">
<pre class="src src-lisp" id="org510f274">(<span style="color: #3a81c3; font-weight: bold;">defun</span> <span style="color: #6c3163; font-weight: bold;">orgtrello/--control-properties</span> ()
  <span style="color: #da8b55;">"org-trello needs the properties board-id and all list id from the trello board to be setuped on header property file. Returns :ok if everything is ok, or the error message if problems."</span>
  (<span style="color: #3a81c3; font-weight: bold;">let</span> ((orgtrello/--hmap-count   (hash-table-count *HMAP-ID-NAME*)))
    (<span style="color: #3a81c3; font-weight: bold;">if</span> (and (assoc-default *BOARD-ID* org-file-properties)
             (= (length *LIST-NAMES*) orgtrello/--hmap-count))
        <span style="color: #3a81c3;">:ok</span>
      <span style="color: #2d9574;">"Setup problem.\nEither you did not connect your org-mode buffer with a trello board, to correct this:\n  * attach to a board through C-c o I or M-x org-trello/install-board-and-lists-ids\n  * or create a board from scratch with C-c o b or M-x org-trello/create-board).\nEither your org-mode's todo keyword list and your trello board lists are not named the same way (which they must).\nFor this, connect to trello and rename your board's list according to your org-mode's todo list.\nAlso, you can specify on your org-mode buffer the todo list you want to work with, for example: #+TODO: TODO DOING | DONE FAIL (hit C-c C-c to refresh the setup)"</span>)))

</pre>
</div>
</div>
</li>

<li><a id="org5c8f22b"></a>orgtrello/&#x2013;control-keys<br />
<div class="outline-text-5" id="text-5-4-2-5">
<p>
Another important check routine to ensure that the user has rightfully setuped his/her consumer-key and read/write access-token.
If everything is ok, we return :ok.
Otherwise, we return an error message indicating what the user must do.
</p>

<div class="org-src-container">
<pre class="src src-lisp" id="org5b1d170">(<span style="color: #3a81c3; font-weight: bold;">defun</span> <span style="color: #6c3163; font-weight: bold;">orgtrello/--control-keys</span> ()
  <span style="color: #da8b55;">"org-trello needs the *consumer-key* and the *access-token* to access the trello resources. Returns :ok if everything is ok, or the error message if problems."</span>
  (<span style="color: #3a81c3; font-weight: bold;">if</span> (or (and *consumer-key* *access-token*)
          <span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">the data are not set,</span>
          (and (file-exists-p *CONFIG-FILE*)
               <span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">trying to load them</span>
               (load *CONFIG-FILE*)
               <span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">still not loaded, something is not right!</span>
               (and *consumer-key* *access-token*)
               <span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">setting the marker once</span>
               (setq *ORGTRELLO-MARKER* (format <span style="color: #2d9574;">"orgtrello-marker-%s"</span> *consumer-key*))))
      <span style="color: #3a81c3;">:ok</span>
    <span style="color: #2d9574;">"Setup problem - You need to install the consumer-key and the read/write access-token - C-c o i or M-x org-trello/install-board-and-lists-ids"</span>))

</pre>
</div>
</div>
</li>
</ol>
</li>

<li><a id="orgd5465b8"></a>Abstraction access routines<br />
<div class="outline-text-4" id="text-5-4-3">
<p>
Those are simple routines to abstract away the representation of the org data we manipulate.
</p>
</div>

<ol class="org-ol">
<li><a id="org97ca809"></a>orgtrello/&#x2013;keyword<br />
<div class="outline-text-5" id="text-5-4-3-1">
<p>
Extract the status/keyword from the current entity (e.g TODO, DONE, etc&#x2026;).
</p>

<div class="org-src-container">
<pre class="src src-lisp" id="org6a3c013">(<span style="color: #3a81c3; font-weight: bold;">defun</span> <span style="color: #6c3163; font-weight: bold;">orgtrello/--keyword</span> (entity-meta <span style="color: #ba2f59; font-weight: bold;">&amp;optional</span> default-value)
  <span style="color: #da8b55;">"Retrieve the keyword from the entity. If default-value is specified, this is the default value if no keyword is present"</span>
  (gethash <span style="color: #3a81c3;">:keyword</span> entity-meta default-value))

</pre>
</div>
</div>
</li>

<li><a id="orgca12b9c"></a>orgtrello/&#x2013;label<br />
<div class="outline-text-5" id="text-5-4-3-2">
<p>
To extract the label from the entity.
This is what's map to the name of the entity on trello.
</p>

<div class="org-src-container">
<pre class="src src-lisp" id="orge582e53">(<span style="color: #3a81c3; font-weight: bold;">defun</span> <span style="color: #6c3163; font-weight: bold;">orgtrello/--label</span> (entity-meta)
  <span style="color: #da8b55;">"Retrieve the label from the entity."</span>
  (gethash <span style="color: #3a81c3;">:title</span> entity-meta))

</pre>
</div>
</div>
</li>

<li><a id="org94d9c8e"></a>orgtrello/&#x2013;id<br />
<div class="outline-text-5" id="text-5-4-3-3">
<p>
The identifier of the entity once it has been synchronized on trello.
</p>

<div class="org-src-container">
<pre class="src src-lisp" id="org1994b64">(<span style="color: #3a81c3; font-weight: bold;">defun</span> <span style="color: #6c3163; font-weight: bold;">orgtrello/--id</span> (entity-meta)
  <span style="color: #da8b55;">"Retrieve the id from the entity."</span>
  (gethash <span style="color: #3a81c3;">:id</span> entity-meta))

</pre>
</div>
</div>
</li>

<li><a id="orgb9bb348"></a>orgtrello/&#x2013;level<br />
<div class="outline-text-5" id="text-5-4-3-4">
<p>
The current level (mapped to the number of stars).
</p>

<div class="org-src-container">
<pre class="src src-lisp" id="org4448cf3">(<span style="color: #3a81c3; font-weight: bold;">defun</span> <span style="color: #6c3163; font-weight: bold;">orgtrello/--level</span> (entity-meta)
  <span style="color: #da8b55;">"Retrieve the level from the entity."</span>
  (gethash <span style="color: #3a81c3;">:level</span> entity-meta))

</pre>
</div>
</div>
</li>

<li><a id="org4234c17"></a>orgtrello/&#x2013;due<br />
<div class="outline-text-5" id="text-5-4-3-5">
<p>
The deadline (org notion) mapped to due date (on trello).
</p>

<div class="org-src-container">
<pre class="src src-lisp" id="orgdc107ee">(<span style="color: #3a81c3; font-weight: bold;">defun</span> <span style="color: #6c3163; font-weight: bold;">orgtrello/--due</span> (entity-meta)
  <span style="color: #da8b55;">"Retrieve the due date from the entity."</span>
  (gethash <span style="color: #3a81c3;">:due</span> entity-meta))

</pre>
</div>
</div>
</li>
</ol>
</li>

<li><a id="org03cb500"></a>Create simple entity<br />
<ol class="org-ol">
<li><a id="org0ab41ef"></a>orgtrello/do-create-simple-entity<br />
<div class="outline-text-5" id="text-5-4-4-1">
<p>
The orchestration to trigger the simple synchronization of an entity (without any arborescence):
</p>
<ul class="org-ul">
<li>compute the metadata (current, parent, grandparent) from the current org entry (this may be need if too deep level)</li>
<li>if there is some metadata
<ul class="org-ul">
<li>if this is an error message, transit the message</li>
<li>otherwise
<ul class="org-ul">
<li>set the marker on org buffer for the current entry</li>
<li>compute and execute the http query</li>
<li>return a success message</li>
</ul></li>
</ul></li>
</ul>

<div class="org-src-container">
<pre class="src src-lisp" id="org57cbffe">(<span style="color: #3a81c3; font-weight: bold;">defun</span> <span style="color: #6c3163; font-weight: bold;">orgtrello/do-create-simple-entity</span> (<span style="color: #ba2f59; font-weight: bold;">&amp;optional</span> sync)
  <span style="color: #da8b55;">"Do the actual simple creation of a card, checklist or task. Optionally, we can render the creation synchronous."</span>
  (<span style="color: #3a81c3; font-weight: bold;">let</span> ((entry-metadata (orgtrello-data/entry-get-full-metadata)))
    (<span style="color: #3a81c3; font-weight: bold;">if</span> entry-metadata
        (<span style="color: #3a81c3; font-weight: bold;">let</span> ((query-http-or-error-msg (orgtrello/--dispatch-create (gethash <span style="color: #3a81c3;">:current</span> entry-metadata) (gethash <span style="color: #3a81c3;">:parent</span> entry-metadata) (gethash <span style="color: #3a81c3;">:grandparent</span> entry-metadata))))
          (<span style="color: #3a81c3; font-weight: bold;">if</span> (hash-table-p query-http-or-error-msg)
              <span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">if it's a hash-table we can do the sync</span>
              (<span style="color: #3a81c3; font-weight: bold;">progn</span>
                <span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">set the consumer-key to make a pointer to get back to when the request is finished</span>
                (orgtrello/--set-marker)
                <span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">request</span>
                (orgtrello-query/http query-http-or-error-msg sync 'orgtrello-query/--post-put-success-callback-update-id)
                <span style="color: #2d9574;">"Synchronizing simple entity done!"</span>)
            <span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">else it's a string to display</span>
            query-http-or-error-msg)))))

</pre>
</div>
</div>
</li>

<li><a id="org1cc8bcf"></a>creation/update routine<br />
<div class="outline-text-5" id="text-5-4-4-2">
<p>
Those functions does not actually do any request, they compute the map representing the request.
</p>
</div>
<ol class="org-ol">
<li><a id="orged076ca"></a>card<br />
<ol class="org-ol">
<li><a id="orgb0537b6"></a>orgtrello/&#x2013;card<br />
<div class="outline-text-7" id="text-5-4-4-2-1-1">
<p>
This is the main entry to create/update a card.
There is a series of check done by the <code>orgtrello/--checks-before-sync-card</code> function.
If ok, then we can continue with the main intent of the function.
We extract from the metadata the:
</p>
<ul class="org-ul">
<li>keyword status of the card (TODO, DONE, etc&#x2026;)</li>
<li>trello list identifier to which the card belongs to (depending on the keyword status)</li>
<li>card's identifier</li>
<li>card's name</li>
<li>card's due</li>
</ul>

<p>
Then we create or update the card depending on the presence or not of the card identifier.
if card id present update else create.
</p>

<div class="org-src-container">
<pre class="src src-lisp" id="org1622af1">(<span style="color: #3a81c3; font-weight: bold;">defun</span> <span style="color: #6c3163; font-weight: bold;">orgtrello/--card</span> (card-meta <span style="color: #ba2f59; font-weight: bold;">&amp;optional</span> parent-meta grandparent-meta)
  <span style="color: #da8b55;">"Deal with create/update card query build. If the checks are ko, the error message is returned."</span>
  (<span style="color: #3a81c3; font-weight: bold;">let</span> ((checks-ok-or-error-message (orgtrello/--checks-before-sync-card card-meta)))
    <span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">title is mandatory</span>
    (<span style="color: #3a81c3; font-weight: bold;">if</span> (equal <span style="color: #3a81c3;">:ok</span> checks-ok-or-error-message)
        <span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">parent and grandparent are useless here</span>
        (<span style="color: #3a81c3; font-weight: bold;">let*</span> ((orgtrello/--card-kwd  (orgtrello/--retrieve-state-of-card card-meta))
               (orgtrello/--list-id   (assoc-default orgtrello/--card-kwd org-file-properties))
               (orgtrello/--card-id   (orgtrello/--id    card-meta))
               (orgtrello/--card-name (orgtrello/--label card-meta))
               (orgtrello/--card-due  (orgtrello/--due   card-meta)))
          (<span style="color: #3a81c3; font-weight: bold;">if</span> orgtrello/--card-id
              <span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">update</span>
              (orgtrello-api/move-card orgtrello/--card-id orgtrello/--list-id orgtrello/--card-name orgtrello/--card-due)
            <span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">create</span>
            (orgtrello-api/add-card orgtrello/--card-name orgtrello/--list-id orgtrello/--card-due)))
      checks-ok-or-error-message)))

</pre>
</div>
</div>
</li>
<li><a id="org22fb8d0"></a>orgtrello/&#x2013;retrieve-state-of-card<br />
<div class="outline-text-7" id="text-5-4-4-2-1-2">
<p>
This function helps computes the status of the card.
If no status is present, TODO is assumed.
</p>

<div class="org-src-container">
<pre class="src src-lisp" id="org93d24cc">(<span style="color: #3a81c3; font-weight: bold;">defun</span> <span style="color: #6c3163; font-weight: bold;">orgtrello/--retrieve-state-of-card</span> (card-meta)
  <span style="color: #da8b55;">"Given a card, retrieve its state depending on its :keyword metadata. If empty or no keyword then, its equivalence is *TODO*, otherwise, return its current state."</span>
  (<span style="color: #3a81c3; font-weight: bold;">let*</span> ((orgtrello/--card-kwd (orgtrello/--keyword card-meta *TODO*)))
    (<span style="color: #3a81c3; font-weight: bold;">if</span> orgtrello/--card-kwd orgtrello/--card-kwd *TODO*)))

</pre>
</div>
</div>
</li>

<li><a id="org3283980"></a>orgtrello/&#x2013;checks-before-sync-card<br />
<div class="outline-text-7" id="text-5-4-4-2-1-3">
<p>
Does some basic checks. Typically, here only the name/title/label is mandatory.
</p>

<div class="org-src-container">
<pre class="src src-lisp" id="orgfd3f942">(<span style="color: #3a81c3; font-weight: bold;">defun</span> <span style="color: #6c3163; font-weight: bold;">orgtrello/--checks-before-sync-card</span> (card-meta)
  <span style="color: #da8b55;">"Checks done before synchronizing the cards."</span>
  (<span style="color: #3a81c3; font-weight: bold;">let</span> ((orgtrello/--card-name (orgtrello/--label card-meta)))
    (<span style="color: #3a81c3; font-weight: bold;">if</span> orgtrello/--card-name
        <span style="color: #3a81c3;">:ok</span>
      <span style="color: #2d9574;">"Cannot synchronize the card - missing mandatory label. Skip it..."</span>)))

</pre>
</div>
</div>
</li>
</ol>
</li>

<li><a id="org03b8961"></a>checklist<br />
<ol class="org-ol">
<li><a id="org1421c41"></a>orgtrello/&#x2013;checklist<br />
<div class="outline-text-7" id="text-5-4-4-2-2-1">
<p>
The idea is similar than the card function.
First, checks using <i>orgtrello</i>&#x2013;checks-before-sync-checklist/ function.
If ok, continue otherwise return the error message.
Then extract the needed metadata:
</p>
<ul class="org-ul">
<li>checklist identifier (optional)</li>
<li>card identifier (mandatory, a checklist belongs to a card)</li>
<li>checklist name (mandatory)</li>
</ul>
<p>
Again, if checklist identifier present, we update otherwise we create.
</p>

<div class="org-src-container">
<pre class="src src-lisp" id="org7b137c1">(<span style="color: #3a81c3; font-weight: bold;">defun</span> <span style="color: #6c3163; font-weight: bold;">orgtrello/--checklist</span> (checklist-meta <span style="color: #ba2f59; font-weight: bold;">&amp;optional</span> card-meta grandparent-meta)
  <span style="color: #da8b55;">"Deal with create/update checklist query build. If the checks are ko, the error message is returned."</span>
  (<span style="color: #3a81c3; font-weight: bold;">let</span> ((checks-ok-or-error-message (orgtrello/--checks-before-sync-checklist checklist-meta card-meta)))
    <span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">title is mandatory</span>
    (<span style="color: #3a81c3; font-weight: bold;">if</span> (equal <span style="color: #3a81c3;">:ok</span> checks-ok-or-error-message)
        <span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">grandparent is useless here</span>
        (<span style="color: #3a81c3; font-weight: bold;">let*</span> ((orgtrello/--checklist-id   (orgtrello/--id checklist-meta))
               (orgtrello/--card-id        (orgtrello/--id card-meta))
               (orgtrello/--checklist-name (orgtrello/--label checklist-meta)))
          (<span style="color: #3a81c3; font-weight: bold;">if</span> orgtrello/--checklist-id
              <span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">update</span>
              (orgtrello-api/update-checklist orgtrello/--checklist-id orgtrello/--checklist-name)
            <span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">create</span>
            (orgtrello-api/add-checklist orgtrello/--card-id orgtrello/--checklist-name)))
      checks-ok-or-error-message)))

</pre>
</div>
</div>
</li>
<li><a id="org05ab6b9"></a>orgtrello/&#x2013;checks-before-sync-checklist<br />
<div class="outline-text-7" id="text-5-4-4-2-2-2">
<p>
A little more complex check are done.
We need to ensure:
</p>
<ul class="org-ul">
<li>the card's id is present</li>
<li>the checklist's name is present too.</li>
</ul>
<p>
If some are missing, send the error message corresponding.
</p>

<div class="org-src-container">
<pre class="src src-lisp" id="org80ec39c">(<span style="color: #3a81c3; font-weight: bold;">defun</span> <span style="color: #6c3163; font-weight: bold;">orgtrello/--checks-before-sync-checklist</span> (checklist-meta card-meta)
  <span style="color: #da8b55;">"Checks done before synchronizing the checklist."</span>
  (<span style="color: #3a81c3; font-weight: bold;">let</span> ((orgtrello/--checklist-name (orgtrello/--label checklist-meta))
        (orgtrello/--card-id        (orgtrello/--id card-meta)))
    (<span style="color: #3a81c3; font-weight: bold;">if</span> orgtrello/--checklist-name
        (<span style="color: #3a81c3; font-weight: bold;">if</span> orgtrello/--card-id
            <span style="color: #3a81c3;">:ok</span>
          <span style="color: #2d9574;">"Cannot synchronize the checklist - the card must be synchronized first. Skip it..."</span>)
      <span style="color: #2d9574;">"Cannot synchronize the checklist - missing mandatory label. Skip it..."</span>)))

</pre>
</div>
</div>
</li>
</ol>
</li>

<li><a id="org9bf36a3"></a>task/item<br />
<ol class="org-ol">
<li><a id="org0f6d388"></a>orgtrello/&#x2013;task<br />
<div class="outline-text-7" id="text-5-4-4-2-3-1">
<p>
Update the task/item.
First checks.
If ok, continue otherwise return the error message.
Metadata extracted:
</p>
<ul class="org-ul">
<li>task/item's id (optional)</li>
<li>checklist's id (mandatory)</li>
<li>card's id (mandatory)</li>
<li>task/item's name (mandatory)</li>
<li>checklist's state (trello api distinguish between the state at update time from the check status at creation time)</li>
<li>checklist's check status</li>
</ul>

<p>
Depending on the presence of the task/item's identifier, we update or create.
</p>

<div class="org-src-container">
<pre class="src src-lisp" id="org4e052a6">(<span style="color: #3a81c3; font-weight: bold;">defun</span> <span style="color: #6c3163; font-weight: bold;">orgtrello/--task</span> (task-meta <span style="color: #ba2f59; font-weight: bold;">&amp;optional</span> checklist-meta card-meta)
  <span style="color: #da8b55;">"Deal with create/update task query build. If the checks are ko, the error message is returned."</span>
  (<span style="color: #3a81c3; font-weight: bold;">let</span> ((checks-ok-or-error-message (orgtrello/--checks-before-sync-item task-meta checklist-meta card-meta)))
    <span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">title is mandatory</span>
    (<span style="color: #3a81c3; font-weight: bold;">if</span> (equal <span style="color: #3a81c3;">:ok</span> checks-ok-or-error-message)
        <span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">card-meta is only usefull for the update part</span>
        (<span style="color: #3a81c3; font-weight: bold;">let*</span> ((orgtrello/--task-id      (orgtrello/--id task-meta))
               (orgtrello/--checklist-id (orgtrello/--id checklist-meta))
               (orgtrello/--card-id      (orgtrello/--id card-meta))
               (orgtrello/--task-name    (orgtrello/--label task-meta))
               (orgtrello/--task-state   (orgtrello/--keyword task-meta))
               (orgtrello/--checklist-state    (orgtrello/--keyword checklist-meta)))

          (orgtrello/--update-item-according-to-checklist-status *ORGTRELLO-CHECKLIST-UPDATE-ITEMS* checklist-meta)
          <span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">update/create items</span>
          (<span style="color: #3a81c3; font-weight: bold;">if</span> orgtrello/--task-id
              <span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">update - rename, check or uncheck the task</span>
              (orgtrello-api/update-task orgtrello/--card-id orgtrello/--checklist-id orgtrello/--task-id orgtrello/--task-name (orgtrello/--task-compute-state *ORGTRELLO-CHECKLIST-UPDATE-ITEMS* orgtrello/--task-state orgtrello/--checklist-state))
            <span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">create</span>
            (orgtrello-api/add-tasks orgtrello/--checklist-id orgtrello/--task-name (orgtrello/--task-compute-check *ORGTRELLO-CHECKLIST-UPDATE-ITEMS* orgtrello/--task-state orgtrello/--checklist-state))))
      checks-ok-or-error-message)))

</pre>
</div>

<p>
Also, there is a sublety.
<b>ORGTRELLO-CHECKLIST-UPDATE-ITEMS</b> is a global setup that permits the override of the task/item's status (checked or not).
if <b>ORGTRELLO-CHECKLIST-UPDATE-ITEMS</b> is set to 't, this will override such setup.
Otherwise, the item's status is computed depending on org's keyword.
This means that if <b>ORGTRELLO-CHECKLIST-UPDATE-ITEMS</b> is 't, we need to update the buffer accordingly to such status since this will be synchronized on trello.
That's the responsibility of the function <i>orgtrello</i>&#x2013;update-item-according-to-checklist-status/.
</p>
</div>
</li>

<li><a id="org0ea7f07"></a>orgtrello/&#x2013;checks-before-sync-item<br />
<div class="outline-text-7" id="text-5-4-4-2-3-2">
<p>
The control function which ensures:
</p>
<ul class="org-ul">
<li>task/item's id</li>
<li>checklist's id</li>
<li>card's id</li>
</ul>
<p>
are presents.
If some are missing, the corresponding error message is sent, :ok otherwise.
</p>

<div class="org-src-container">
<pre class="src src-lisp" id="org6ee480d">(<span style="color: #3a81c3; font-weight: bold;">defun</span> <span style="color: #6c3163; font-weight: bold;">orgtrello/--checks-before-sync-item</span> (task-meta checklist-meta card-meta)
  <span style="color: #da8b55;">"Checks done before synchronizing the checklist."</span>
  (<span style="color: #3a81c3; font-weight: bold;">let</span> ((orgtrello/--task-name    (orgtrello/--label task-meta))
        (orgtrello/--checklist-id (orgtrello/--id checklist-meta))
        (orgtrello/--card-id      (orgtrello/--id card-meta)))
    (<span style="color: #3a81c3; font-weight: bold;">if</span> orgtrello/--task-name
        (<span style="color: #3a81c3; font-weight: bold;">if</span> orgtrello/--checklist-id
            (<span style="color: #3a81c3; font-weight: bold;">if</span> orgtrello/--card-id
                <span style="color: #3a81c3;">:ok</span>
              <span style="color: #2d9574;">"Cannot synchronize the item - the card must be synchronized first. Skip it..."</span>)
          <span style="color: #2d9574;">"Cannot synchronize the item - the checklist must be synchronized first. Skip it..."</span>)
      <span style="color: #2d9574;">"Cannot synchronize the item - missing mandatory label. Skip it..."</span>)))

</pre>
</div>
</div>
</li>

<li><a id="org6b9ca48"></a>orgtrello/&#x2013;task-compute-state-or-check<br />
<div class="outline-text-7" id="text-5-4-4-2-3-3">
<p>
An HOF (higher order function) that captures the computation of the state (update) or the check (create) of an item/task.
</p>
<div class="org-src-container">
<pre class="src src-lisp" id="org0e8c343">(<span style="color: #3a81c3; font-weight: bold;">defun</span> <span style="color: #6c3163; font-weight: bold;">orgtrello/--task-compute-state-or-check</span> (checklist-update-items-p task-state checklist-state possible-states)
  <span style="color: #da8b55;">"Compute the task's state/check (for creation/update). The 2 possible states are in the list possible states, first position is the 'checked' one, and second the unchecked one."</span>
  (<span style="color: #3a81c3; font-weight: bold;">let*</span> ((orgtrello/--task-checked   (first possible-states))
         (orgtrello/--task-unchecked (second possible-states)))
    (<span style="color: #3a81c3; font-weight: bold;">cond</span> ((and checklist-update-items-p (string= *DONE* checklist-state))                      orgtrello/--task-checked)
          ((and checklist-update-items-p (or checklist-state (string= *TODO* checklist-state))) orgtrello/--task-unchecked)
          ((string= *DONE* task-state)                                                          orgtrello/--task-checked)
          (t                                                                                    orgtrello/--task-unchecked))))

</pre>
</div>
</div>
</li>

<li><a id="orgd35576f"></a>orgtrello/&#x2013;task-compute-state<br />
<div class="outline-text-7" id="text-5-4-4-2-3-4">
<p>
A function to compute the state (update) of the task/item:
</p>
<ul class="org-ul">
<li>complete</li>
<li>incomplete</li>
</ul>

<p>
There is a subtlety here.
<i>checklist-update-items-p</i> represents a global setup to make the checklist's status more important than the current item/task's status.
</p>

<p>
Here is the truth table:
</p>

<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />
</colgroup>
<thead>
<tr>
<th scope="col" class="org-left">checklist-update-items-p</th>
<th scope="col" class="org-left">checklist's status</th>
<th scope="col" class="org-left">task/item's status</th>
<th scope="col" class="org-left">Result</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left">t</td>
<td class="org-left">c-st</td>
<td class="org-left">X</td>
<td class="org-left">(= c-st <b>DONE</b> "complete" "incomplete")</td>
</tr>

<tr>
<td class="org-left">nil</td>
<td class="org-left">X</td>
<td class="org-left">t-st</td>
<td class="org-left">(= t-st <b>DONE</b> "complete" "incomplete")</td>
</tr>
</tbody>
</table>
<p>
n
</p>
<div class="org-src-container">
<pre class="src src-lisp" id="orgbee5974">(<span style="color: #3a81c3; font-weight: bold;">defun</span> <span style="color: #6c3163; font-weight: bold;">orgtrello/--task-compute-state</span> (checklist-update-items-p task-state checklist-state)
  <span style="color: #da8b55;">"Compute the task's state (for creation)."</span>
  (orgtrello/--task-compute-state-or-check checklist-update-items-p task-state checklist-state '(<span style="color: #2d9574;">"complete"</span> <span style="color: #2d9574;">"incomplete"</span>)))

</pre>
</div>
</div>
</li>

<li><a id="orge228e88"></a>orgtrello/&#x2013;task-compute-check<br />
<div class="outline-text-7" id="text-5-4-4-2-3-5">
<p>
A function to compute the check status of the task/item:
</p>
<ul class="org-ul">
<li>t</li>
<li>nil</li>
</ul>

<p>
There is a subtlety here.
<i>checklist-update-items-p</i> represents a global setup to make the checklist's status more important than the current item/task's status.
</p>

<p>
Here is the truth table:
</p>

<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />
</colgroup>
<thead>
<tr>
<th scope="col" class="org-left">checklist-update-items-p</th>
<th scope="col" class="org-left">checklist's status</th>
<th scope="col" class="org-left">task/item's check status</th>
<th scope="col" class="org-left">Result</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left">t</td>
<td class="org-left">c-st</td>
<td class="org-left">X</td>
<td class="org-left">(= c-st <b>DONE</b> t nil)</td>
</tr>

<tr>
<td class="org-left">nil</td>
<td class="org-left">X</td>
<td class="org-left">t-st</td>
<td class="org-left">(= t-st <b>DONE</b> t nil)</td>
</tr>
</tbody>
</table>

<div class="org-src-container">
<pre class="src src-lisp" id="org06fe0a0">(<span style="color: #3a81c3; font-weight: bold;">defun</span> <span style="color: #6c3163; font-weight: bold;">orgtrello/--task-compute-check</span> (checklist-update-items-p task-state checklist-state)
  <span style="color: #da8b55;">"Compute the task's check status (for update)."</span>
    (orgtrello/--task-compute-state-or-check checklist-update-items-p task-state checklist-state '(t nil)))

</pre>
</div>
</div>
</li>

<li><a id="orgf26e704"></a>orgtrello/&#x2013;update-item-according-to-checklist-status<br />
<div class="outline-text-7" id="text-5-4-4-2-3-6">
<p>
This is a function, depending on <i>checklist-update-items-p</i>, which is in charge of aligning the status of the keyword in the org buffer according to the checklist's keyword.
if <i>checklist-update-items-p</i> is 't, then update else does nothing.
</p>

<div class="org-src-container">
<pre class="src src-lisp" id="org0caf348">(<span style="color: #3a81c3; font-weight: bold;">defun</span> <span style="color: #6c3163; font-weight: bold;">orgtrello/--update-item-according-to-checklist-status</span> (checklist-update-items-p checklist-meta)
  <span style="color: #da8b55;">"Update the item of the checklist according to the status of the checklist."</span>
  (<span style="color: #3a81c3; font-weight: bold;">if</span> checklist-update-items-p
      (<span style="color: #3a81c3; font-weight: bold;">let</span> ((orgtrello/--checklist-status (orgtrello/--compute-state-from-keyword (orgtrello/--keyword checklist-meta))))
        (org-todo orgtrello/--checklist-status))))

</pre>
</div>
</div>
</li>

<li><a id="org2eb025f"></a>orgtrello/&#x2013;compute-state-from-keyword<br />
<div class="outline-text-7" id="text-5-4-4-2-3-7">
<p>
Given a state, compute its org equivalent:
</p>

<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="org-left" />

<col  class="org-left" />
</colgroup>
<thead>
<tr>
<th scope="col" class="org-left">state</th>
<th scope="col" class="org-left">org</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left">nil</td>
<td class="org-left">""</td>
</tr>

<tr>
<td class="org-left">""</td>
<td class="org-left">""</td>
</tr>

<tr>
<td class="org-left"><b>DONE</b></td>
<td class="org-left"><b>DONE</b></td>
</tr>

<tr>
<td class="org-left"><b>TODO</b></td>
<td class="org-left"><b>TODO</b></td>
</tr>

<tr>
<td class="org-left">Otherwise</td>
<td class="org-left"><b>TODO</b></td>
</tr>
</tbody>
</table>

<div class="org-src-container">
<pre class="src src-lisp" id="org7f31d29">(<span style="color: #3a81c3; font-weight: bold;">defun</span> <span style="color: #6c3163; font-weight: bold;">orgtrello/--compute-state-from-keyword</span> (state)
  <span style="color: #da8b55;">"Given a state, compute the org equivalent (to use with org-todo function)"</span>
  (<span style="color: #3a81c3; font-weight: bold;">cond</span> ((or (not state) (string= <span style="color: #2d9574;">""</span> state)) *TODO*)
        ((string= *DONE* state)              'done)
        ((string= *TODO* state)              *TODO*)
        (t                                   *TODO*)))

</pre>
</div>
</div>
</li>
</ol>
</li>
</ol>
</li>

<li><a id="orgcfded4e"></a>orgtrello/&#x2013;too-deep-level<br />
<div class="outline-text-5" id="text-5-4-4-3">
<p>
A function which simply displays that the arborescence depth is too deep.
We only deal with 3 levels (1 -&gt; card, 2 -&gt; checklist, 3 -&gt; item/task).
</p>

<div class="org-src-container">
<pre class="src src-lisp" id="org51d1733">(<span style="color: #3a81c3; font-weight: bold;">defun</span> <span style="color: #6c3163; font-weight: bold;">orgtrello/--too-deep-level</span> (meta <span style="color: #ba2f59; font-weight: bold;">&amp;optional</span> parent-meta grandparent-meta)
  <span style="color: #da8b55;">"Deal with too deep level."</span>
  <span style="color: #2d9574;">"Your arborescence depth is too deep. We only support up to depth 3.\nLevel 1 - card\nLevel 2 - checklist\nLevel 3 - items/tasks"</span>)

</pre>
</div>
</div>
</li>

<li><a id="org21db5eb"></a>orgtrello/&#x2013;dispatch-map-creation<br />
<div class="outline-text-5" id="text-5-4-4-4">
<p>
An initialization of the dispatch creation/update function depending on the level (1, 2, 3).
We use this function to initialize once the <b>MAP-DISPATCH-CREATE-UPDATE</b> which will be use to dispatch on the level of the entity to sync.
</p>

<div class="org-src-container">
<pre class="src src-lisp" id="org2bde785">(<span style="color: #3a81c3; font-weight: bold;">defun</span> <span style="color: #6c3163; font-weight: bold;">orgtrello/--dispatch-map-creation</span> ()
  <span style="color: #da8b55;">"Dispatch map for the creation of card/checklist/item."</span>
  (<span style="color: #3a81c3; font-weight: bold;">let*</span> ((dispatch-map (make-hash-table <span style="color: #3a81c3;">:test</span> 'equal)))
    (puthash 1 'orgtrello/--card      dispatch-map)
    (puthash 2 'orgtrello/--checklist dispatch-map)
    (puthash 3 'orgtrello/--task      dispatch-map)
    dispatch-map))

(<span style="color: #3a81c3; font-weight: bold;">defvar</span> <span style="color: #715ab1;">*MAP-DISPATCH-CREATE-UPDATE*</span> (orgtrello/--dispatch-map-creation) <span style="color: #da8b55;">"Dispatch map for the creation/update of card/checklist/task"</span>)

</pre>
</div>
</div>
</li>

<li><a id="org13f0a38"></a>orgtrello/&#x2013;set-marker<br />
<div class="outline-text-5" id="text-5-4-4-5">
<p>
A simple routine to install an orgtrello-marker before launching any synchronization.
</p>

<div class="org-src-container">
<pre class="src src-lisp" id="orge234a9b">(<span style="color: #3a81c3; font-weight: bold;">defun</span> <span style="color: #6c3163; font-weight: bold;">orgtrello/--set-marker</span> ()
  <span style="color: #da8b55;">"Set the consumer-key to make a pointer to get back to when the request is finished"</span>
  (org-set-property *ORGTRELLO-MARKER* *ORGTRELLO-MARKER*))

</pre>
</div>
</div>
</li>

<li><a id="org3a77638"></a>orgtrello/&#x2013;dispatch-create<br />
<div class="outline-text-5" id="text-5-4-4-6">
<p>
The function which will extract the current level of the entity and call the function to generate the create/update request for the current entity.
</p>

<div class="org-src-container">
<pre class="src src-lisp" id="org6403fb0">(<span style="color: #3a81c3; font-weight: bold;">defun</span> <span style="color: #6c3163; font-weight: bold;">orgtrello/--dispatch-create</span> (meta <span style="color: #ba2f59; font-weight: bold;">&amp;optional</span> parent-meta grandparent-meta)
  (<span style="color: #3a81c3; font-weight: bold;">let*</span> ((level       (orgtrello/--level meta))
         (dispatch-fn (gethash level *MAP-DISPATCH-CREATE-UPDATE* 'orgtrello/--too-deep-level)))
    <span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">then execute the call</span>
    (funcall dispatch-fn meta parent-meta grandparent-meta)))

</pre>
</div>
</div>
</li>
</ol>
</li>

<li><a id="orga8b6a0b"></a>Create complex entity<br />
<ol class="org-ol">
<li><a id="orgfe6bd28"></a>orgtrello/&#x2013;board-name<br />
<div class="outline-text-5" id="text-5-4-5-1">
<p>
Extract the board name from the org buffer's metadata.
</p>

<div class="org-src-container">
<pre class="src src-lisp" id="org146e9bf">(<span style="color: #3a81c3; font-weight: bold;">defun</span> <span style="color: #6c3163; font-weight: bold;">orgtrello/--board-name</span> ()
  <span style="color: #da8b55;">"Compute the board's name"</span>
  (assoc-default *BOARD-NAME* org-file-properties))

</pre>
</div>
</div>
</li>

<li><a id="org659812f"></a>orgtrello/do-create-complex-entity<br />
<div class="outline-text-5" id="text-5-4-5-2">
<p>
The main function in charge of synchronizing the entity (with its arborescence):
</p>
<ul class="org-ul">
<li>Get back to the upper level of the current entry</li>
<li>Map over the full arborescence (in order) and sync the entity (using the primitive <i>orgtrello/do-create-simple-entity</i>)</li>
<li>Return a success message</li>
</ul>

<div class="org-src-container">
<pre class="src src-lisp" id="orgf3924ae">(<span style="color: #3a81c3; font-weight: bold;">defun</span> <span style="color: #6c3163; font-weight: bold;">orgtrello/do-create-complex-entity</span> ()
  <span style="color: #da8b55;">"Do the actual full card creation - from card to task. Beware full side effects..."</span>
  (<span style="color: #3a81c3; font-weight: bold;">let</span> ((orgtrello/--board-name-to-sync (orgtrello/--board-name)))
    (message <span style="color: #2d9574;">"Synchronizing full entity with its structure on board '%s'..."</span> orgtrello/--board-name-to-sync)
    (save-excursion
      <span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">iterate over the map of</span>
      (org-map-tree (<span style="color: #3a81c3; font-weight: bold;">lambda</span> () (orgtrello/do-create-simple-entity t))))
    (format <span style="color: #2d9574;">"Synchronizing full entity with its structure on board '%s' - done"</span> orgtrello/--board-name-to-sync)))

</pre>
</div>
</div>
</li>
</ol>
</li>

<li><a id="org007e6ff"></a>Synchronize full org buffer to trello<br />
<div class="outline-text-4" id="text-5-4-6">
<p>
Synchronize the full org file to the trello board.
The idea is to send all the cards presents in the buffer to the trello board (no merge, org buffer has all the rights here).
At the end, return a success message.
</p>

<div class="org-src-container">
<pre class="src src-lisp" id="orgc7196dc">(<span style="color: #3a81c3; font-weight: bold;">defun</span> <span style="color: #6c3163; font-weight: bold;">orgtrello/do-sync-full-file</span> ()
  <span style="color: #da8b55;">"Full org-mode file synchronisation. Beware, this will block emacs as the request is synchronous."</span>
  (<span style="color: #3a81c3; font-weight: bold;">let</span> ((orgtrello/--board-name-to-sync (orgtrello/--board-name)))
    (message <span style="color: #2d9574;">"Synchronizing org-mode file to the board '%s'. This may take some time, some coffee may be a good idea..."</span> (orgtrello/--board-name))
    (org-map-entries (<span style="color: #3a81c3; font-weight: bold;">lambda</span> () (orgtrello/do-create-simple-entity t)) t 'file)
    (format <span style="color: #2d9574;">"Synchronizing org-mode file to the board '%s' - done!"</span> orgtrello/--board-name-to-sync)))

</pre>
</div>
</div>
</li>

<li><a id="orgdeedad2"></a>Synchronize full org buffer from trello<br />
<div class="outline-text-4" id="text-5-4-7">
<p>
Synchronize the full org file from the trello board.
The idea is to compute all the trello cards from trello.
Map over the current org buffer, synchronize from trello (no merge, trello has all power here) and overwrite the trello data for each entry.
Each data remaining not already present on the buffer are then dumped in the current buffer.
</p>
</div>

<ol class="org-ol">
<li><a id="orga70edbc"></a>orgtrello/do-sync-full-from-trello<br />
<div class="outline-text-5" id="text-5-4-7-1">
<p>
Main function:
</p>
<ul class="org-ul">
<li>retrieve the board id from the org metadata</li>
<li>compute the cards from the trello board</li>
<li>synchronize all the entities present on the buffer with the data from trello (remove them as soon as they are synced)</li>
<li>synchronize all the remaining entities into the current buffer</li>
<li>return a successfull message</li>
</ul>

<div class="org-src-container">
<pre class="src src-lisp" id="orge25e1bf">(<span style="color: #3a81c3; font-weight: bold;">defun</span> <span style="color: #6c3163; font-weight: bold;">orgtrello/do-sync-full-from-trello</span> ()
  <span style="color: #da8b55;">"Full org-mode file synchronisation. Beware, this will block emacs as the request is synchronous."</span>
  (<span style="color: #3a81c3; font-weight: bold;">let</span> ((orgtrello/--board-name-to-sync (orgtrello/--board-name)))
    (message <span style="color: #2d9574;">"Synchronizing the trello board '%s' to the org-mode file. This may take a moment, some coffee may be a good idea..."</span> orgtrello/--board-name-to-sync)
    (<span style="color: #3a81c3; font-weight: bold;">let*</span> ((orgtrello/--board-id           (assoc-default *BOARD-ID* org-file-properties))
           (orgtrello/--cards              (orgtrello-query/http (orgtrello-api/get-cards orgtrello/--board-id) t))
           (orgtrello/--entities-hash-map  (orgtrello/--compute-full-entities-from-trello orgtrello/--cards))
           (orgtrello/--remaining-entities (orgtrello/--sync-buffer-with-trello-data orgtrello/--entities-hash-map)))
      (orgtrello/--update-buffer-with-remaining-trello-data orgtrello/--remaining-entities))
    (format <span style="color: #2d9574;">"Synchronizing the trello board '%s' to the org-mode file - done!"</span> orgtrello/--board-name-to-sync)))

</pre>
</div>
</div>
</li>

<li><a id="orga86d302"></a>orgtrello/&#x2013;sync-buffer-with-trello-data<br />
<div class="outline-text-5" id="text-5-4-7-2">
<p>
Given a map of entities to sync, update each entry with such data.
After each entry update, the entity is removed.
Return the map of entities with the sync entry removed.
</p>

<div class="org-src-container">
<pre class="src src-lisp" id="org9b0c2ca">(<span style="color: #3a81c3; font-weight: bold;">defun</span> <span style="color: #6c3163; font-weight: bold;">orgtrello/--sync-buffer-with-trello-data</span> (entities)
  <span style="color: #da8b55;">"Given all the entities, update the current buffer with those."</span>
  (with-current-buffer (current-buffer)
    (org-map-entries
     (<span style="color: #3a81c3; font-weight: bold;">lambda</span> ()
       (<span style="color: #3a81c3; font-weight: bold;">let</span> ((entry-metadata (orgtrello-data/entry-get-full-metadata)))
         (<span style="color: #3a81c3; font-weight: bold;">if</span> entry-metadata <span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">if level &gt; 4, entry-metadata is not considered as this is not represented in trello board</span>
             <span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">will search 'entities' hash table for updates (do not compute diffs, take them as is)</span>
             (<span style="color: #3a81c3; font-weight: bold;">let*</span> ((orgtrello/--entity         (gethash <span style="color: #3a81c3;">:current</span> entry-metadata))
                    (orgtrello/--entity-id      (orgtrello/--id orgtrello/--entity))
                    (orgtrello/--entity-updated (gethash orgtrello/--entity-id entities)))
               (<span style="color: #3a81c3; font-weight: bold;">if</span> orgtrello/--entity-updated
                   <span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">found something, we update by squashing the current contents</span>
                   (<span style="color: #3a81c3; font-weight: bold;">let*</span> ((orgtrello/--entry-new-id    (orgtrello-query/--id   orgtrello/--entity-updated))
                          (orgtrello/--entity-due-date (orgtrello-query/--due  orgtrello/--entity-updated))
                          (orgtrello/--entry-new-name  (orgtrello-query/--name orgtrello/--entity-updated)))
                     <span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">update the buffer with the new updates (there may be none but naively we will overwrite at the moment)</span>
                     (message <span style="color: #2d9574;">"Synchronizing entity '%s' with id '%s'..."</span> orgtrello/--entry-new-name orgtrello/--entry-new-id)
                     (org-show-entry)
                     (kill-whole-line)
                     (<span style="color: #3a81c3; font-weight: bold;">if</span> orgtrello/--entity-due-date (kill-whole-line))
                     (insert (orgtrello/--compute-entity-to-org-entry orgtrello/--entity-updated))
                     <span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">remove the entry from the hash-table</span>
                     (remhash orgtrello/--entity-id entities)))))))
     t
     'file))
  <span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">return the entities which has been dryed</span>
  entities)

</pre>
</div>
</div>
</li>

<li><a id="org4ac09ad"></a>orgtrello/&#x2013;update-buffer-with-remaining-trello-data<br />
<div class="outline-text-5" id="text-5-4-7-3">
<p>
Given a map of entities:
</p>
<ul class="org-ul">
<li>goes at the end of the file</li>
<li>add the entities present on such map in the org format</li>
<li>return at the beginning of the file</li>
<li>sort all the buffer on the org todo keywords order (only the first level -&gt; card).</li>
</ul>

<div class="org-src-container">
<pre class="src src-lisp" id="orgee08104">(<span style="color: #3a81c3; font-weight: bold;">defun</span> <span style="color: #6c3163; font-weight: bold;">orgtrello/--update-buffer-with-remaining-trello-data</span> (entities)
  <span style="color: #da8b55;">"Given a map of entities, dump those entities in the current buffer."</span>
  (<span style="color: #3a81c3; font-weight: bold;">if</span> entities <span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">could be empty</span>
      (with-current-buffer (current-buffer)
        <span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">go at the end of the file</span>
        (goto-char (point-max))
        <span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">dump the remaining entities</span>
        (maphash
         (<span style="color: #3a81c3; font-weight: bold;">lambda</span> (orgtrello/--entry-new-id orgtrello/--entity)
           (<span style="color: #3a81c3; font-weight: bold;">let</span> ((orgtrello/--entry-new-name  (orgtrello-query/--name orgtrello/--entity)))
             (message <span style="color: #2d9574;">"Synchronizing new entity '%s' with id '%s'..."</span> orgtrello/--entry-new-name orgtrello/--entry-new-id)
             (insert (orgtrello/--compute-entity-to-org-entry orgtrello/--entity))
             (org-set-property *ORGTRELLO-ID* orgtrello/--entry-new-id)))
         entities)
        (goto-char (point-min))
        (org-sort-entries t ?o))))

</pre>
</div>
</div>
</li>

<li><a id="org6a8fce2"></a>orgtrello/&#x2013;compute-card-status<br />
<div class="outline-text-5" id="text-5-4-7-4">
<p>
Given a card list id (which represent an org keyword), compute the keywords (this works with the metadata of the file).
</p>

<div class="org-src-container">
<pre class="src src-lisp" id="org1eef4cd">(<span style="color: #3a81c3; font-weight: bold;">defun</span> <span style="color: #6c3163; font-weight: bold;">orgtrello/--compute-card-status</span> (card-id-list)
  <span style="color: #da8b55;">"Given a card's id, compute its status."</span>
  (gethash card-id-list *HMAP-ID-NAME*))

</pre>
</div>
</div>
</li>

<li><a id="org26403dd"></a>orgtrello/&#x2013;compute-card-to-org-entry<br />
<div class="outline-text-5" id="text-5-4-7-5">
<p>
Given an entry which represents a card, compute its equivalent org format.
</p>

<div class="org-src-container">
<pre class="src src-lisp" id="org85552c5">(<span style="color: #3a81c3; font-weight: bold;">defun</span> <span style="color: #6c3163; font-weight: bold;">orgtrello/--compute-card-to-org-entry</span> (card)
  <span style="color: #da8b55;">"Given a card, compute its org-mode entry equivalence."</span>
  (<span style="color: #3a81c3; font-weight: bold;">let*</span> ((orgtrello/--card-name     (orgtrello-query/--name card))
         (orgtrello/--card-status   (orgtrello/--compute-card-status (orgtrello-query/--list-id card)))
         (orgtrello/--card-due-date (orgtrello-query/--due card)))
    (format <span style="color: #2d9574;">"* %s %s\n%s"</span> orgtrello/--card-status orgtrello/--card-name
            (<span style="color: #3a81c3; font-weight: bold;">if</span> orgtrello/--card-due-date (format <span style="color: #2d9574;">"DEADLINE: &lt;%s&gt;\n"</span> orgtrello/--card-due-date) <span style="color: #2d9574;">""</span>))))

</pre>
</div>
</div>
</li>

<li><a id="org1619d05"></a>orgtrello/&#x2013;compute-checklist-to-org-entry<br />
<div class="outline-text-5" id="text-5-4-7-6">
<p>
Given an entry which represents a checklist, compute its equivalent org format.
</p>

<div class="org-src-container">
<pre class="src src-lisp" id="orgf30489b">(<span style="color: #3a81c3; font-weight: bold;">defun</span> <span style="color: #6c3163; font-weight: bold;">orgtrello/--compute-checklist-to-org-entry</span> (checklist)
  <span style="color: #da8b55;">"Given a checklist, compute its org-mode entry equivalence."</span>
  (<span style="color: #3a81c3; font-weight: bold;">let</span> ((orgtrello/--checklist-name  (orgtrello-query/--name checklist)))
    (format <span style="color: #2d9574;">"** %s\n"</span> orgtrello/--checklist-name)))

</pre>
</div>
</div>
</li>

<li><a id="org8784ddd"></a>orgtrello/&#x2013;compute-item-to-org-entry<br />
<div class="outline-text-5" id="text-5-4-7-7">
<p>
Given an entry which represents an item/task, compute its equivalent org format.
</p>

<div class="org-src-container">
<pre class="src src-lisp" id="orgf7f92a6">(<span style="color: #3a81c3; font-weight: bold;">defun</span> <span style="color: #6c3163; font-weight: bold;">orgtrello/--compute-item-to-org-entry</span> (item)
  <span style="color: #da8b55;">"Given a checklist item, compute its org-mode entry equivalence."</span>
  (<span style="color: #3a81c3; font-weight: bold;">let*</span> ((orgtrello/--item-name  (orgtrello-query/--name  item))
         (orgtrello/--item-state (orgtrello-query/--state item)))
    (format <span style="color: #2d9574;">"*** %s %s\n"</span>
            (<span style="color: #3a81c3; font-weight: bold;">if</span> (string= <span style="color: #2d9574;">"complete"</span> orgtrello/--item-state) *DONE* *TODO*)
            orgtrello/--item-name)))

</pre>
</div>
</div>
</li>

<li><a id="orgff178c4"></a>orgtrello/&#x2013;compute-entity-to-org-entry<br />
<div class="outline-text-5" id="text-5-4-7-8">
<p>
Given an entry, determine according to its structure the nature of such entity:
</p>
<ul class="org-ul">
<li>list-id, it's a card</li>
<li>card-id, it's a checklist</li>
<li>state, it's an item/task</li>
</ul>

<div class="org-src-container">
<pre class="src src-lisp" id="org078f764">(<span style="color: #3a81c3; font-weight: bold;">defun</span> <span style="color: #6c3163; font-weight: bold;">orgtrello/--compute-entity-to-org-entry</span> (entity)
  <span style="color: #da8b55;">"Given an entity, compute its org representation."</span>
  (<span style="color: #3a81c3; font-weight: bold;">cond</span> ((orgtrello-query/--list-id entity) (orgtrello/--compute-card-to-org-entry entity))           <span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">card      (level 1)</span>
        ((orgtrello-query/--card-id entity) (orgtrello/--compute-checklist-to-org-entry entity))      <span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">checklist (level 2)</span>
        ((orgtrello-query/--state entity)  (orgtrello/--compute-item-to-org-entry entity))))          <span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">items     (level 3)</span>

</pre>
</div>
</div>
</li>

<li><a id="org2a854b3"></a>orgtrello/&#x2013;do-retrieve-checklists-from-card<br />
<div class="outline-text-5" id="text-5-4-7-9">
<p>
Given a card, retrieve its full checklist and return a list composed of the card cons'ed to such entities.
</p>

<div class="org-src-container">
<pre class="src src-lisp" id="orga6fdd78">(<span style="color: #3a81c3; font-weight: bold;">defun</span> <span style="color: #6c3163; font-weight: bold;">orgtrello/--do-retrieve-checklists-from-card</span> (card)
  <span style="color: #da8b55;">"Given a card, return the list containing the card, the checklists from this card, and the items from the checklists. The order is guaranted."</span>
  (cl-reduce
   (<span style="color: #3a81c3; font-weight: bold;">lambda</span> (acc-list checklist-id)
     (<span style="color: #3a81c3; font-weight: bold;">let</span> ((orgtrello/--checklist (orgtrello-query/http (orgtrello-api/get-checklist checklist-id) t)))
       (append (cons orgtrello/--checklist (orgtrello/--do-retrieve-checklists-and-items orgtrello/--checklist)) acc-list)))
   (orgtrello-query/--checklist-ids card)
   <span style="color: #3a81c3;">:initial-value</span> nil))

</pre>
</div>
</div>
</li>

<li><a id="org4116e75"></a>orgtrello/&#x2013;do-retrieve-checklists-and-items<br />
<div class="outline-text-5" id="text-5-4-7-10">
<p>
Given a checklist, retrieve its full items/tasks and return a list composed of the checklist cons'ed to such entities.
</p>

<div class="org-src-container">
<pre class="src src-lisp" id="orga1677dc">(<span style="color: #3a81c3; font-weight: bold;">defun</span> <span style="color: #6c3163; font-weight: bold;">orgtrello/--do-retrieve-checklists-and-items</span> (checklist)
  <span style="color: #da8b55;">"Given a checklist id, retrieve all the items from the checklist and return a list containing first the checklist, then the items."</span>
  (--map it (orgtrello-query/--check-items checklist)))

</pre>
</div>
</div>
</li>

<li><a id="orgb72f334"></a>orgtrello/&#x2013;compute-full-entities-from-trello<br />
<div class="outline-text-5" id="text-5-4-7-11">
<p>
Given a list of cards, retrieve the full arborescence of such cards (computing their checklists and items/tasks) and return a map of entities.
</p>

<div class="org-src-container">
<pre class="src src-lisp" id="orgc847067">(<span style="color: #3a81c3; font-weight: bold;">defun</span> <span style="color: #6c3163; font-weight: bold;">orgtrello/--compute-full-entities-from-trello</span> (cards)
  <span style="color: #da8b55;">"Given a list of cards, compute the full cards data from the trello boards. The order from the trello board is now kept."</span>
  <span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">will compute the hash-table of entities (id, entity)</span>
  (cl-reduce
   (<span style="color: #3a81c3; font-weight: bold;">lambda</span> (orgtrello/--acc-hash orgtrello/--entity-card)
     (message <span style="color: #2d9574;">"Computing card '%s' data..."</span> (orgtrello-query/--name orgtrello/--entity-card))
     <span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">adding the entity card</span>
     (puthash (orgtrello-query/--id orgtrello/--entity-card) orgtrello/--entity-card orgtrello/--acc-hash)
     <span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">fill in the other remaining entities (checklist/items)</span>
     (mapc
      (<span style="color: #3a81c3; font-weight: bold;">lambda</span> (it)
        (puthash (orgtrello-query/--id it) it orgtrello/--acc-hash))
      (orgtrello/--do-retrieve-checklists-from-card orgtrello/--entity-card))
     orgtrello/--acc-hash)
   cards
   <span style="color: #3a81c3;">:initial-value</span> (make-hash-table <span style="color: #3a81c3;">:test</span> 'equal)))

</pre>
</div>
</div>
</li>
</ol>
</li>

<li><a id="orgef8817e"></a>Delete entity<br />
<ol class="org-ol">
<li><a id="orge2fceff"></a>orgtrello/do-delete-simple<br />
<div class="outline-text-5" id="text-5-4-8-1">
<p>
The main function to delete the current entity.
This checks if the id is present.
If not present, return an error message explaining the entity must be synced first.
Otherwise, execute the trello deletion.
Return a message of success.
</p>

<div class="org-src-container">
<pre class="src src-lisp" id="org9695c3a">(<span style="color: #3a81c3; font-weight: bold;">defun</span> <span style="color: #6c3163; font-weight: bold;">orgtrello/do-delete-simple</span> (<span style="color: #ba2f59; font-weight: bold;">&amp;optional</span> sync)
  <span style="color: #da8b55;">"Do the simple deletion of a card, checklist or task."</span>
  (<span style="color: #3a81c3; font-weight: bold;">let*</span> ((entry-metadata   (orgtrello-data/entry-get-full-metadata))
         (current-metadata (gethash <span style="color: #3a81c3;">:current</span> entry-metadata))
         (id               (orgtrello/--id current-metadata)))
    (<span style="color: #3a81c3; font-weight: bold;">if</span> (and current-metadata id)
        (<span style="color: #3a81c3; font-weight: bold;">let</span> ((query-http-or-error-msg (orgtrello/--dispatch-delete (gethash <span style="color: #3a81c3;">:current</span> entry-metadata) (gethash <span style="color: #3a81c3;">:parent</span> entry-metadata))))
          (<span style="color: #3a81c3; font-weight: bold;">if</span> (hash-table-p query-http-or-error-msg)
              (<span style="color: #3a81c3; font-weight: bold;">progn</span>
                (orgtrello-query/http query-http-or-error-msg sync 'orgtrello-query/--delete-success-callback)
                <span style="color: #2d9574;">"Delete entity done!"</span>)
            query-http-or-error-msg))
      <span style="color: #2d9574;">"Entity not synchronized on trello yet!"</span>)))

</pre>
</div>
</div>
</li>
<li><a id="org4c3e96b"></a>orgtrello/&#x2013;dispatch-map-delete<br />
<div class="outline-text-5" id="text-5-4-8-2">
<p>
The computation of the <b>MAP-DISPATCH-DELETE</b> which will be used to dispatch the deletion of an entity.
</p>

<div class="org-src-container">
<pre class="src src-lisp" id="org17c7ffa">(<span style="color: #3a81c3; font-weight: bold;">defun</span> <span style="color: #6c3163; font-weight: bold;">orgtrello/--dispatch-map-delete</span> ()
  <span style="color: #da8b55;">"Dispatch map for the deletion of card/checklist/item."</span>
  (<span style="color: #3a81c3; font-weight: bold;">let*</span> ((dispatch-map (make-hash-table <span style="color: #3a81c3;">:test</span> 'equal)))
    (puthash 1 'orgtrello/--card-delete      dispatch-map)
    (puthash 2 'orgtrello/--checklist-delete dispatch-map)
    (puthash 3 'orgtrello/--task-delete      dispatch-map)
    dispatch-map))

(<span style="color: #3a81c3; font-weight: bold;">defvar</span> <span style="color: #715ab1;">*MAP-DISPATCH-DELETE*</span> (orgtrello/--dispatch-map-delete) <span style="color: #da8b55;">"Dispatch map for the deletion query of card/checklist/task."</span>)

</pre>
</div>
</div>
</li>

<li><a id="org822ef6d"></a>orgtrello/&#x2013;dispatch-delete<br />
<div class="outline-text-5" id="text-5-4-8-3">
<p>
The actual entity deletion using the <b>MAP-DISPATCH-DELETE</b> as a dispatch function.
</p>

<div class="org-src-container">
<pre class="src src-lisp" id="orgaec28f7">(<span style="color: #3a81c3; font-weight: bold;">defun</span> <span style="color: #6c3163; font-weight: bold;">orgtrello/--dispatch-delete</span> (meta <span style="color: #ba2f59; font-weight: bold;">&amp;optional</span> parent-meta)
  (<span style="color: #3a81c3; font-weight: bold;">let*</span> ((level       (orgtrello/--level meta))
         (dispatch-fn (gethash level *MAP-DISPATCH-DELETE* 'orgtrello/--too-deep-level)))
    (funcall dispatch-fn meta parent-meta)))

</pre>
</div>
</div>
</li>

<li><a id="orgcd9ecb6"></a>orgtrello/&#x2013;card-delete<br />
<div class="outline-text-5" id="text-5-4-8-4">
<p>
Specific card deletion request computation.
</p>

<div class="org-src-container">
<pre class="src src-lisp" id="org9ac3694">(<span style="color: #3a81c3; font-weight: bold;">defun</span> <span style="color: #6c3163; font-weight: bold;">orgtrello/--card-delete</span> (card-meta <span style="color: #ba2f59; font-weight: bold;">&amp;optional</span> parent-meta)
  <span style="color: #da8b55;">"Deal with the deletion query of a card"</span>
  <span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">parent is useless here</span>
  (orgtrello-api/delete-card (orgtrello/--id card-meta)))

</pre>
</div>
</div>
</li>

<li><a id="org838f063"></a>orgtrello/&#x2013;checklist-delete<br />
<div class="outline-text-5" id="text-5-4-8-5">
<p>
Specific checklist deletion request computation.
</p>

<div class="org-src-container">
<pre class="src src-lisp" id="orgca4230a">(<span style="color: #3a81c3; font-weight: bold;">defun</span> <span style="color: #6c3163; font-weight: bold;">orgtrello/--checklist-delete</span> (checklist-meta <span style="color: #ba2f59; font-weight: bold;">&amp;optional</span> parent-meta)
  <span style="color: #da8b55;">"Deal with the deletion query of a checklist"</span>
  <span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">parent is useless here</span>
  (orgtrello-api/delete-checklist (orgtrello/--id checklist-meta)))

</pre>
</div>
</div>
</li>

<li><a id="org26cb748"></a>orgtrello/&#x2013;task-delete<br />
<div class="outline-text-5" id="text-5-4-8-6">
<p>
Specific task/item deletion request computation.
</p>

<div class="org-src-container">
<pre class="src src-lisp" id="org5db6987">(<span style="color: #3a81c3; font-weight: bold;">defun</span> <span style="color: #6c3163; font-weight: bold;">orgtrello/--task-delete</span> (task-meta <span style="color: #ba2f59; font-weight: bold;">&amp;optional</span> checklist-meta)
  <span style="color: #da8b55;">"Deal with create/update task query build"</span>
  (<span style="color: #3a81c3; font-weight: bold;">let*</span> ((orgtrello/--task-id      (orgtrello/--id task-meta))
         (orgtrello/--checklist-id (orgtrello/--id checklist-meta)))
    (orgtrello-api/delete-task orgtrello/--checklist-id orgtrello/--task-id)))

</pre>
</div>
</div>
</li>
</ol>
</li>

<li><a id="orgb720bcf"></a>Install key and token configuration<br />
<ol class="org-ol">
<li><a id="orga9e3e80"></a>orgtrello/do-install-key-and-token<br />
<div class="outline-text-5" id="text-5-4-9-1">
<p>
First routine to ask input for the user:
</p>
<ul class="org-ul">
<li>open the consumer key page for the user to retrieve his/her consumer key.</li>
<li>then open the access token page to ask for the user to permit org-trello to act on her/his behalf.</li>
<li>at last, generate the config.el file inside his/her home.</li>
<li>return a successfull message</li>
</ul>

<div class="org-src-container">
<pre class="src src-lisp" id="org51f8ad1">(<span style="color: #3a81c3; font-weight: bold;">defun</span> <span style="color: #6c3163; font-weight: bold;">orgtrello/do-install-key-and-token</span> ()
  <span style="color: #da8b55;">"Procedure to install the *consumer-key* and the token for the user in the config-file."</span>
  (interactive)
  (browse-url <span style="color: #2d9574;">"https://trello.com/1/appKey/generate"</span>)
  (<span style="color: #3a81c3; font-weight: bold;">let</span> ((orgtrello/--*consumer-key* (read-string <span style="color: #2d9574;">"*consumer-key*: "</span>)))
    (browse-url (format <span style="color: #2d9574;">"https://trello.com/1/authorize?response_type=token&amp;name=org-trello&amp;scope=read,write&amp;expiration=never&amp;key=%s"</span> orgtrello/--*consumer-key*))
    (<span style="color: #3a81c3; font-weight: bold;">let</span> ((orgtrello/--access-token (read-string <span style="color: #2d9574;">"Access-token: "</span>)))
      (orgtrello/--do-install-config-file orgtrello/--*consumer-key* orgtrello/--access-token)
      <span style="color: #2d9574;">"Install key and read/write access token done!"</span>)))

</pre>
</div>
</div>
</li>

<li><a id="org2c8dead"></a>orgtrello/&#x2013;do-install-config-file<br />
<div class="outline-text-5" id="text-5-4-9-2">
<p>
Given a consumer-key and an access token, generate a <i>config.el</i> file.
</p>

<div class="org-src-container">
<pre class="src src-lisp" id="orge93146b">(<span style="color: #3a81c3; font-weight: bold;">defun</span> <span style="color: #6c3163; font-weight: bold;">orgtrello/--do-install-config-file</span> (*consumer-key* *access-token*)
  <span style="color: #da8b55;">"Persist the file config-file with the input of the user."</span>
  (make-directory *CONFIG-DIR* t)
  (with-temp-file *CONFIG-FILE*
    (erase-buffer)
    (goto-char (point-min))
    (insert (format <span style="color: #2d9574;">"(setq *consumer-key* \"%s\")\n"</span> *consumer-key*))
    (insert (format <span style="color: #2d9574;">"(setq *access-token* \"%s\")"</span> *access-token*))
    (write-file *CONFIG-FILE* 't)))

</pre>
</div>
</div>
</li>
</ol>
</li>


<li><a id="org7a6d8d2"></a>Install board and lists configuration<br />
<div class="outline-text-4" id="text-5-4-10">
<p>
The install board and lists configuration. There is an alternative to such setup with the create board routine.
</p>
</div>

<ol class="org-ol">
<li><a id="orgb440979"></a>orgtrello/do-install-board-and-lists<br />
<div class="outline-text-5" id="text-5-4-10-1">
<p>
Main routine to ask for the user's input to setup his/her board to attach to his/her current org buffer.
This:
</p>
<ul class="org-ul">
<li>generates a list of his/her current board from his/her trello's account.</li>
<li>ask for the user to input which board he/she wants to use</li>
<li>then generate the metadata regarding his/her choice to the org buffer's beginning</li>
<li>return a message of success</li>
</ul>

<div class="org-src-container">
<pre class="src src-lisp" id="orgf4ec6ed">(<span style="color: #3a81c3; font-weight: bold;">defun</span> <span style="color: #6c3163; font-weight: bold;">orgtrello/do-install-board-and-lists</span> ()
  <span style="color: #da8b55;">"Interactive command to install the list boards"</span>
  (interactive)
  (cl-destructuring-bind
      (orgtrello/--chosen-board-id orgtrello/--chosen-board-name) (-&gt; (orgtrello/--list-boards)
                                                                      orgtrello/--id-name
                                                                      orgtrello/--choose-board)
    (<span style="color: #3a81c3; font-weight: bold;">let</span> ((orgtrello/--board-lists-hname-id (-&gt; orgtrello/--chosen-board-id
                                                orgtrello/--list-board-lists
                                                orgtrello/--name-id)))
      <span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">remove any eventual present entry</span>
      (orgtrello/--remove-properties-file orgtrello/--board-lists-hname-id t)
      <span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">update with new ones</span>
      (orgtrello/update-orgmode-file-with-properties
       orgtrello/--chosen-board-name
       orgtrello/--chosen-board-id
       orgtrello/--board-lists-hname-id
       t)))
  <span style="color: #2d9574;">"Install board and list ids done!"</span>)

</pre>
</div>
</div>
</li>

<li><a id="orgf086852"></a>orgtrello/&#x2013;choose-board<br />
<div class="outline-text-5" id="text-5-4-10-2">
<p>
The routine that asks the user:
</p>
<ul class="org-ul">
<li>to select the board he/she wants to work with</li>
<li>return the list of board id, board name</li>
</ul>

<div class="org-src-container">
<pre class="src src-lisp" id="orgcb195c9">(<span style="color: #3a81c3; font-weight: bold;">defun</span> <span style="color: #6c3163; font-weight: bold;">orgtrello/--choose-board</span> (boards)
  <span style="color: #da8b55;">"Given a map of boards, display the possible boards for the user to choose which one he wants to work with."</span>
  <span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">ugliest ever</span>
  (<span style="color: #3a81c3; font-weight: bold;">defvar</span> <span style="color: #715ab1;">orgtrello/--board-chosen</span> nil)
  (setq orgtrello/--board-chosen nil)
  (<span style="color: #3a81c3; font-weight: bold;">let*</span> ((str-key-val  <span style="color: #2d9574;">""</span>)
         (i            0)
         (i-id (make-hash-table <span style="color: #3a81c3;">:test</span> 'equal)))
    (maphash (<span style="color: #3a81c3; font-weight: bold;">lambda</span> (id name)
               (setq str-key-val (format <span style="color: #2d9574;">"%s%d: %s\n"</span> str-key-val i name))
               (puthash (format <span style="color: #2d9574;">"%d"</span> i) id i-id)
               (setq i (+ 1 i)))
             boards)
    (<span style="color: #3a81c3; font-weight: bold;">while</span> (not (gethash orgtrello/--board-chosen i-id))
      (setq orgtrello/--board-chosen
            (read-string (format <span style="color: #2d9574;">"%s\nInput the number of the board desired: "</span> str-key-val))))
    (<span style="color: #3a81c3; font-weight: bold;">let*</span> ((orgtrello/--chosen-board-id   (gethash orgtrello/--board-chosen i-id))
           (orgtrello/--chosen-board-name (gethash orgtrello/--chosen-board-id boards)))
      `(,orgtrello/--chosen-board-id ,orgtrello/--chosen-board-name))))

</pre>
</div>
</div>
</li>

<li><a id="org4337ad5"></a>orgtrello/&#x2013;remove-properties-file<br />
<div class="outline-text-5" id="text-5-4-10-3">
<p>
Remove some file properties before applying new ones.
</p>

<div class="org-src-container">
<pre class="src src-lisp" id="org182ec09">(<span style="color: #3a81c3; font-weight: bold;">defun</span> <span style="color: #6c3163; font-weight: bold;">orgtrello/--delete-buffer-property</span> (property-name)
  <span style="color: #da8b55;">"A simple routine to delete a #+property: entry from the org-mode buffer."</span>
  (<span style="color: #3a81c3; font-weight: bold;">let</span> ((current-point (search-forward property-name nil t)))
    (<span style="color: #3a81c3; font-weight: bold;">if</span> current-point
        (<span style="color: #3a81c3; font-weight: bold;">progn</span>
          (goto-char current-point)
          (beginning-of-line)
          (kill-line)
          (kill-line)))))

(<span style="color: #3a81c3; font-weight: bold;">defun</span> <span style="color: #6c3163; font-weight: bold;">orgtrello/--remove-properties-file</span> (board-lists-hash-name-id <span style="color: #ba2f59; font-weight: bold;">&amp;optional</span> update-todo-keywords)
  <span style="color: #da8b55;">"Remove the current org-trello properties"</span>
  (with-current-buffer (current-buffer)
    (goto-char (point-min))
    (orgtrello/--delete-buffer-property (format <span style="color: #2d9574;">"#+property: %s"</span> *BOARD-ID*))
    (orgtrello/--delete-buffer-property (format <span style="color: #2d9574;">"#+property: %s"</span> *BOARD-NAME*))
    (maphash
     (<span style="color: #3a81c3; font-weight: bold;">lambda</span> (name id)
       (orgtrello/--delete-buffer-property (format <span style="color: #2d9574;">"#+property: %s"</span> (orgtrello/convention-property-name name))))
     board-lists-hash-name-id)
    (<span style="color: #3a81c3; font-weight: bold;">if</span> update-todo-keywords
        (orgtrello/--delete-buffer-property <span style="color: #2d9574;">"#+TODO: "</span>))))

</pre>
</div>
</div>
</li>

<li><a id="orgeb1f0e6"></a>orgtrello/update-orgmode-file-with-properties<br />
<div class="outline-text-5" id="text-5-4-10-4">
<p>
Given a board name, board id, list of list ids, map of list names, insert such informations to the beginning of the org buffer.
Then save the buffer and restart org-mode.
</p>

<div class="org-src-container">
<pre class="src src-lisp" id="org7012f71">(<span style="color: #3a81c3; font-weight: bold;">defun</span> <span style="color: #6c3163; font-weight: bold;">orgtrello/update-orgmode-file-with-properties</span> (board-name board-id board-lists-hash-name-id <span style="color: #ba2f59; font-weight: bold;">&amp;optional</span> update-todo-keywords)
  <span style="color: #da8b55;">"Update the orgmode file with the needed headers for org-trello to work."</span>
  (with-current-buffer (current-buffer)
    (goto-char (point-min))
    <span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">force utf-8</span>
    (set-buffer-file-coding-system 'utf-8-auto)
    <span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">install board-name and board-id</span>
    (insert (format <span style="color: #2d9574;">"#+property: %s    %s\n"</span> *BOARD-NAME* board-name))
    (insert (format <span style="color: #2d9574;">"#+property: %s      %s\n"</span> *BOARD-ID* board-id))
    <span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">install the other properties regarding the org keywords</span>
    (maphash
     (<span style="color: #3a81c3; font-weight: bold;">lambda</span> (name id)
       (insert (format <span style="color: #2d9574;">"#+property: %s %s\n"</span> (orgtrello/convention-property-name name) id)))
     board-lists-hash-name-id)
    (<span style="color: #3a81c3; font-weight: bold;">if</span> update-todo-keywords
        (<span style="color: #3a81c3; font-weight: bold;">progn</span>
          <span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">install the todo list</span>
          (insert <span style="color: #2d9574;">"#+TODO: "</span>)
          (maphash (<span style="color: #3a81c3; font-weight: bold;">lambda</span> (name _) (insert (concat (orgtrello/convention-property-name name) <span style="color: #2d9574;">" "</span>))) board-lists-hash-name-id)
          (insert <span style="color: #2d9574;">"\n"</span>)))
    <span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">save the buffer</span>
    (save-buffer)
    <span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">restart org to make org-trello aware of the new setup</span>
    (org-mode-restart)))

</pre>
</div>
</div>
</li>

<li><a id="org08609d1"></a>orgtrello/&#x2013;id-name<br />
<div class="outline-text-5" id="text-5-4-10-5">
<p>
Given a list of entities, return a map of (id . name)
</p>

<div class="org-src-container">
<pre class="src src-lisp" id="org734bb1c">(<span style="color: #3a81c3; font-weight: bold;">defun</span> <span style="color: #6c3163; font-weight: bold;">orgtrello/--id-name</span> (entities)
  <span style="color: #da8b55;">"Given a list of entities, return a map of (id, name)."</span>
  (<span style="color: #3a81c3; font-weight: bold;">let*</span> ((id-name (make-hash-table <span style="color: #3a81c3;">:test</span> 'equal)))
    (mapc (<span style="color: #3a81c3; font-weight: bold;">lambda</span> (it) (puthash (orgtrello-query/--id it) (orgtrello-query/--name it) id-name)) entities)
    id-name))

</pre>
</div>
</div>
</li>

<li><a id="org7fe8db0"></a>orgtrello/&#x2013;name-id<br />
<div class="outline-text-5" id="text-5-4-10-6">
<p>
Given a list of entities, return a map of (name . id)
</p>

<div class="org-src-container">
<pre class="src src-lisp" id="org1cbec56">(<span style="color: #3a81c3; font-weight: bold;">defun</span> <span style="color: #6c3163; font-weight: bold;">orgtrello/--name-id</span> (entities)
  <span style="color: #da8b55;">"Given a list of entities, return a map of (id, name)."</span>
  (<span style="color: #3a81c3; font-weight: bold;">let*</span> ((name-id (make-hash-table <span style="color: #3a81c3;">:test</span> 'equal)))
    (mapc (<span style="color: #3a81c3; font-weight: bold;">lambda</span> (it) (puthash (orgtrello-query/--name it) (orgtrello-query/--id it) name-id)) entities)
    name-id))

</pre>
</div>
</div>
</li>

<li><a id="orge350575"></a>orgtrello/&#x2013;list-boards<br />
<div class="outline-text-5" id="text-5-4-10-7">
<p>
Execute the query that return a list of boards from the user's current trello account.
</p>

<div class="org-src-container">
<pre class="src src-lisp" id="org487cf65">(<span style="color: #3a81c3; font-weight: bold;">defun</span> <span style="color: #6c3163; font-weight: bold;">orgtrello/--list-boards</span> ()
  <span style="color: #da8b55;">"Return the map of the existing boards associated to the current account. (Synchronous request)"</span>
  (cl-remove-if-not
   (<span style="color: #3a81c3; font-weight: bold;">lambda</span> (board) (equal <span style="color: #3a81c3;">:json-false</span> (orgtrello-query/--close-property board)))
   (orgtrello-query/http (orgtrello-api/get-boards) t)))

</pre>
</div>
</div>
</li>

<li><a id="org1fb1256"></a>orgtrello/&#x2013;list-board-lists<br />
<div class="outline-text-5" id="text-5-4-10-8">
<p>
Execute the query that return a list of the board lists from the user's current trello account.
</p>

<div class="org-src-container">
<pre class="src src-lisp" id="org2ab1e09">(<span style="color: #3a81c3; font-weight: bold;">defun</span> <span style="color: #6c3163; font-weight: bold;">orgtrello/--list-board-lists</span> (board-id)
  <span style="color: #da8b55;">"Return the map of the existing list of the board with id board-id. (Synchronous request)"</span>
  (orgtrello-query/http (orgtrello-api/get-lists board-id) t))

</pre>
</div>
</div>
</li>

<li><a id="org8bf7140"></a>orgtrello/convention-property-name<br />
<div class="outline-text-5" id="text-5-4-10-9">
<p>
A function to help eventually decorate the name of the keywords.
Replace the space by dash at the moment.
</p>

<div class="org-src-container">
<pre class="src src-lisp" id="orgd480e8a">(<span style="color: #3a81c3; font-weight: bold;">defun</span> <span style="color: #6c3163; font-weight: bold;">orgtrello/convention-property-name</span> (name)
  <span style="color: #da8b55;">"Use the right convention for the property used in the headers of the org-mode file."</span>
  (replace-regexp-in-string <span style="color: #2d9574;">" "</span> <span style="color: #2d9574;">"-"</span> name))

</pre>
</div>
</div>
</li>
</ol>
</li>

<li><a id="orgec4aa31"></a>Create board<br />
<div class="outline-text-4" id="text-5-4-11">
<p>
The main function regarding the creation of the board and the org attachment to such board.
</p>
</div>

<ol class="org-ol">
<li><a id="org067b1e8"></a>orgtrello/do-create-board-and-lists<br />
<div class="outline-text-5" id="text-5-4-11-1">
<p>
The main entry.
We will ask the user to:
</p>
<ul class="org-ul">
<li>input the name of the board he/she wants.</li>
<li>input an optional board description</li>
</ul>
<p>
Then launch the creation of the board.
This will:
</p>
<ul class="org-ul">
<li>create the board</li>
<li>close the default lists created by trello</li>
<li>create as much list as the user's keywords with the same name as the corresponding keywords.</li>
<li>at last, update the beginning of the org buffer with the corresponding metadata:
<ul class="org-ul">
<li>board-name</li>
<li>board-id</li>
<li>list-id for all lists created</li>
</ul></li>
</ul>

<div class="org-src-container">
<pre class="src src-lisp" id="org11a458e">(<span style="color: #3a81c3; font-weight: bold;">defun</span> <span style="color: #6c3163; font-weight: bold;">orgtrello/do-create-board-and-lists</span> ()
  <span style="color: #da8b55;">"Interactive command to create a board and the lists"</span>
  (interactive)
  (<span style="color: #3a81c3; font-weight: bold;">defvar</span> <span style="color: #715ab1;">orgtrello/--board-name</span> nil)        (setq orgtrello/--board-name nil)
  (<span style="color: #3a81c3; font-weight: bold;">defvar</span> <span style="color: #715ab1;">orgtrello/--board-description</span> nil) (setq orgtrello/--board-description nil)
  (<span style="color: #3a81c3; font-weight: bold;">while</span> (not orgtrello/--board-name) (setq orgtrello/--board-name (read-string <span style="color: #2d9574;">"Please, input the desired board name: "</span>)))
  (setq orgtrello/--board-description (read-string <span style="color: #2d9574;">"Please, input the board description (empty for none): "</span>))
  (cl-destructuring-bind (orgtrello/--board-id orgtrello/--board-name) (orgtrello/--create-board orgtrello/--board-name orgtrello/--board-description)
                         (<span style="color: #3a81c3; font-weight: bold;">let*</span> ((orgtrello/--board-list-ids       (--map (orgtrello-query/--id it) (orgtrello/--list-board-lists orgtrello/--board-id)))  <span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">first retrieve the existing lists (created by default on trello)</span>
                                (orgtrello/--lists-to-close       (orgtrello/--close-lists orgtrello/--board-list-ids))                                <span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">close those lists (they may surely not match the name we want)</span>
                                (orgtrello/--board-lists-hname-id (orgtrello/--create-lists-according-to-keywords orgtrello/--board-id *LIST-NAMES*))) <span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">create the list, this returns the ids list</span>
                           <span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">remove eventual already present entry</span>
                           (orgtrello/--remove-properties-file orgtrello/--board-lists-hname-id)
                           <span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">update org buffer with new ones</span>
                           (orgtrello/update-orgmode-file-with-properties orgtrello/--board-name orgtrello/--board-id orgtrello/--board-lists-hname-id)))
  <span style="color: #2d9574;">"Create board and lists done!"</span>)

(message <span style="color: #2d9574;">"org-trello - orgtrello loaded!"</span>)

</pre>
</div>
</div>
</li>
<li><a id="org0038977"></a>orgtrello/&#x2013;create-board<br />
<div class="outline-text-5" id="text-5-4-11-2">
<p>
The actual board creation.
This return a list of board id, board name.
</p>

<div class="org-src-container">
<pre class="src src-lisp" id="org335df02">(<span style="color: #3a81c3; font-weight: bold;">defun</span> <span style="color: #6c3163; font-weight: bold;">orgtrello/--create-board</span> (board-name <span style="color: #ba2f59; font-weight: bold;">&amp;optional</span> board-description)
  <span style="color: #da8b55;">"Create a board with name and eventually a description."</span>
  (<span style="color: #3a81c3; font-weight: bold;">progn</span>
    (message <span style="color: #2d9574;">"Creating board '%s'"</span> board-name)
    (<span style="color: #3a81c3; font-weight: bold;">let*</span> ((board-data (orgtrello-query/http (orgtrello-api/add-board board-name board-description) t)))
      (list (orgtrello-query/--id board-data) (orgtrello-query/--name board-data)))))

</pre>
</div>
</div>
</li>

<li><a id="org8d45f61"></a>orgtrello/&#x2013;close-lists<br />
<div class="outline-text-5" id="text-5-4-11-3">
<p>
The close list routine.
Given a list of list ids, close each of those list.
</p>

<div class="org-src-container">
<pre class="src src-lisp" id="org0228d46">(<span style="color: #3a81c3; font-weight: bold;">defun</span> <span style="color: #6c3163; font-weight: bold;">orgtrello/--close-lists</span> (list-ids)
  <span style="color: #da8b55;">"Given a list of ids, close those lists."</span>
  (mapc (<span style="color: #3a81c3; font-weight: bold;">lambda</span> (list-id)
          (<span style="color: #3a81c3; font-weight: bold;">progn</span>
            (message <span style="color: #2d9574;">"Closing default list with id %s"</span> list-id)
            (orgtrello-query/http (orgtrello-api/close-list list-id) nil nil 'simple-error-callback)))
        list-ids))

</pre>
</div>
</div>
</li>

<li><a id="orgc6df83b"></a>orgtrello/&#x2013;create-lists-according-to-keywords<br />
<div class="outline-text-5" id="text-5-4-11-4">
<p>
Create as much list as the keywords to the board <i>board-id</i>.
</p>

<div class="org-src-container">
<pre class="src src-lisp" id="org6b45e12">(<span style="color: #3a81c3; font-weight: bold;">defun</span> <span style="color: #6c3163; font-weight: bold;">orgtrello/--create-lists-according-to-keywords</span> (board-id list-keywords)
  <span style="color: #da8b55;">"Given a list of names, build those lists on the trello boards. Return the hashmap (name, id) of the new lists created."</span>
  (cl-reduce
   (<span style="color: #3a81c3; font-weight: bold;">lambda</span> (acc-hash-name-id list-name)
     (<span style="color: #3a81c3; font-weight: bold;">progn</span>
       (message <span style="color: #2d9574;">"Board id %s - Creating list '%s'"</span> board-id list-name)
       (puthash list-name (orgtrello-query/--id (orgtrello-query/http (orgtrello-api/add-list list-name board-id) t)) acc-hash-name-id)
       acc-hash-name-id))
   list-keywords
   <span style="color: #3a81c3;">:initial-value</span> (make-hash-table <span style="color: #3a81c3;">:test</span> 'equal)))

</pre>
</div>
</div>
</li>
</ol>
</li>

<li><a id="org63dd8d1"></a>Utility function<br />
<div class="outline-text-4" id="text-5-4-12">
<p>
An utility decorator function to help in debugging without breakpoint.
This is mostly for user when we need them to help us remotely debug.
</p>

<div class="org-src-container">
<pre class="src src-lisp" id="org0ea34c5">(<span style="color: #3a81c3; font-weight: bold;">defun</span> <span style="color: #6c3163; font-weight: bold;">trace</span> (e <span style="color: #ba2f59; font-weight: bold;">&amp;optional</span> label)
  <span style="color: #da8b55;">"Decorator for some inaccessible code to easily 'message'."</span>
  (<span style="color: #3a81c3; font-weight: bold;">progn</span>
    (<span style="color: #3a81c3; font-weight: bold;">if</span> label
        (message <span style="color: #2d9574;">"TRACE: %s: %S"</span> label e)
        (message <span style="color: #2d9574;">"TRACE: %S"</span> e))
    e))

</pre>
</div>
</div>
</li>
</ol>
</div>

<div id="outline-container-org8946f24" class="outline-3">
<h3 id="org8946f24"><span class="section-number-3">5.5</span> orgtrello-query</h3>
<div class="outline-text-3" id="text-5-5">
<p>
Namespace in charge of the http request to the trello api.
</p>
</div>

<ol class="org-ol">
<li><a id="org53c2768"></a>Namespace Setup<br />
<div class="outline-text-4" id="text-5-5-1">
<p>
Static setup the user does not need to tinker with.
This resumes to only one variable which is the prefix url for the trello api access.
</p>

<div class="org-src-container">
<pre class="src src-lisp" id="orgd486805">&#12;

<span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">#################### orgtrello-query/</span>

(<span style="color: #3a81c3; font-weight: bold;">defvar</span> <span style="color: #715ab1;">*TRELLO-URL*</span> <span style="color: #2d9574;">"https://api.trello.com/1"</span> <span style="color: #da8b55;">"The needed prefix url for trello"</span>)

</pre>
</div>
</div>
</li>

<li><a id="org812ab6c"></a>orgtrello-query/&#x2013;make-dispatch-http-query<br />
<div class="outline-text-4" id="text-5-5-2">
<p>
As we do not have multi-methods (as in clojure), we tried to reproduce a similar behaviour.
This describes a function which will setup a map to dispatch on the method (:get, :post, :put, :delete) on the other function describes in the namespace).
</p>

<p>
This function is used only once to initialize the variable <b>MAP-DISPATCH-HTTP-QUERY</b>, which will be used later to dispatch on the http request built.
</p>

<div class="org-src-container">
<pre class="src src-lisp" id="org415e06e">(<span style="color: #3a81c3; font-weight: bold;">defun</span> <span style="color: #6c3163; font-weight: bold;">orgtrello-query/--make-dispatch-http-query</span> ()
  <span style="color: #da8b55;">"Make a map that will dispatch the function to call depending on the http verb :get, :put, :post, etc..."</span>
  (<span style="color: #3a81c3; font-weight: bold;">let*</span> ((map-dispatch (make-hash-table <span style="color: #3a81c3;">:test</span> 'equal)))
    (puthash <span style="color: #3a81c3;">:get</span>    'orgtrello-query/--get         map-dispatch)
    (puthash <span style="color: #3a81c3;">:put</span>    'orgtrello-query/--post-or-put map-dispatch)
    (puthash <span style="color: #3a81c3;">:post</span>   'orgtrello-query/--post-or-put map-dispatch)
    (puthash <span style="color: #3a81c3;">:delete</span> 'orgtrello-query/--delete      map-dispatch)
    map-dispatch))

(<span style="color: #3a81c3; font-weight: bold;">defvar</span> <span style="color: #715ab1;">*MAP-DISPATCH-HTTP-QUERY*</span> (orgtrello-query/--make-dispatch-http-query))

</pre>
</div>
</div>
</li>

<li><a id="org106535b"></a>orgtrello-query/http<br />
<div class="outline-text-4" id="text-5-5-3">
<p>
This is the main function from the namespace in charge of executing the http request.
We pass the query-map which is been built from the orgtrello-api namespace.
Optionally, we pass a:
</p>
<ul class="org-ul">
<li>success-callback in charge of doing some action when the request finishes successfully.</li>
<li>error-callback in  charge of doing some action when the request finishes erroneously.</li>
<li>sync flag to render the request synchronous (default is asynchronous)</li>
</ul>

<div class="org-src-container">
<pre class="src src-lisp" id="orgd426841">(<span style="color: #3a81c3; font-weight: bold;">defun</span> <span style="color: #6c3163; font-weight: bold;">orgtrello-query/http</span> (query-map <span style="color: #ba2f59; font-weight: bold;">&amp;optional</span> sync success-callback error-callback)
  <span style="color: #da8b55;">"Query the trello api asynchronously."</span>
  (<span style="color: #3a81c3; font-weight: bold;">let*</span> ((method      (gethash <span style="color: #3a81c3;">:method</span> query-map))
         (fn-dispatch (gethash method *MAP-DISPATCH-HTTP-QUERY*)))
    (<span style="color: #3a81c3; font-weight: bold;">if</span> sync
        (<span style="color: #3a81c3; font-weight: bold;">progn</span> <span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">synchronous request</span>
          (puthash <span style="color: #3a81c3;">:sync</span> t query-map)
          (<span style="color: #3a81c3; font-weight: bold;">let</span> ((request-response (funcall fn-dispatch query-map success-callback error-callback)))
            (request-response-data request-response)))
      (funcall fn-dispatch query-map success-callback error-callback))))

</pre>
</div>
</div>
</li>

<li><a id="org8f8d0d5"></a>orgtrello-query/&#x2013;map-dispatch-http-verb<br />
<div class="outline-text-4" id="text-5-5-4">
<p>
As described earlier, no multi-method, we use the same techniques to setup a map to dispatch on the method (:get, :post, :put, :delete) to map to the request http client DSL.
This function is again called once.
</p>

<div class="org-src-container">
<pre class="src src-lisp" id="org931f959">(<span style="color: #3a81c3; font-weight: bold;">defun</span> <span style="color: #6c3163; font-weight: bold;">orgtrello-query/--map-dispatch-http-verb</span> ()
  (<span style="color: #3a81c3; font-weight: bold;">let*</span> ((map-dispatch (make-hash-table <span style="color: #3a81c3;">:test</span> 'equal)))
    (puthash <span style="color: #3a81c3;">:get</span>    <span style="color: #2d9574;">"GET"</span>    map-dispatch)
    (puthash <span style="color: #3a81c3;">:put</span>    <span style="color: #2d9574;">"PUT"</span>    map-dispatch)
    (puthash <span style="color: #3a81c3;">:post</span>   <span style="color: #2d9574;">"POST"</span>   map-dispatch)
    (puthash <span style="color: #3a81c3;">:delete</span> <span style="color: #2d9574;">"DELETE"</span> map-dispatch)
    map-dispatch))

(<span style="color: #3a81c3; font-weight: bold;">defvar</span> <span style="color: #715ab1;">*MAP-DISPATCH-HTTP-VERB*</span> (orgtrello-query/--map-dispatch-http-verb))

</pre>
</div>
</div>
</li>

<li><a id="org378ed07"></a>orgtrello-query/&#x2013;compute-method<br />
<div class="outline-text-4" id="text-5-5-5">
<p>
Exploiting the dispatch map, we compute the http method (GET, POST, PUT, DELETE).
We could also have implemented this using simply cond.
</p>

<div class="org-src-container">
<pre class="src src-lisp" id="orgd90f724">(<span style="color: #3a81c3; font-weight: bold;">defun</span> <span style="color: #6c3163; font-weight: bold;">orgtrello-query/--compute-method</span> (method)
  <span style="color: #da8b55;">"Given the keywords :get, :post, :put, :delete, map them into standard uppercase string."</span>
  (gethash method *MAP-DISPATCH-HTTP-VERB*))

</pre>
</div>
</div>
</li>

<li><a id="org5aeee5b"></a>orgtrello-query/&#x2013;compute-url<br />
<div class="outline-text-4" id="text-5-5-6">
<p>
A function to compute the full trello url given an uri.
</p>

<div class="org-src-container">
<pre class="src src-lisp" id="orge440ac9">(<span style="color: #3a81c3; font-weight: bold;">defun</span> <span style="color: #6c3163; font-weight: bold;">orgtrello-query/--compute-url</span> (uri)
  <span style="color: #da8b55;">"Compute the trello url from the given uri."</span>
  (format <span style="color: #2d9574;">"%s%s"</span> *TRELLO-URL* uri))

</pre>
</div>
</div>
</li>

<li><a id="org53fad05"></a>Input request abstraction extract functions<br />
<div class="outline-text-4" id="text-5-5-7">
<p>
Some functions around the data stored in the query-map, hiding the implementation details of such query-map.
</p>
</div>

<ol class="org-ol">
<li><a id="orgb49c97b"></a>orgtrello-query/&#x2013;method<br />
<div class="outline-text-5" id="text-5-5-7-1">
<p>
Extract the http method.
</p>

<div class="org-src-container">
<pre class="src src-lisp" id="org40f2c38">(<span style="color: #3a81c3; font-weight: bold;">defun</span> <span style="color: #6c3163; font-weight: bold;">orgtrello-query/--method</span> (query-map)
  <span style="color: #da8b55;">"Retrieve the http method"</span>
  (gethash <span style="color: #3a81c3;">:method</span> query-map))

</pre>
</div>
</div>
</li>

<li><a id="orgee7d945"></a>orgtrello-query/&#x2013;uri<br />
<div class="outline-text-5" id="text-5-5-7-2">
<p>
Extract the trello api uri.
</p>

<div class="org-src-container">
<pre class="src src-lisp" id="org499a06b">(<span style="color: #3a81c3; font-weight: bold;">defun</span> <span style="color: #6c3163; font-weight: bold;">orgtrello-query/--uri</span> (query-map)
  <span style="color: #da8b55;">"Retrieve the http uri"</span>
  (gethash <span style="color: #3a81c3;">:uri</span> query-map))

</pre>
</div>
</div>
</li>

<li><a id="org339cf5f"></a>orgtrello-query/&#x2013;sync<br />
<div class="outline-text-5" id="text-5-5-7-3">
<p>
Retrieve the flag sync or not of the query-map.
</p>

<div class="org-src-container">
<pre class="src src-lisp" id="orgf7d04c5">(<span style="color: #3a81c3; font-weight: bold;">defun</span> <span style="color: #6c3163; font-weight: bold;">orgtrello-query/--sync</span> (query-map)
  <span style="color: #da8b55;">"Retrieve the http sync flag"</span>
  (gethash <span style="color: #3a81c3;">:sync</span> query-map))

</pre>
</div>
</div>
</li>

<li><a id="org22cd6f2"></a>orgtrello-query/&#x2013;params<br />
<div class="outline-text-5" id="text-5-5-7-4">
<p>
Retrieve the params of the query.
</p>

<div class="org-src-container">
<pre class="src src-lisp" id="org8cf11bb">(<span style="color: #3a81c3; font-weight: bold;">defun</span> <span style="color: #6c3163; font-weight: bold;">orgtrello-query/--params</span> (query-map)
  <span style="color: #da8b55;">"Retrieve the http params"</span>
  (gethash <span style="color: #3a81c3;">:params</span> query-map))

</pre>
</div>
</div>
</li>
</ol>
</li>
<li><a id="orgd420f1b"></a>Output request abstraction extract function<br />
<div class="outline-text-4" id="text-5-5-8">
<p>
Some functions around the data stored in the http query response, hiding the implementation details.
</p>
</div>
<ol class="org-ol">
<li><a id="orge81fa03"></a>orgtrello-query/&#x2013;id<br />
<div class="outline-text-5" id="text-5-5-8-1">
<p>
Extract the id of the entity from the entity-data.
</p>

<div class="org-src-container">
<pre class="src src-lisp" id="orgf41d888">(<span style="color: #3a81c3; font-weight: bold;">defun</span> <span style="color: #6c3163; font-weight: bold;">orgtrello-query/--id</span> (entity-data)
  <span style="color: #da8b55;">"Extract the id of the entity from the entity"</span>
  (assoc-default 'id entity-data))

</pre>
</div>
</div>
</li>

<li><a id="org5acc1bb"></a>orgtrello-query/&#x2013;name<br />
<div class="outline-text-5" id="text-5-5-8-2">
<p>
Extract the name of the entity from the entity-data.
</p>

<div class="org-src-container">
<pre class="src src-lisp" id="org3a588d6">(<span style="color: #3a81c3; font-weight: bold;">defun</span> <span style="color: #6c3163; font-weight: bold;">orgtrello-query/--name</span> (entity-data)
  <span style="color: #da8b55;">"Extract the name of the entity from the entity"</span>
  (assoc-default 'name entity-data))

</pre>
</div>
</div>
</li>

<li><a id="org01b7d42"></a>orgtrello-query/&#x2013;list-id<br />
<div class="outline-text-5" id="text-5-5-8-3">
<p>
Extract the list identifier from the entity-data.
</p>

<div class="org-src-container">
<pre class="src src-lisp" id="orge64be15">(<span style="color: #3a81c3; font-weight: bold;">defun</span> <span style="color: #6c3163; font-weight: bold;">orgtrello-query/--list-id</span> (entity-data)
  <span style="color: #da8b55;">"Extract the list identitier of the entity from the entity"</span>
  (assoc-default 'idList entity-data))

</pre>
</div>
</div>
</li>

<li><a id="orgc02d603"></a>orgtrello-query/&#x2013;checklist-ids<br />
<div class="outline-text-5" id="text-5-5-8-4">
<p>
Extract the list of checklist ids from the entity-data.
</p>

<div class="org-src-container">
<pre class="src src-lisp" id="org6e239e0">(<span style="color: #3a81c3; font-weight: bold;">defun</span> <span style="color: #6c3163; font-weight: bold;">orgtrello-query/--checklist-ids</span> (entity-data)
  <span style="color: #da8b55;">"Extract the checklist identifier of the entity from the entity"</span>
  (assoc-default 'idChecklists entity-data))

</pre>
</div>
</div>
</li>

<li><a id="org485e312"></a>orgtrello-query/&#x2013;check-items<br />
<div class="outline-text-5" id="text-5-5-8-5">
<p>
Extract the list of items/tasks from the entity-data.
</p>

<div class="org-src-container">
<pre class="src src-lisp" id="org552c2dd">(<span style="color: #3a81c3; font-weight: bold;">defun</span> <span style="color: #6c3163; font-weight: bold;">orgtrello-query/--check-items</span> (entity-data)
  <span style="color: #da8b55;">"Extract the checklist identifier of the entity from the entity"</span>
  (assoc-default 'checkItems entity-data))

</pre>
</div>
</div>
</li>

<li><a id="org528b191"></a>orgtrello-query/&#x2013;card-id<br />
<div class="outline-text-5" id="text-5-5-8-6">
<p>
Extract the card id from the entity-data.
</p>

<div class="org-src-container">
<pre class="src src-lisp" id="org6c83e13">(<span style="color: #3a81c3; font-weight: bold;">defun</span> <span style="color: #6c3163; font-weight: bold;">orgtrello-query/--card-id</span> (entity-data)
  <span style="color: #da8b55;">"Extract the card identifier of the entity from the entity"</span>
  (assoc-default 'idCard entity-data))

</pre>
</div>
</div>
</li>

<li><a id="orgfe00cdb"></a>orgtrello-query/&#x2013;due<br />
<div class="outline-text-5" id="text-5-5-8-7">
<p>
Extract the card id from the entity-data.
</p>

<div class="org-src-container">
<pre class="src src-lisp" id="org51faed3">(<span style="color: #3a81c3; font-weight: bold;">defun</span> <span style="color: #6c3163; font-weight: bold;">orgtrello-query/--due</span> (entity-data)
  <span style="color: #da8b55;">"Extract the due date of the entity from the query response"</span>
  (assoc-default 'due entity-data))

</pre>
</div>
</div>
</li>

<li><a id="org34c77cb"></a>orgtrello-query/&#x2013;state<br />
<div class="outline-text-5" id="text-5-5-8-8">
<p>
Extract the state from the entity-data.
</p>

<div class="org-src-container">
<pre class="src src-lisp" id="org9e9eec4">(<span style="color: #3a81c3; font-weight: bold;">defun</span> <span style="color: #6c3163; font-weight: bold;">orgtrello-query/--state</span> (entity-data)
  <span style="color: #da8b55;">"Extract the state of the entity"</span>
  (assoc-default 'state entity-data))

</pre>
</div>
</div>
</li>

<li><a id="orgf348298"></a>orgtrello-query/&#x2013;close-property<br />
<div class="outline-text-5" id="text-5-5-8-9">
<p>
Extract the close flag from the entity-data.
</p>

<div class="org-src-container">
<pre class="src src-lisp" id="org88cdacb">(<span style="color: #3a81c3; font-weight: bold;">defun</span> <span style="color: #6c3163; font-weight: bold;">orgtrello-query/--close-property</span> (entity-data)
  <span style="color: #da8b55;">"Extract the closed property of the entity"</span>
  (assoc-default 'closed entity-data))

</pre>
</div>
</div>
</li>
</ol>
</li>

<li><a id="org2a6aff3"></a>HTTP request functions<br />
<div class="outline-text-4" id="text-5-5-9">
<p>
Those represent the actual http actions.
They are closures on the trello identifier (consumer-key and access-token).
</p>
</div>

<ol class="org-ol">
<li><a id="orgfd75e6b"></a>orgtrello-query/&#x2013;get<br />
<div class="outline-text-5" id="text-5-5-9-1">
<p>
The function around the GET http request.
This will extract the method, uri and sync flag and build the http request.
This is a closure around the consumer-key and access-token.
The request's response is some json which will be parsed by the function 'json-read.
In case of optional success or error callback are passed, they will be used.
Otherwise, the 'standard-success-callback or the 'standard-error-callback will be used.
</p>

<div class="org-src-container">
<pre class="src src-lisp" id="orgc01347b">(<span style="color: #3a81c3; font-weight: bold;">defun</span> <span style="color: #6c3163; font-weight: bold;">orgtrello-query/--get</span> (query-map <span style="color: #ba2f59; font-weight: bold;">&amp;optional</span> success-callback error-callback)
  <span style="color: #da8b55;">"GET"</span>
  (<span style="color: #3a81c3; font-weight: bold;">let*</span> ((method (orgtrello-query/--method query-map))
         (uri    (orgtrello-query/--uri    query-map))
         (sync   (orgtrello-query/--sync   query-map)))
    (request (orgtrello-query/--compute-url uri)
             <span style="color: #3a81c3;">:sync</span>    sync
             <span style="color: #3a81c3;">:type</span>    (orgtrello-query/--compute-method method)
             <span style="color: #3a81c3;">:params</span>  `((key . ,*consumer-key*)
                        (token . ,*access-token*))
             <span style="color: #3a81c3;">:parser</span>  'json-read
             <span style="color: #3a81c3;">:success</span> (<span style="color: #3a81c3; font-weight: bold;">if</span> success-callback success-callback 'standard-success-callback)
             <span style="color: #3a81c3;">:error</span>   (<span style="color: #3a81c3; font-weight: bold;">if</span> error-callback error-callback 'standard-error-callback))))

</pre>
</div>
</div>
</li>

<li><a id="org986b0fd"></a>orgtrello-query/&#x2013;post-or-put<br />
<div class="outline-text-5" id="text-5-5-9-2">
<p>
The function around the POST/PUT verbs.
This is similar to the get function but does some extract actions:
</p>
<ul class="org-ul">
<li>It extracts the params (which represents the needed information for the trello entity we will sync).</li>
<li>It encodes the payload in json with the json-encode function</li>
</ul>

<div class="org-src-container">
<pre class="src src-lisp" id="org2b315f0">(<span style="color: #3a81c3; font-weight: bold;">defun</span> <span style="color: #6c3163; font-weight: bold;">orgtrello-query/--post-or-put</span> (query-map <span style="color: #ba2f59; font-weight: bold;">&amp;optional</span> success-callback error-callback)
  <span style="color: #da8b55;">"POST or PUT"</span>
  (<span style="color: #3a81c3; font-weight: bold;">let*</span> ((method  (orgtrello-query/--method query-map))
         (uri     (orgtrello-query/--uri    query-map))
         (payload (orgtrello-query/--params query-map))
         (sync    (orgtrello-query/--sync   query-map)))
    (request (orgtrello-query/--compute-url uri)
             <span style="color: #3a81c3;">:sync</span>    sync
             <span style="color: #3a81c3;">:type</span>    (orgtrello-query/--compute-method method)
             <span style="color: #3a81c3;">:params</span>  `((key . ,*consumer-key*)
                        (token . ,*access-token*))
             <span style="color: #3a81c3;">:headers</span> '((<span style="color: #2d9574;">"Content-type"</span> . <span style="color: #2d9574;">"application/json"</span>))
             <span style="color: #3a81c3;">:data</span>    (json-encode payload)
             <span style="color: #3a81c3;">:parser</span>  'json-read
             <span style="color: #3a81c3;">:success</span> (<span style="color: #3a81c3; font-weight: bold;">if</span> success-callback success-callback 'standard-success-callback)
             <span style="color: #3a81c3;">:error</span>   (<span style="color: #3a81c3; font-weight: bold;">if</span> error-callback error-callback 'standard-error-callback))))

</pre>
</div>
</div>
</li>

<li><a id="org440bff6"></a>orgtrello-query/&#x2013;delete<br />
<div class="outline-text-5" id="text-5-5-9-3">
<p>
The last verb we deal with, the DELETE action.
Again similar as GET but does a DELETE.
</p>

<div class="org-src-container">
<pre class="src src-lisp" id="org847f711">(<span style="color: #3a81c3; font-weight: bold;">defun</span> <span style="color: #6c3163; font-weight: bold;">orgtrello-query/--delete</span> (query-map <span style="color: #ba2f59; font-weight: bold;">&amp;optional</span> success-callback error-callback)
  <span style="color: #da8b55;">"DELETE"</span>
  (<span style="color: #3a81c3; font-weight: bold;">let*</span> ((method (orgtrello-query/--method query-map))
         (uri    (orgtrello-query/--uri    query-map))
         (sync   (orgtrello-query/--sync   query-map)))
    (request (orgtrello-query/--compute-url uri)
             <span style="color: #3a81c3;">:sync</span>    sync
             <span style="color: #3a81c3;">:type</span>    (orgtrello-query/--compute-method method)
             <span style="color: #3a81c3;">:params</span>  `((key . ,*consumer-key*)
                        (token . ,*access-token*))
             <span style="color: #3a81c3;">:success</span> (<span style="color: #3a81c3; font-weight: bold;">if</span> success-callback success-callback 'standard-success-callback)
             <span style="color: #3a81c3;">:error</span>   (<span style="color: #3a81c3; font-weight: bold;">if</span> error-callback error-callback 'standard-error-callback))))

(message <span style="color: #2d9574;">"org-trello - orgtrello-query/ loaded!"</span>)

</pre>
</div>
</div>
</li>
</ol>
</li>

<li><a id="org0c1ecdf"></a>HTTP callbacks<br />
<div class="outline-text-4" id="text-5-5-10">
<p>
Those are actions done at the end of the http request.
</p>
</div>

<ol class="org-ol">
<li><a id="orgf96ad58"></a>standard-error-callback<br />
<div class="outline-text-5" id="text-5-5-10-1">
<p>
The standard error-callback in charge of removing the orgtrello-marker written before synchronization.
This display an error message on the minibuffer too.
</p>

<div class="org-src-container">
<pre class="src src-lisp" id="orgb607c31">(cl-defun standard-error-callback (<span style="color: #ba2f59; font-weight: bold;">&amp;key</span> error-thrown <span style="color: #ba2f59; font-weight: bold;">&amp;allow-other-keys</span>)
  <span style="color: #da8b55;">"Standard error callback"</span>
  (save-excursion
      <span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">find the current entry through the pointer</span>
      (org-goto-local-search-headings *ORGTRELLO-MARKER* nil t)
      <span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">remove the marker now that we're done</span>
      (org-delete-property *ORGTRELLO-MARKER*))
  (message <span style="color: #2d9574;">"There was some problem during the request to trello: %s"</span> error-thrown))

</pre>
</div>
</div>
</li>

<li><a id="org82eedb4"></a>standard-success-callback<br />
<div class="outline-text-5" id="text-5-5-10-2">
<p>
A standard success callback that displays a simple message "Success." in the minibuffer.
</p>

<div class="org-src-container">
<pre class="src src-lisp" id="org332bae6">(cl-defun standard-success-callback ()
  <span style="color: #da8b55;">"Standard success callback"</span>
  (message <span style="color: #2d9574;">"Success."</span>))

</pre>
</div>
</div>
</li>

<li><a id="orgb21d58c"></a>simple-error-callback<br />
<div class="outline-text-5" id="text-5-5-10-3">
<p>
A simpler error message callback which simply displays an error message on the minibuffer, indicating the error thrown by the execution of the request.
</p>

<div class="org-src-container">
<pre class="src src-lisp" id="org53ffb5c">(cl-defun simple-error-callback (<span style="color: #ba2f59; font-weight: bold;">&amp;key</span> error-thrown <span style="color: #ba2f59; font-weight: bold;">&amp;allow-other-keys</span>)
  <span style="color: #da8b55;">"Standard error callback"</span>
  (message <span style="color: #2d9574;">"There was some problem during the request to trello: %s"</span> error-thrown))

</pre>
</div>
</div>
</li>

<li><a id="orge22cb73"></a>orgtrello-query/&#x2013;delete-success-callback<br />
<div class="outline-text-5" id="text-5-5-10-4">
<p>
This one is the default delete success callback.
It needs to synchronize back the buffer to remove the entry we just destroyed on trello.
</p>
<ul class="org-ul">
<li>Return to the heading we want to delete</li>
<li>Delete the property which represents the trello identifier</li>
<li>Remove the full entity (for this we hide the subtree)</li>
<li>Go at the beginning of the line</li>
<li>Kill the next 2 lines</li>
<li>At last display a simple message to notify the end of the removal.</li>
</ul>

<div class="org-src-container">
<pre class="src src-lisp" id="orgc160f40">(cl-defun orgtrello-query/--delete-success-callback (<span style="color: #ba2f59; font-weight: bold;">&amp;key</span> data response <span style="color: #ba2f59; font-weight: bold;">&amp;allow-other-keys</span>)
  <span style="color: #da8b55;">"Callback function called at the end of a successful delete request."</span>
  (<span style="color: #3a81c3; font-weight: bold;">progn</span>
    (org-back-to-heading t)
    (org-delete-property *ORGTRELLO-ID*)
    (hide-subtree)
    (beginning-of-line)
    (kill-line)
    (kill-line)
    (message <span style="color: #2d9574;">"Entity deleted!"</span>)))

</pre>
</div>
</div>
</li>

<li><a id="org53739be"></a>orgtrello-query/&#x2013;post-put-success-callback-update-id<br />
<div class="outline-text-5" id="text-5-5-10-5">
<p>
This one is the default post/put success callback.
It's in charge of updating the org buffer with the trello id for the entity that has been synchronized.
What it does:
</p>
<ul class="org-ul">
<li>Get back to the current max header</li>
<li>Then place itself to the org-trello marker put at the beginning of the synchronization.</li>
<li>Remove such marker</li>
<li>Get the current header information</li>
<li>If an identifier is already present, simply display a message. Otherwise, add the property orgtrello-id with the identifier returned by the query.</li>
</ul>

<div class="org-src-container">
<pre class="src src-lisp" id="org346f387">(cl-defun orgtrello-query/--post-put-success-callback-update-id (<span style="color: #ba2f59; font-weight: bold;">&amp;key</span> data <span style="color: #ba2f59; font-weight: bold;">&amp;allow-other-keys</span>)
  <span style="color: #da8b55;">"Called back function at the end of the post/put request to update the trello id in the org-mode file."</span>
  (<span style="color: #3a81c3; font-weight: bold;">let*</span> ((orgtrello-query/--entry-new-id (orgtrello-query/--id data))
         (orgtrello-query/--entry-name   (orgtrello-query/--name data)))
    <span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">will update via tag the trello id of the new persisted data (if needed)</span>
    (save-excursion
      <span style="color: #2aa1ae; background-color: #ecf3ec;">;;</span><span style="color: #2aa1ae; background-color: #ecf3ec;">(while (org-up-heading-safe))</span>
      <span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">find the current entry through the pointer</span>
      (org-goto-local-search-headings *ORGTRELLO-MARKER* nil t)
      <span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">remove the marker now that we're done</span>
      (org-delete-property *ORGTRELLO-MARKER*)
      <span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">now we extract the data</span>
      (<span style="color: #3a81c3; font-weight: bold;">let*</span> ((orgtrello-query/--entry-metadata (orgtrello-data/metadata))
             (orgtrello-query/--entry-id       (orgtrello/--id orgtrello-query/--entry-metadata)))
        (<span style="color: #3a81c3; font-weight: bold;">if</span> orgtrello-query/--entry-id <span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">id already present in the org-mode file</span>
            <span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">no need to add another</span>
            (message <span style="color: #2d9574;">"Entity '%s' synced with id '%s'"</span> orgtrello-query/--entry-name orgtrello-query/--entry-id)
          (<span style="color: #3a81c3; font-weight: bold;">progn</span>
            <span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">not present, this was just created, we add a simple property</span>
            (org-set-property *ORGTRELLO-ID* orgtrello-query/--entry-new-id)
            (message <span style="color: #2d9574;">"Newly entity '%s' synced with id '%s'"</span> orgtrello-query/--entry-name orgtrello-query/--entry-new-id)))))))

</pre>
</div>
</div>
</li>
</ol>
</li>
</ol>
</div>

<div id="outline-container-org052c7e8" class="outline-3">
<h3 id="org052c7e8"><span class="section-number-3">5.6</span> orgtrello-api</h3>
<div class="outline-text-3" id="text-5-6">
<p>
This is the namespace responsible for the interface with trello's public api.
We have decoupled the http request from the http request data structure.
This way, we can test the api's request.
</p>
</div>

<ol class="org-ol">
<li><a id="org62db8df"></a>orgtrello-api/add-board<br />
<div class="outline-text-4" id="text-5-6-1">
<p>
A simple function to create a board.
We need a name and an optional description.
</p>

<div class="org-src-container">
<pre class="src src-lisp" id="org9b758cf">&#12;

<span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">#################### orgtrello-api</span>

(<span style="color: #3a81c3; font-weight: bold;">defun</span> <span style="color: #6c3163; font-weight: bold;">orgtrello-api/add-board</span> (name <span style="color: #ba2f59; font-weight: bold;">&amp;optional</span> description)
  <span style="color: #da8b55;">"Create a board"</span>
  (<span style="color: #3a81c3; font-weight: bold;">let*</span> ((payload (<span style="color: #3a81c3; font-weight: bold;">if</span> description
                      `((<span style="color: #2d9574;">"name"</span> . ,name)
                        (<span style="color: #2d9574;">"desc"</span> . ,description))
                    `((<span style="color: #2d9574;">"name"</span> . ,name)))))
    (orgtrello-hash/make-hash <span style="color: #3a81c3;">:post</span> <span style="color: #2d9574;">"/boards"</span> payload)))

</pre>
</div>
</div>
</li>

<li><a id="org18e31f9"></a>orgtrello-api/get-boards<br />
<div class="outline-text-4" id="text-5-6-2">
<p>
A function to retrieve the list of boards of the user.
</p>

<div class="org-src-container">
<pre class="src src-lisp" id="org8881589">(<span style="color: #3a81c3; font-weight: bold;">defun</span> <span style="color: #6c3163; font-weight: bold;">orgtrello-api/get-boards</span> ()
  <span style="color: #da8b55;">"Retrieve the boards of the current user."</span>
  (orgtrello-hash/make-hash <span style="color: #3a81c3;">:get</span> <span style="color: #2d9574;">"/members/me/boards"</span>))

</pre>
</div>
</div>
</li>

<li><a id="org348ad5a"></a>orgtrello-api/get-board<br />
<div class="outline-text-4" id="text-5-6-3">
<p>
A function to retrieve all the information about the board with id.
</p>

<div class="org-src-container">
<pre class="src src-lisp" id="org34f4f7e">(<span style="color: #3a81c3; font-weight: bold;">defun</span> <span style="color: #6c3163; font-weight: bold;">orgtrello-api/get-board</span> (id)
  <span style="color: #da8b55;">"Retrieve the boards of the current user."</span>
  (orgtrello-hash/make-hash <span style="color: #3a81c3;">:get</span> (format <span style="color: #2d9574;">"/boards/%s"</span> id)))

</pre>
</div>
</div>
</li>

<li><a id="org550fb8c"></a>orgtrello-api/get-cards<br />
<div class="outline-text-4" id="text-5-6-4">
<p>
Retrieve all the cards from the board with id board-id.
</p>

<div class="org-src-container">
<pre class="src src-lisp" id="org8f20628">(<span style="color: #3a81c3; font-weight: bold;">defun</span> <span style="color: #6c3163; font-weight: bold;">orgtrello-api/get-cards</span> (board-id)
  <span style="color: #da8b55;">"cards of a board"</span>
  (orgtrello-hash/make-hash <span style="color: #3a81c3;">:get</span> (format <span style="color: #2d9574;">"/boards/%s/cards"</span> board-id)))

</pre>
</div>
</div>
</li>

<li><a id="orge730613"></a>orgtrello-api/get-card<br />
<div class="outline-text-4" id="text-5-6-5">
<p>
Retrieve the information of the specific card with id card-id.
</p>

<div class="org-src-container">
<pre class="src src-lisp" id="org2e4c9b7">(<span style="color: #3a81c3; font-weight: bold;">defun</span> <span style="color: #6c3163; font-weight: bold;">orgtrello-api/get-card</span> (card-id)
  <span style="color: #da8b55;">"Detail of a card with id card-id."</span>
  (orgtrello-hash/make-hash <span style="color: #3a81c3;">:get</span> (format <span style="color: #2d9574;">"/cards/%s"</span> card-id)))

</pre>
</div>
</div>
</li>

<li><a id="orgafd676f"></a>orgtrello-api/delete-card<br />
<div class="outline-text-4" id="text-5-6-6">
<p>
Delete the card with id card-id.
</p>

<div class="org-src-container">
<pre class="src src-lisp" id="orga513274">(<span style="color: #3a81c3; font-weight: bold;">defun</span> <span style="color: #6c3163; font-weight: bold;">orgtrello-api/delete-card</span> (card-id)
  <span style="color: #da8b55;">"Delete a card with id card-id."</span>
  (orgtrello-hash/make-hash <span style="color: #3a81c3;">:delete</span> (format <span style="color: #2d9574;">"/cards/%s"</span> card-id)))

</pre>
</div>
</div>
</li>

<li><a id="orgc2224f5"></a>orgtrello-api/get-lists<br />
<div class="outline-text-4" id="text-5-6-7">
<p>
Retrieve the lists of the board with id board-id.
</p>

<div class="org-src-container">
<pre class="src src-lisp" id="org9708c52">(<span style="color: #3a81c3; font-weight: bold;">defun</span> <span style="color: #6c3163; font-weight: bold;">orgtrello-api/get-lists</span> (board-id)
  <span style="color: #da8b55;">"Display the lists of the board"</span>
  (orgtrello-hash/make-hash <span style="color: #3a81c3;">:get</span> (format <span style="color: #2d9574;">"/boards/%s/lists"</span> board-id)))

</pre>
</div>
</div>
</li>

<li><a id="orgca6660a"></a>orgtrello-api/close-list<br />
<div class="outline-text-4" id="text-5-6-8">
<p>
We need a routine to be able to close a list (typically when we create a board, we do not want the default list created by trello).
So a function to close a specific list with id list-id.
</p>

<div class="org-src-container">
<pre class="src src-lisp" id="orgd926b4d">(<span style="color: #3a81c3; font-weight: bold;">defun</span> <span style="color: #6c3163; font-weight: bold;">orgtrello-api/close-list</span> (list-id)
  <span style="color: #da8b55;">"'Close' the list with id list-id."</span>
  (orgtrello-hash/make-hash <span style="color: #3a81c3;">:put</span> (format <span style="color: #2d9574;">"/lists/%s/closed"</span> list-id) '((value . t))))

</pre>
</div>
</div>
</li>

<li><a id="orgf977f89"></a>orgtrello-api/get-list<br />
<div class="outline-text-4" id="text-5-6-9">
<p>
Retrieve the information about the list with id list-id.
</p>
<div class="org-src-container">
<pre class="src src-lisp" id="org481a03e">(<span style="color: #3a81c3; font-weight: bold;">defun</span> <span style="color: #6c3163; font-weight: bold;">orgtrello-api/get-list</span> (list-id)
  <span style="color: #da8b55;">"Get a list by id"</span>
  (orgtrello-hash/make-hash <span style="color: #3a81c3;">:get</span> (format <span style="color: #2d9574;">"/lists/%s"</span> list-id)))

</pre>
</div>
</div>
</li>

<li><a id="org04775b7"></a>orgtrello-api/add-list<br />
<div class="outline-text-4" id="text-5-6-10">
<p>
Adding a list named <i>name</i> to a board with id <i>idBoard</i>.
</p>

<div class="org-src-container">
<pre class="src src-lisp" id="orgbbb8d9a">(<span style="color: #3a81c3; font-weight: bold;">defun</span> <span style="color: #6c3163; font-weight: bold;">orgtrello-api/add-list</span> (name idBoard)
  <span style="color: #da8b55;">"Add a list - the name and the board id are mandatory (so i say!)."</span>
  (orgtrello-hash/make-hash <span style="color: #3a81c3;">:post</span> <span style="color: #2d9574;">"/lists/"</span> `((<span style="color: #2d9574;">"name"</span> . ,name) (<span style="color: #2d9574;">"idBoard"</span> . ,idBoard))))

</pre>
</div>
</div>
</li>

<li><a id="org798d676"></a>orgtrello-api/add-card<br />
<div class="outline-text-4" id="text-5-6-11">
<p>
Adding a card with name <i>name</i> to the list idList.
Optionally, we can use a due date.
</p>

<div class="org-src-container">
<pre class="src src-lisp" id="orgb3e4488">(<span style="color: #3a81c3; font-weight: bold;">defun</span> <span style="color: #6c3163; font-weight: bold;">orgtrello-api/add-card</span> (name idList <span style="color: #ba2f59; font-weight: bold;">&amp;optional</span> due)
  <span style="color: #da8b55;">"Add a card to a board"</span>
  (<span style="color: #3a81c3; font-weight: bold;">let*</span> ((orgtrello-api/add-card--default-params `((<span style="color: #2d9574;">"name"</span> . ,name) (<span style="color: #2d9574;">"idList"</span> . ,idList)))
         (orgtrello-api/add-card--params (<span style="color: #3a81c3; font-weight: bold;">if</span> due (cons `(<span style="color: #2d9574;">"due"</span> . ,due) orgtrello-api/add-card--default-params) orgtrello-api/add-card--default-params)))
    (orgtrello-hash/make-hash <span style="color: #3a81c3;">:post</span> <span style="color: #2d9574;">"/cards/"</span> orgtrello-api/add-card--params)))

</pre>
</div>
</div>
</li>

<li><a id="org00853b6"></a>orgtrello-api/get-cards-from-list<br />
<div class="outline-text-4" id="text-5-6-12">
<p>
A function to retrieve the full list of cards a list with id <i>list-id</i> owns.
</p>

<div class="org-src-container">
<pre class="src src-lisp" id="org215780b">(<span style="color: #3a81c3; font-weight: bold;">defun</span> <span style="color: #6c3163; font-weight: bold;">orgtrello-api/get-cards-from-list</span> (list-id)
  <span style="color: #da8b55;">"List all the cards"</span>
  (orgtrello-hash/make-hash <span style="color: #3a81c3;">:get</span> (format <span style="color: #2d9574;">"/lists/%s/cards"</span> list-id)))

</pre>
</div>
</div>
</li>

<li><a id="org622e282"></a>orgtrello-api/move-card<br />
<div class="outline-text-4" id="text-5-6-13">
<p>
An update function for the card card-id which belongs to the idList.
This can simply move the card from its current list to another.
Optionally, we can rename the card to <i>name</i> and update its <i>due</i> date.
</p>

<div class="org-src-container">
<pre class="src src-lisp" id="org27fd1e4">(<span style="color: #3a81c3; font-weight: bold;">defun</span> <span style="color: #6c3163; font-weight: bold;">orgtrello-api/move-card</span> (card-id idList <span style="color: #ba2f59; font-weight: bold;">&amp;optional</span> name due)
  <span style="color: #da8b55;">"Move a card to another list"</span>
  (<span style="color: #3a81c3; font-weight: bold;">let*</span> ((orgtrello-api/move-card--default-params `((<span style="color: #2d9574;">"idList"</span> . ,idList)))
         (orgtrello-api/move-card--params-name (<span style="color: #3a81c3; font-weight: bold;">if</span> name (cons `(<span style="color: #2d9574;">"name"</span> . ,name) orgtrello-api/move-card--default-params) orgtrello-api/move-card--default-params))
         (orgtrello-api/move-card--params-due  (<span style="color: #3a81c3; font-weight: bold;">if</span> due (cons `(<span style="color: #2d9574;">"due"</span> . ,due) orgtrello-api/move-card--params-name) orgtrello-api/move-card--params-name)))
    (orgtrello-hash/make-hash <span style="color: #3a81c3;">:put</span> (format <span style="color: #2d9574;">"/cards/%s"</span> card-id) orgtrello-api/move-card--params-due)))

</pre>
</div>
</div>
</li>

<li><a id="org72b40d2"></a>orgtrello-api/add-checklist<br />
<div class="outline-text-4" id="text-5-6-14">
<p>
We can add a checklist entitled <i>name</i> to the card with id <i>card-id</i>.
</p>

<div class="org-src-container">
<pre class="src src-lisp" id="org0693ec0">(<span style="color: #3a81c3; font-weight: bold;">defun</span> <span style="color: #6c3163; font-weight: bold;">orgtrello-api/add-checklist</span> (card-id name)
  <span style="color: #da8b55;">"Add a checklist to a card"</span>
  (orgtrello-hash/make-hash <span style="color: #3a81c3;">:post</span>
             (format <span style="color: #2d9574;">"/cards/%s/checklists"</span> card-id)
             `((<span style="color: #2d9574;">"name"</span> . ,name))))

</pre>
</div>
</div>
</li>

<li><a id="org690ad07"></a>orgtrello-api/update-checklist<br />
<div class="outline-text-4" id="text-5-6-15">
<p>
Also, we can update the checklist with id <i>checklist-id</i> to a new name <i>name</i>.
</p>

<div class="org-src-container">
<pre class="src src-lisp" id="org1223a2c">(<span style="color: #3a81c3; font-weight: bold;">defun</span> <span style="color: #6c3163; font-weight: bold;">orgtrello-api/update-checklist</span> (checklist-id name)
  <span style="color: #da8b55;">"Update the checklist's name"</span>
  (orgtrello-hash/make-hash <span style="color: #3a81c3;">:put</span>
             (format <span style="color: #2d9574;">"/checklists/%s"</span> checklist-id)
             `((<span style="color: #2d9574;">"name"</span> . ,name))))

</pre>
</div>
</div>
</li>

<li><a id="orgd65da2f"></a>orgtrello-api/get-checklists<br />
<div class="outline-text-4" id="text-5-6-16">
<p>
Retrieve the list of checklist from the card with id <i>card-id</i>.
</p>

<div class="org-src-container">
<pre class="src src-lisp" id="orgc06762c">(<span style="color: #3a81c3; font-weight: bold;">defun</span> <span style="color: #6c3163; font-weight: bold;">orgtrello-api/get-checklists</span> (card-id)
  <span style="color: #da8b55;">"List the checklists of a card"</span>
  (orgtrello-hash/make-hash <span style="color: #3a81c3;">:get</span> (format <span style="color: #2d9574;">"/cards/%s/checklists"</span> card-id)))

</pre>
</div>
</div>
</li>

<li><a id="orgadb6bae"></a>orgtrello-api/get-checklist<br />
<div class="outline-text-4" id="text-5-6-17">
<p>
Or simply retrieve the detail about the checklist with id <i>checklist-id</i>.
</p>

<div class="org-src-container">
<pre class="src src-lisp" id="org50805c5">(<span style="color: #3a81c3; font-weight: bold;">defun</span> <span style="color: #6c3163; font-weight: bold;">orgtrello-api/get-checklist</span> (checklist-id)
  <span style="color: #da8b55;">"Retrieve all the information from a checklist"</span>
  (orgtrello-hash/make-hash <span style="color: #3a81c3;">:get</span> (format <span style="color: #2d9574;">"/checklists/%s"</span> checklist-id)))

</pre>
</div>
</div>
</li>

<li><a id="org561f8a2"></a>orgtrello-api/delete-checklist<br />
<div class="outline-text-4" id="text-5-6-18">
<p>
We need to be able to remove checklist <i>checklist-id</i>.
</p>

<div class="org-src-container">
<pre class="src src-lisp" id="org4a86e3b">(<span style="color: #3a81c3; font-weight: bold;">defun</span> <span style="color: #6c3163; font-weight: bold;">orgtrello-api/delete-checklist</span> (checklist-id)
  <span style="color: #da8b55;">"Delete a checklist with checklist-id"</span>
  (orgtrello-hash/make-hash <span style="color: #3a81c3;">:delete</span> (format <span style="color: #2d9574;">"/checklists/%s"</span> checklist-id)))

</pre>
</div>
</div>
</li>

<li><a id="org5cf589b"></a>orgtrello-api/add-tasks<br />
<div class="outline-text-4" id="text-5-6-19">
<p>
Adding a task/item entitled <i>name</i> to the checklist <i>checklist-id</i> with an optional <i>checked</i> state.
</p>

<div class="org-src-container">
<pre class="src src-lisp" id="org5249c9f">(<span style="color: #3a81c3; font-weight: bold;">defun</span> <span style="color: #6c3163; font-weight: bold;">orgtrello-api/add-tasks</span> (checklist-id name <span style="color: #ba2f59; font-weight: bold;">&amp;optional</span> checked)
  <span style="color: #da8b55;">"Add todo tasks (trello items) to a checklist with id 'id'"</span>
  (<span style="color: #3a81c3; font-weight: bold;">let*</span> ((payload (<span style="color: #3a81c3; font-weight: bold;">if</span> checked
                      `((<span style="color: #2d9574;">"name"</span>  . ,name) (<span style="color: #2d9574;">"checked"</span> . ,checked))
                    `((<span style="color: #2d9574;">"name"</span> . ,name)))))
    (orgtrello-hash/make-hash <span style="color: #3a81c3;">:post</span> (format <span style="color: #2d9574;">"/checklists/%s/checkItems"</span> checklist-id) payload)))

</pre>
</div>
</div>
</li>

<li><a id="org221b46f"></a>orgtrello-api/update-task<br />
<div class="outline-text-4" id="text-5-6-20">
<p>
A function to deal with the update of the task/item with id <i>task-id</i> and name <i>name</i> from the checklist <i>checklist-id</i> (trello api forces the <i>card</i>-id too).
Optionally, we can change its checked <i>state</i>.
</p>

<div class="org-src-container">
<pre class="src src-lisp" id="orgb391155">(<span style="color: #3a81c3; font-weight: bold;">defun</span> <span style="color: #6c3163; font-weight: bold;">orgtrello-api/update-task</span> (card-id checklist-id task-id name <span style="color: #ba2f59; font-weight: bold;">&amp;optional</span> state)
  <span style="color: #da8b55;">"Update a task"</span>
  (<span style="color: #3a81c3; font-weight: bold;">let*</span> ((payload (<span style="color: #3a81c3; font-weight: bold;">if</span> state
                      `((<span style="color: #2d9574;">"name"</span>  . ,name) (<span style="color: #2d9574;">"state"</span> . ,state))
                    `((<span style="color: #2d9574;">"name"</span> . ,name)))))
    (orgtrello-hash/make-hash
     <span style="color: #3a81c3;">:put</span>
     (format <span style="color: #2d9574;">"/cards/%s/checklist/%s/checkItem/%s"</span> card-id checklist-id task-id)
     payload)))

</pre>
</div>
</div>
</li>

<li><a id="org00fc456"></a>orgtrello-api/get-tasks<br />
<div class="outline-text-4" id="text-5-6-21">
<p>
Retrieve the list of tasks from the checklist <i>checklist-id</i>.
</p>

<div class="org-src-container">
<pre class="src src-lisp" id="org7329c4a">(<span style="color: #3a81c3; font-weight: bold;">defun</span> <span style="color: #6c3163; font-weight: bold;">orgtrello-api/get-tasks</span> (checklist-id)
  <span style="color: #da8b55;">"List the checklist items."</span>
    (orgtrello-hash/make-hash <span style="color: #3a81c3;">:get</span> (format <span style="color: #2d9574;">"/checklists/%s/checkItems/"</span> checklist-id)))

</pre>
</div>
</div>
</li>

<li><a id="orgd891700"></a>orgtrello-api/delete-task<br />
<div class="outline-text-4" id="text-5-6-22">
<p>
To keep the symmetry with the other entities, we need to be able to destroy the task/item <i>task-id</i> from the checklist <i>checklist-id</i>.
</p>

<div class="org-src-container">
<pre class="src src-lisp" id="org59dbd1b">(<span style="color: #3a81c3; font-weight: bold;">defun</span> <span style="color: #6c3163; font-weight: bold;">orgtrello-api/delete-task</span> (checklist-id task-id)
  <span style="color: #da8b55;">"Delete a task with id task-id"</span>
  (orgtrello-hash/make-hash <span style="color: #3a81c3;">:delete</span> (format <span style="color: #2d9574;">"/checklists/%s/checkItems/%s"</span> checklist-id task-id)))

(message <span style="color: #2d9574;">"org-trello - orgtrello-api loaded!"</span>)

</pre>
</div>
</div>
</li>
</ol>
</div>
<div id="outline-container-org13d2115" class="outline-3">
<h3 id="org13d2115"><span class="section-number-3">5.7</span> orgtrello-data</h3>
<div class="outline-text-3" id="text-5-7">
<p>
Namespace in charge of manipulating/extracting the org buffer's data.
</p>
</div>

<ol class="org-ol">
<li><a id="orgdbd427f"></a>orgtrello-data/&#x2013;convert-orgmode-date-to-trello-date<br />
<div class="outline-text-4" id="text-5-7-1">
<p>
A simple function to help in transforming the org format used in deadline into trello format.
This is really basic.
We must improve this.
</p>

<div class="org-src-container">
<pre class="src src-lisp" id="orgc0e1af2">&#12;

<span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">#################### orgtrello-data</span>

(<span style="color: #3a81c3; font-weight: bold;">defvar</span> <span style="color: #715ab1;">*ORGTRELLO-ID*</span> <span style="color: #2d9574;">"orgtrello-id"</span> <span style="color: #da8b55;">"Marker used for the trello identifier"</span>)

(<span style="color: #3a81c3; font-weight: bold;">defun</span> <span style="color: #6c3163; font-weight: bold;">orgtrello-data/--convert-orgmode-date-to-trello-date</span> (orgmode-date)
  <span style="color: #da8b55;">"Convert the org-mode deadline into a time adapted for trello."</span>
  (<span style="color: #3a81c3; font-weight: bold;">if</span> (and orgmode-date (not (string-match-p <span style="color: #2d9574;">"T*Z"</span> orgmode-date)))
      (cl-destructuring-bind (sec min hour day mon year dow dst tz)
                             (--map (<span style="color: #3a81c3; font-weight: bold;">if</span> it
                                        (<span style="color: #3a81c3; font-weight: bold;">if</span> (&lt; it 10)
                                            (concat <span style="color: #2d9574;">"0"</span> (int-to-string it))
                                          (int-to-string it)))
                                    (parse-time-string orgmode-date))
                             (<span style="color: #3a81c3; font-weight: bold;">let*</span> ((year-mon-day (concat year <span style="color: #2d9574;">"-"</span> mon <span style="color: #2d9574;">"-"</span> day <span style="color: #2d9574;">"T"</span>))
                                    (hour-min-sec (<span style="color: #3a81c3; font-weight: bold;">if</span> hour (concat hour <span style="color: #2d9574;">":"</span> min <span style="color: #2d9574;">":"</span> sec) <span style="color: #2d9574;">"00:00:00"</span>)))
                               (concat year-mon-day hour-min-sec <span style="color: #2d9574;">".000Z"</span>)))
    orgmode-date))

</pre>
</div>
</div>
</li>

<li><a id="org2d1da13"></a>orgtrello-data/metadata<br />
<div class="outline-text-4" id="text-5-7-2">
<p>
This is an important routine which will extract all the informations from the org buffer for a given entity (typically the entity under the caret's current position):
</p>
<ul class="org-ul">
<li>level</li>
<li>label</li>
<li>id</li>
<li>due</li>
</ul>
<p>
This uses org's api and add some extra information specific to org-trello.
</p>

<div class="org-src-container">
<pre class="src src-lisp" id="org942a7ca">(<span style="color: #3a81c3; font-weight: bold;">defun</span> <span style="color: #6c3163; font-weight: bold;">orgtrello-data/metadata</span> ()
  <span style="color: #da8b55;">"Compute the metadata from the org-heading-components entry, add the identifier and extract the metadata needed."</span>
  (<span style="color: #3a81c3; font-weight: bold;">let*</span> ((orgtrello-data/metadata--id       (org-entry-get (point) *ORGTRELLO-ID*))
         (orgtrello-data/metadata--due      (orgtrello-data/--convert-orgmode-date-to-trello-date (org-entry-get (point) <span style="color: #2d9574;">"DEADLINE"</span>)))
         (orgtrello-data/metadata--metadata (org-heading-components)))
    (-&gt;&gt; orgtrello-data/metadata--metadata
         (cons orgtrello-data/metadata--due)
         (cons orgtrello-data/metadata--id)
         orgtrello-data/--get-metadata)))

</pre>
</div>
</div>
</li>

<li><a id="org519abf0"></a>orgtrello-data/&#x2013;parent-metadata<br />
<div class="outline-text-4" id="text-5-7-3">
<p>
This function permits to retrieve the metadata of the current entry.
Note that if we are to the upper level already, this will return the exact same data as the current entry.
</p>

<div class="org-src-container">
<pre class="src src-lisp" id="org4134379">(<span style="color: #3a81c3; font-weight: bold;">defun</span> <span style="color: #6c3163; font-weight: bold;">orgtrello-data/--parent-metadata</span> ()
  <span style="color: #da8b55;">"Extract the metadata from the current heading's parent."</span>
  (save-excursion
    (org-up-heading-safe)
    (orgtrello-data/metadata)))

</pre>
</div>
</div>
</li>

<li><a id="orgf1438ee"></a>orgtrello-data/&#x2013;grandparent-metadata<br />
<div class="outline-text-4" id="text-5-7-4">
<p>
Again, from a current entry, return the metadata of the grand-parent entry.
Note again that if we are to the upper level, the same data as the current entry will be returned.
</p>

<div class="org-src-container">
<pre class="src src-lisp" id="org21487c7">(<span style="color: #3a81c3; font-weight: bold;">defun</span> <span style="color: #6c3163; font-weight: bold;">orgtrello-data/--grandparent-metadata</span> ()
  <span style="color: #da8b55;">"Extract the metadata from the current heading's grandparent."</span>
  (save-excursion
    (org-up-heading-safe)
    (org-up-heading-safe)
    (orgtrello-data/metadata)))

</pre>
</div>
</div>
</li>

<li><a id="org104baae"></a>orgtrello-data/entry-get-full-metadata<br />
<div class="outline-text-4" id="text-5-7-5">
<p>
This is an orchestration from the previous functions.
This will return a map with as key:
</p>
<ul class="org-ul">
<li>:current     the current entity under the caret's position</li>
<li>:parent      the current entity's parent</li>
<li>:grandparent the current entity's grandparent</li>
</ul>

<p>
If the level of the current entity exceeds level 4, the entry is dismissed (only 3 levels can be compatible in trello) so the function will return nil.
</p>

<div class="org-src-container">
<pre class="src src-lisp" id="org497fe8e">(<span style="color: #3a81c3; font-weight: bold;">defun</span> <span style="color: #6c3163; font-weight: bold;">orgtrello-data/entry-get-full-metadata</span> ()
  <span style="color: #da8b55;">"Compute the metadata needed for one entry into a map with keys :current, :parent, :grandparent.</span>
<span style="color: #da8b55;">   Returns nil if the level is superior to 4."</span>
  (<span style="color: #3a81c3; font-weight: bold;">let*</span> ((heading (orgtrello-data/metadata))
         (level   (gethash <span style="color: #3a81c3;">:level</span> heading)))
    (<span style="color: #3a81c3; font-weight: bold;">if</span> (&lt; level 4)
        (<span style="color: #3a81c3; font-weight: bold;">let*</span> ((parent-heading      (orgtrello-data/--parent-metadata))
               (grandparent-heading (orgtrello-data/--grandparent-metadata))
               (mapdata (make-hash-table <span style="color: #3a81c3;">:test</span> 'equal)))
          <span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">build the metadata with every important pieces</span>
          (puthash <span style="color: #3a81c3;">:current</span>     heading             mapdata)
          (puthash <span style="color: #3a81c3;">:parent</span>      parent-heading      mapdata)
          (puthash <span style="color: #3a81c3;">:grandparent</span> grandparent-heading mapdata)
          mapdata))))

</pre>
</div>
</div>
</li>

<li><a id="org41ee8a5"></a>orgtrello-data/&#x2013;get-metadata<br />
<div class="outline-text-4" id="text-5-7-6">
<p>
An adapter function to transform any org data into org-trello data.
</p>

<div class="org-src-container">
<pre class="src src-lisp" id="orgadfb18b">(<span style="color: #3a81c3; font-weight: bold;">defun</span> <span style="color: #6c3163; font-weight: bold;">orgtrello-data/--get-metadata</span> (heading-metadata)
  <span style="color: #da8b55;">"Given the heading-metadata returned by the function 'org-heading-components, make it a hashmap with key :level, :keyword, :title. and their respective value"</span>
  (cl-destructuring-bind (id due level _ keyword _ title <span style="color: #ba2f59; font-weight: bold;">&amp;rest</span>) heading-metadata
                         (orgtrello-hash/make-hash-org level keyword title id due)))

(message <span style="color: #2d9574;">"org-trello - orgtrello-data loaded!"</span>)

</pre>
</div>
</div>
</li>
</ol>
</div>

<div id="outline-container-org0ee72f9" class="outline-3">
<h3 id="org0ee72f9"><span class="section-number-3">5.8</span> orgtrello-hash</h3>
<div class="outline-text-3" id="text-5-8">
<p>
Utility namespace in charge of simplifying the construction of org-trello data.
</p>
</div>

<ol class="org-ol">
<li><a id="org82fe278"></a>orgtrello-hash/make-hash-org<br />
<div class="outline-text-4" id="text-5-8-1">
<p>
A simple factory function to create a map from the needed org entity data.
</p>
<div class="org-src-container">
<pre class="src src-lisp" id="org9626ba0">&#12;

<span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">#################### orgtrello-hash</span>

(<span style="color: #3a81c3; font-weight: bold;">defun</span> <span style="color: #6c3163; font-weight: bold;">orgtrello-hash/make-hash-org</span> (level keyword title id due)
  <span style="color: #da8b55;">"Utility function to ease the creation of the orgtrello-metadata"</span>
  (<span style="color: #3a81c3; font-weight: bold;">let</span> ((h (make-hash-table <span style="color: #3a81c3;">:test</span> 'equal)))
    (puthash <span style="color: #3a81c3;">:level</span>   level   h)
    (puthash <span style="color: #3a81c3;">:keyword</span> keyword h)
    (puthash <span style="color: #3a81c3;">:title</span>   title   h)
    (puthash <span style="color: #3a81c3;">:id</span>      id      h)
    (puthash <span style="color: #3a81c3;">:due</span>     due     h)
    h))

</pre>
</div>
</div>
</li>

<li><a id="orge2dd8be"></a>orgtrello-hash/make-hash<br />
<div class="outline-text-4" id="text-5-8-2">
<p>
A simple utility function to help in creating the http request map to feed to the orgtrello-query namespace.
</p>

<div class="org-src-container">
<pre class="src src-lisp" id="org9559173">(<span style="color: #3a81c3; font-weight: bold;">defun</span> <span style="color: #6c3163; font-weight: bold;">orgtrello-hash/make-hash</span> (method uri <span style="color: #ba2f59; font-weight: bold;">&amp;optional</span> params)
  <span style="color: #da8b55;">"Utility function to ease the creation of the map - wait, where are my clojure data again!?"</span>
  (<span style="color: #3a81c3; font-weight: bold;">let</span> ((h (make-hash-table <span style="color: #3a81c3;">:test</span> 'equal)))
    (puthash <span style="color: #3a81c3;">:method</span> method h)
    (puthash <span style="color: #3a81c3;">:uri</span>    uri    h)
    (<span style="color: #3a81c3; font-weight: bold;">if</span> params (puthash <span style="color: #3a81c3;">:params</span> params h))
    h))

(message <span style="color: #2d9574;">"org-trello - orgtrello-hash loaded!"</span>)

</pre>
</div>
</div>
</li>
</ol>
</div>
</div>

<div id="outline-container-orge2a8add" class="outline-2">
<h2 id="orge2a8add"><span class="section-number-2">6</span> Resulting</h2>
<div class="outline-text-2" id="text-6">
<p>
Now let's generate the full code.
</p>
</div>
</div>

<div id="outline-container-org1436e0e" class="outline-2">
<h2 id="org1436e0e"><span class="section-number-2">7</span> Source</h2>
<div class="outline-text-2" id="text-7">
<p>
Project: <a href="http://ardumont.github.io/org-trello/">http://ardumont.github.io/org-trello/</a>
source: <a href="https://github.com/org-trello/org-trello/blob/master/org-trello.org">org-trello.org</a>
</p>
</div>
</div>
